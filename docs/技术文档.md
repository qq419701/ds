# 电商订单管理系统技术文档

## 系统概述

本系统是一个面向京东电商的订单管理中间件，支持：
- **游戏点卡平台**（直充订单 / 卡密订单）
- **通用交易平台**（充值订单 / 卡密订单）
- **阿奇索开放平台**（第三方自动发货）

系统接收京东下单推送，完成发货后回调通知京东，并支持自动/手动两种发货模式。

---

## 目录

1. [系统架构](#1-系统架构)
2. [游戏点卡平台接口](#2-游戏点卡平台接口)
3. [通用交易平台接口](#3-通用交易平台接口)
4. [阿奇索开放平台接口](#4-阿奇索开放平台接口)
5. [发货模式说明](#5-发货模式说明)
6. [店铺配置说明](#6-店铺配置说明)
7. [常见问题排查](#7-常见问题排查)
8. [数据库字段说明](#8-数据库字段说明)

---

## 1. 系统架构

```
京东平台
  │ POST 推单
  ▼
接单接口（/api/game/* 或 /api/general/*）
  │ 验签 → 创建订单 → 返回接收成功
  ▼
订单管理
  ├── 手动模式：运营人员在后台操作
  │     ├── 直充：点击"通知成功" → 回调京东
  │     ├── 卡密：输入卡密 → 点击"发卡密" → 回调京东
  │     └── 退款：点击"通知退款" → 回调京东
  └── 自动模式
        ├── 假发货（auto_deliver=1，agiso未启用）
        └── 阿奇索自动发货（agiso_enabled=1）
              └── 阿奇索推送 → /api/agiso/push → 回调京东
```

---

## 2. 游戏点卡平台接口

### 2.1 接口地址

| 接口 | URL | 说明 |
|------|-----|------|
| 直充接单 | `POST /api/game/direct` | 接收直充订单 |
| 直充查询 | `POST /api/game/query` | 查询直充订单状态 |
| 卡密接单 | `POST /api/game/card` | 接收卡密订单 |
| 卡密查询 | `POST /api/game/card-query` | 查询卡密订单（含卡密数据） |

### 2.2 接单请求格式

京东以 `application/x-www-form-urlencoded` 格式 POST 数据：

| 字段 | 说明 |
|------|------|
| `customerId` | 客户ID（用于识别店铺） |
| `timestamp` | 时间戳（yyyyMMddHHmmss） |
| `data` | Base64编码的业务JSON（UTF-8字符集） |
| `sign` | MD5签名 |

**data 字段解码后的业务JSON示例（直充）：**
```json
{
  "orderId": "京东订单号",
  "buyNum": "1",
  "totalPrice": "150.00",
  "gameAccount": "游戏账号",
  "permit": "",
  "skuId": "101689202",
  "brandId": "1010000055"
}
```

### 2.3 签名算法

签名明文格式：
```
key1=value1&key2=value2&...{privatekey}
```

规则：
1. 所有参数（除 `sign` 外）按参数名 ASCII 升序排列
2. 拼接为 `key=value` 格式，用 `&` 连接
3. **末尾直接追加私钥**（不加 `&key=`）
4. 对拼接字符串做 MD5 摘要（小写 32 位）

**示例（私钥 = `mySecret`）：**
```
customerId=CUS001&data=base64data&timestamp=20260101120000mySecret
```

### 2.4 接单响应格式

```json
{"retCode": "100", "retMessage": "接收成功"}
```

- `retCode=100`：接收成功
- `retCode=200`：接收失败（京东会重试）

### 2.5 查询响应格式

```json
{
  "retCode": "100",
  "retMessage": "查询成功",
  "data": "base64编码的JSON"
}
```

**data 解码后（直充）：**
```json
{"orderStatus": 0}
```

**data 解码后（卡密，已完成时）：**
```json
{
  "orderStatus": 1,
  "cardInfos": [{"cardNo": "卡号", "cardPass": "卡密"}]
}
```

`orderStatus` 取值：
- `0` = 充值中（处理中）
- `1` = 充值成功
- `2` = 充值失败

### 2.6 回调京东（发货通知）

| 场景 | 回调URL | 说明 |
|------|---------|------|
| 直充成功 | `game_api_url` 或 `game_direct_callback_url` | 充值成功通知 |
| 卡密发货 | `game_api_url` 或 `game_card_callback_url` | 发卡密通知 |
| 退款/失败 | 上述任一 URL | `orderStatus=2` |

**回调参数（POST form-urlencoded）：**

| 字段 | 说明 |
|------|------|
| `customerId` | 店铺配置的客户ID |
| `timestamp` | 时间戳（yyyyMMddHHmmss） |
| `data` | Base64编码的业务JSON |
| `sign` | MD5签名 |

**data 字段业务JSON：**
```json
// 直充成功
{"orderId": "京东订单号", "orderStatus": "0"}

// 卡密发货
{
  "orderId": "京东订单号",
  "orderStatus": "0",
  "cardInfos": [{"cardNo": "卡号", "cardPass": "卡密"}]
}

// 退款/失败
{
  "orderId": "京东订单号",
  "orderStatus": "2",
  "failedCode": 999,
  "failedReason": "商家退款"
}
```

⚠️ **注意**：
- 卡密字段名是 `cardPass`（不是 `cardPwd`）
- 卡密数组字段名是 `cardInfos`（不是 `cards`）
- `orderStatus` 在接单时是数字，回调时是字符串 `"0"` 或 `"2"`

### 2.7 回调响应

京东返回：`{"retCode": "100", "retMessage": "success"}`

---

## 3. 通用交易平台接口

### 3.1 接口地址

| 接口 | URL | 说明 |
|------|-----|------|
| 接单 | `POST /api/general/distill` | 接收通用交易订单（表单格式） |
| 反查 | `POST /api/general/query` | 查询订单状态 |

### 3.2 接单请求格式

京东以 `application/x-www-form-urlencoded` 格式 POST 数据：

| 字段 | 类型 | 说明 |
|------|------|------|
| `jdOrderNo` | Long | 京东订单号 |
| `vendorId` | Long | 商家ID（通过此字段识别店铺） |
| `wareNo` | String | 商品编码 |
| `quantity` | Int | 数量 |
| `totalPrice` | Long | 订单总价格（单位分） |
| `payTime` | String | 支付时间（yyyyMMddHHmmss） |
| `notifyUrl` | String | 回调通知地址 |
| `produceAccount` | String | 充值账号（直充类型） |
| `sign` | String | MD5签名 |
| `signType` | String | 签名方式（MD5） |
| `timestamp` | String | 时间戳（yyyyMMddHHmmss） |

### 3.3 签名算法

签名明文格式：
```
key1value1key2value2...PRIVATEKEY
```

规则：
1. 所有参数（除 `sign`、`signType` 外）按字母升序排列
2. **直接拼接 key+value**（无 `=`、无 `&`）
3. 末尾追加私钥

**示例（私钥 = `mySecret`）：**
```
agentOrderNoORD001jdOrderNoJD001vendorIdV001mySecret
```

### 3.4 接单响应格式

```json
{
  "jdOrderNo": "京东订单号",
  "agentOrderNo": "我方订单号",
  "produceStatus": 3,
  "code": "JDO_201",
  "signType": "MD5",
  "timestamp": "20260101120000",
  "sign": "md5签名"
}
```

`produceStatus` 取值：
- `1` = 生产成功（同步发货时使用）
- `2` = 生产失败（触发退款）
- `3` = 生产中（异步，等待回调或查询）

`code` 错误码：
- `JDO_200` = 成功
- `JDO_201` = 生产中
- `JDO_302` = 没有对应商品
- `JDO_303` = 参数错误
- `JDO_304` = 验签失败
- `JDO_500` = 系统错误

### 3.5 回调京东（发货通知）

- **URL**：接单时 `notifyUrl` + `/produce/result`
- **方法**：POST，`application/x-www-form-urlencoded`

**参数：**

| 字段 | 说明 |
|------|------|
| `vendorId` | 商家ID |
| `jdOrderNo` | 京东订单号 |
| `agentOrderNo` | 我方订单号 |
| `produceStatus` | 1=成功，2=失败（退款） |
| `quantity` | 数量 |
| `product` | 卡密信息（AES加密后的JSON，卡密订单时传） |
| `timestamp` | 时间戳 |
| `signType` | MD5 |
| `sign` | 签名 |

**product 字段（解密后的JSON）：**
```json
[
  {
    "cardNumber": "卡号",
    "password": "卡密",
    "expiryDate": "2099-12-31"
  }
]
```

**回调响应：**
```json
{"code": "0", "message": "成功"}
```

---

## 4. 阿奇索开放平台接口

参考文档：https://open.agiso.com/document/#/aldsJd/guide

### 4.1 认证方式

```
HTTP Header: Authorization: Bearer {access_token}
HTTP Header: ApiVersion: 1
```

### 4.2 签名算法

```
MD5(AppSecret + key1value1key2value2... + AppSecret)
```

规则：
- 所有参数（包括 `timestamp`，除 `sign`）按 ASCII 升序排列
- 拼接为 key+value 格式（无 `=`、无 `&`）
- **前后各加 AppSecret**，再做 MD5

### 4.3 公共参数（每次请求必须包含）

| 字段 | 说明 |
|------|------|
| `appId` | 开发者应用 ID |
| `timestamp` | Unix 时间戳（秒） |
| `sign` | 签名 |

### 4.4 主要接口

| 场景 | URL |
|------|-----|
| 游戏点卡直充发货 | `POST https://gw-api.agiso.com/aldsJd/GameCard/RechargeSend` |
| 游戏点卡发卡 | `POST https://gw-api.agiso.com/aldsJd/GameCard/CardSend` |
| 通用交易发货 | `POST https://gw-api.agiso.com/aldsJd/Vtp/Send` |
| 通用交易退款 | `POST https://gw-api.agiso.com/aldsJd/Vtp/Refund` |
| 查询余额 | `POST https://gw-api.agiso.com/open/Bankroll/QueryDeposit` |

### 4.5 阿奇索推送接收

推送 URL：`POST /api/agiso/push`（在阿奇索后台配置）

**Query 参数：** `timestamp`、`sign`、`aopic`（推送类型）
**Form 参数：** `json`（推送消息 JSON）

**推送类型（aopic）：**
- `1` = 买家付款成功
- `2` = 自动发货完成
- `8` = 游戏点卡订单支付成功
- `16` = 通用交易订单支付成功

**推送签名验证：**
```
MD5(AppSecret + json{json内容} + timestamp{时间戳} + AppSecret)
```

---

## 5. 发货模式说明

### 5.1 手动模式（默认）

运营人员在后台手动操作：
- **直充订单**：点击"通知成功"→ 系统回调京东标记充值成功
- **卡密订单**：填入卡密 → 点击"发卡密"→ 系统回调京东（含卡密）
- **退款**：点击"通知退款"→ 系统回调京东标记退款

### 5.2 自动发货（假发货）

当店铺 `auto_deliver=1` 且**未启用阿奇索**时，接单即自动处理：
- **直充订单**：直接回调京东标记充值成功
- **卡密订单**：自动生成随机卡号卡密，回调京东

适用场景：联调测试、虚拟发货场景。

### 5.3 阿奇索自动发货

当店铺 `agiso_enabled=1` 时，通过阿奇索平台进行真实充值/发卡：
1. 接到订单后调用阿奇索对应接口
2. 阿奇索完成后推送通知到 `/api/agiso/push`
3. 系统收到推送后更新订单状态，并回调京东

---

## 6. 店铺配置说明

### 6.1 游戏点卡配置

| 字段 | 说明 |
|------|------|
| `game_customer_id` | 客户 ID（京东分配，用于识别店铺） |
| `game_md5_secret` | MD5 签名密钥（京东分配） |
| `game_api_url` | 通用回调 URL（优先使用） |
| `game_direct_callback_url` | 直充专用回调 URL |
| `game_card_callback_url` | 卡密专用回调 URL |

### 6.2 通用交易配置

| 字段 | 说明 |
|------|------|
| `general_vendor_id` | 商家 ID（vendorId，京东分配） |
| `general_md5_secret` | MD5 签名密钥 |
| `general_aes_secret` | AES 加密密钥（32字节，用于加密卡密） |
| `general_callback_url` | 默认回调 URL（实际优先用订单中的 notifyUrl） |

### 6.3 阿奇索配置

| 字段 | 说明 |
|------|------|
| `agiso_enabled` | 是否启用（0/1） |
| `agiso_app_id` | 开发者 AppID |
| `agiso_app_secret` | 开发者 AppSecret |
| `agiso_access_token` | 商家授权 AccessToken |
| `agiso_host` | 自定义 API 主机（留空使用官方 gw-api.agiso.com） |
| `agiso_port` | 自定义端口（留空使用 443） |

---

## 7. 常见问题排查

### Q1：京东订单密码显示为空

**原因**：回调时卡密字段名错误

**排查**：
- 检查回调 data 中是否使用 `cardInfos`（不是 `cards`）
- 检查卡密字段是否使用 `cardPass`（不是 `cardPwd`）

### Q2：退款回调失败 `[104]参数错误`

**原因**：退款回调参数格式不符合文档

**排查**：
- 游戏点卡：确认 `data=base64({"orderStatus":"2",...})` 格式
- 通用交易：确认 `produceStatus=2`（不是 `status=REFUND`）

### Q3：签名验证失败

**原因**：签名算法实现不正确

**排查**：
- 游戏点卡：末尾直接追加私钥（`...私钥`，不是 `...&key=私钥`）
- 通用交易：无 `=` 无 `&`，直接 `key1value1key2value2...私钥`
- 阿奇索：`私钥key1value1...私钥`（前后各加私钥）

### Q4：阿奇索 AccessToken 失效

**处理**：
1. 商家重新在授权页面获取新的 AccessToken
2. 更新店铺配置中的 AccessToken

### Q5：通用交易找不到店铺

**原因**：京东发送的 `vendorId` 与店铺配置的 `general_vendor_id` 不匹配

**排查**：
- 确认店铺配置的"通用交易商家ID"与京东分配的 `vendorId` 一致
- 检查日志中接收到的 `vendorId` 参数值

---

## 8. 数据库字段说明

### orders 表

| 字段 | 说明 |
|------|------|
| `order_status` | 0=待处理 1=处理中 2=已完成 3=已取消 4=已退款 |
| `order_type` | 1=直充 2=卡密 |
| `shop_type` | 1=游戏点卡 2=通用交易 |
| `notify_url` | 接单时京东下发的回调地址（通用交易） |
| `notify_status` | 0=未回调 1=成功 2=失败 |
| `card_info` | 卡密数据 JSON（卡密订单） |

### shops 表

| 字段 | 说明 |
|------|------|
| `shop_type` | 1=游戏点卡 2=通用交易 |
| `auto_deliver` | 0=手动发货 1=自动发货 |
| `agiso_enabled` | 0=不启用阿奇索 1=启用阿奇索 |
| `is_enabled` | 0=禁用 1=启用 |
