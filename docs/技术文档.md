# DS 订单管理系统技术文档

## 1. 系统概述

DS 订单管理系统是一个面向京东开放平台供应商的订单中间件系统，支持游戏点卡（直充/卡密）和通用交易两大业务场景，并集成了阿奇索开放平台进行自动发货。

### 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        京东开放平台                           │
│        游戏点卡接口          通用交易接口                      │
└──────────────┬───────────────────────┬──────────────────────┘
               │                       │
               ▼                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    DS 订单管理系统 (Flask)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │  game 路由   │  │ general 路由 │  │   admin 路由     │  │
│  │ /api/game/*  │  │/api/general/*│  │  /orders, /login │  │
│  └──────┬───────┘  └──────┬───────┘  └──────────────────┘  │
│         │                 │                                   │
│  ┌──────▼─────────────────▼──────────────────────────────┐  │
│  │              Services 业务逻辑层                        │  │
│  │  game_service  general_service  callback_service       │  │
│  └──────────────────────────┬──────────────────────────────┘  │
│                             │                                   │
│  ┌──────────────────────────▼──────────────────────────────┐  │
│  │              Models 数据层 (MySQL)                       │  │
│  │           shops 表          orders 表                   │  │
│  └─────────────────────────────────────────────────────────┘  │
└──────────────────────────────┬──────────────────────────────┘
                               │
                               ▼
              ┌────────────────────────────┐
              │      阿奇索开放平台         │
              │  /aldsJd/GameCard/*        │
              │  /aldsJd/Vtp/*             │
              └────────────────────────────┘
```

---

## 2. 游戏点卡平台接口详细说明

### 2.1 直充接单接口

- **URL**: `POST /api/game/direct`
- **Content-Type**: `application/json` 或 `application/x-www-form-urlencoded`

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| customerId | String | 是 | 商家编号 |
| timestamp | String | 是 | 时间戳 yyyyMMddHHmmss |
| data | String | 是 | Base64 编码的订单数据 |
| sign | String | 是 | MD5签名 |

**data 字段解码后 JSON 结构**:

```json
{
  "orderId": "JD订单号",
  "gameAccount": "游戏账号",
  "skuId": "商品ID",
  "brandId": "品牌ID",
  "buyNum": 1,
  "totalPrice": 100.00
}
```

**响应示例**:

```json
{"retCode": "100", "retMessage": "成功"}
```

### 2.2 直充查询接口

- **URL**: `POST /api/game/query`

**data 字段**:
```json
{"orderId": "JD订单号"}
```

**响应 data 字段**:
```json
{"orderStatus": 0}
```
> orderStatus: 0=成功, 1=处理中

### 2.3 卡密接单接口

- **URL**: `POST /api/game/card`

**data 字段**:
```json
{
  "orderId": "JD订单号",
  "skuId": "商品ID",
  "brandId": "品牌ID",
  "buyNum": 2,
  "totalPrice": 200.00
}
```

**响应**（有卡密时）:
```json
{
  "retCode": "100",
  "retMessage": "成功",
  "data": "Base64({"cardinfos":[{"cardNo":"xxx","cardPass":"xxx"}]})"
}
```

### 2.4 卡密查询接口

- **URL**: `POST /api/game/card-query`

**响应 data 字段**（成功时）:
```json
{
  "orderStatus": "0",
  "cardinfos": [{"cardNo": "xxx", "cardPass": "xxx"}]
}
```

### 2.5 游戏点卡回调格式

系统主动向京东发起回调，POST JSON 数据到配置的回调URL。

**直充成功回调**:
```json
{
  "customerId": "商家编号",
  "timestamp": "20240101120000",
  "data": "Base64({\"orderId\":\"xxx\",\"orderStatus\":\"0\"})",
  "sign": "md5签名"
}
```

**卡密成功回调**:
```json
{
  "customerId": "商家编号",
  "timestamp": "20240101120000",
  "data": "Base64({\"orderId\":\"xxx\",\"orderStatus\":\"0\",\"cardInfos\":[{\"cardNo\":\"xxx\",\"cardPass\":\"xxx\"}]})",
  "sign": "md5签名"
}
```

**退款回调**:
```json
{
  "data": "Base64({\"orderId\":\"xxx\",\"orderStatus\":\"2\",\"failedCode\":999,\"failedReason\":\"商家退款\"})"
}
```

---

## 3. 通用交易平台接口详细说明

### 3.1 接单接口

- **URL**: `POST /api/general/distill`
- **Content-Type**: `application/x-www-form-urlencoded`

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| vendorId | String | 是 | 商家ID |
| jdOrderNo | String | 是 | 京东订单号 |
| produceAccount | String | 是 | 充值账号 |
| quantity | Integer | 是 | 数量 |
| wareNo | String | 是 | 商品编号 |
| totalPrice | Long | 是 | 总金额（分） |
| notifyUrl | String | 否 | 回调URL |
| signType | String | 是 | 签名类型，固定MD5 |
| sign | String | 是 | MD5签名 |
| timestamp | String | 是 | 时间戳 |

**响应示例**:
```json
{
  "jdOrderNo": 123456789,
  "agentOrderNo": "AGENT20240101001",
  "produceStatus": 3,
  "code": "JDO_201",
  "signType": "MD5",
  "timestamp": "20240101120000",
  "sign": "md5签名"
}
```

> produceStatus: 1=成功, 2=失败, 3=处理中, 4=异常

### 3.2 反查接口

- **URL**: `POST /api/general/query`

**响应格式同接单接口**，produceStatus 根据实际订单状态返回。

### 3.3 通用交易回调格式

系统向 `notifyUrl + /produce/result` 发送 POST 表单。

**成功回调**:
```
vendorId=xxx&jdOrderNo=xxx&agentOrderNo=xxx&produceStatus=1&quantity=1&timestamp=xxx&signType=MD5&sign=xxx
```

**退款回调**: `produceStatus=2`

---

## 4. 阿奇索开放平台接口说明

### 4.1 推送通知接收

- **URL**: `POST /api/agiso/push`
- **URL参数**: `timestamp`, `sign`, `aopic`, `fromPlatform`
- **表单参数**: `json`（JSON字符串）

**aopic 类型说明**:

| aopic值 | 含义 |
|---------|------|
| 8 | 游戏点卡订单支付成功 |
| 2 | 自动发货完成（含卡密数据） |
| 16 | 通用交易订单支付成功 |

**aopic=2 推送数据示例（卡密）**:
```json
{
  "appId": "xxx",
  "tid": "订单号",
  "cardList": [
    {"cardno": "卡号", "cardpass": "卡密"}
  ]
}
```

### 4.2 阿奇索主动调用接口

| 功能 | URL |
|------|-----|
| 游戏点卡直充发货 | POST /aldsJd/GameCard/RechargeSend |
| 游戏点卡发卡密 | POST /aldsJd/GameCard/CardSend |
| 通用交易发货 | POST /aldsJd/Vtp/Send |
| 游戏点卡退款 | POST /aldsJd/GameCard/Refund |
| 通用交易退款 | POST /aldsJd/Vtp/Refund |

**请求头**:
```
Authorization: Bearer {access_token}
ApiVersion: 1
Content-Type: application/json
```

---

## 5. 发货模式说明

系统支持三种发货模式，优先级依次为：

```
阿奇索模式 > 假发货模式 > 手动发货
```

| 模式 | 配置 | 说明 |
|------|------|------|
| 阿奇索自动发货 | agiso_enabled=1 | 接单后自动调用阿奇索API发货，等待阿奇索推送结果后回调京东 |
| 假发货模式 | auto_deliver=1 | 接单后立即生成假数据（直充）或随机卡密回调京东，用于测试 |
| 手动发货 | 两者均为0 | 在后台管理界面手动操作发货/退款 |

---

## 6. 签名算法说明

### 6.1 三种签名算法对比

| 平台 | 算法 | 排序 | 分隔符 | 追加 | 排除字段 |
|------|------|------|--------|------|---------|
| 游戏点卡 | MD5 | ASCII升序 | key=value&... | 末尾追加私钥（无&） | sign |
| 通用交易 | MD5 | ASCII升序 | keyvalue... | 末尾追加私钥 | sign, signType |
| 阿奇索 | MD5 | ASCII升序 | keyvalue... | 首尾各追加AppSecret | sign |

### 6.2 游戏点卡签名示例

```
参数: customerId=001, timestamp=20240101, data=xxx
排序后: customerId=001&data=xxx&timestamp=20240101
追加私钥: customerId=001&data=xxx&timestamp=20240101PRIVATEKEY
签名: MD5(上述字符串)
```

### 6.3 通用交易签名示例

```
参数: vendorId=001, jdOrderNo=123, timestamp=20240101
排序后: jdOrderNo123timestamp20240101vendorId001
追加私钥: jdOrderNo123timestamp20240101vendorId001PRIVATEKEY
签名: MD5(上述字符串)
```

### 6.4 阿奇索签名示例

```
参数: appId=001, timestamp=1700000000, tid=xxx
排序后: appId001tidxxxtimestamp1700000000
拼接: APPSECRET + appId001tidxxxtimestamp1700000000 + APPSECRET
签名: MD5(上述字符串)
```

---

## 7. 数据库字段说明

### 7.1 shops 表（店铺配置）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键 |
| name | VARCHAR(100) | 店铺名称 |
| game_customer_id | VARCHAR(50) | 游戏点卡商家编号 |
| game_md5_secret | VARCHAR(100) | 游戏点卡MD5私钥 |
| game_api_url | VARCHAR(200) | 游戏点卡通用回调URL |
| game_direct_callback_url | VARCHAR(200) | 直充专用回调URL |
| game_card_callback_url | VARCHAR(200) | 卡密专用回调URL |
| general_vendor_id | VARCHAR(50) | 通用交易商家ID |
| general_md5_secret | VARCHAR(100) | 通用交易MD5私钥 |
| general_aes_secret | VARCHAR(100) | 卡密AES加密密钥 |
| general_callback_url | VARCHAR(200) | 通用交易默认回调URL |
| agiso_enabled | INT | 是否启用阿奇索(0/1) |
| agiso_app_id | VARCHAR(50) | 阿奇索AppId |
| agiso_app_secret | VARCHAR(100) | 阿奇索AppSecret |
| agiso_access_token | VARCHAR(200) | 阿奇索AccessToken |
| auto_deliver | INT | 假发货模式(0/1) |
| default_address | TEXT | 默认地址JSON |

### 7.2 orders 表（订单记录）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键 |
| order_id | VARCHAR(50) | 京东订单号（唯一） |
| shop_id | INT | 关联店铺ID |
| shop_type | INT | 1=游戏点卡 2=通用交易 |
| order_type | INT | 1=直充 2=卡密 |
| order_status | INT | 0=待处理 1=处理中 2=已完成 3=已取消 4=已退款 |
| notify_url | VARCHAR(200) | 通用交易回调地址 |
| notify_status | INT | 0=未回调 1=成功 2=失败 |
| card_info | TEXT | 卡密JSON数组 |
| game_account | VARCHAR(100) | 游戏充值账号 |
| jd_order_no | VARCHAR(50) | 京东订单号（通用交易） |
| agent_order_no | VARCHAR(50) | 商家侧订单号 |
| produce_account | VARCHAR(100) | 通用交易充值账号 |
| raw_data | TEXT | 原始请求数据 |
