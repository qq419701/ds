# äº¬ä¸œè®¢å•ç®¡ç†ç³»ç»Ÿ - å®å¡”é¢æ¿éƒ¨ç½²æ•™ç¨‹

## ðŸ“‹ ç›®å½•

1. [ç³»ç»Ÿç®€ä»‹](#ç³»ç»Ÿç®€ä»‹)
2. [åŠŸèƒ½è¯´æ˜Ž](#åŠŸèƒ½è¯´æ˜Ž)
3. [çŽ¯å¢ƒè¦æ±‚](#çŽ¯å¢ƒè¦æ±‚)
4. [å®å¡”é¢æ¿å®‰è£…](#å®å¡”é¢æ¿å®‰è£…)
5. [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
6. [é…ç½®è¯´æ˜Ž](#é…ç½®è¯´æ˜Ž)
7. [Nginxåå‘ä»£ç†é…ç½®](#nginxåå‘ä»£ç†é…ç½®)
8. [Supervisorè¿›ç¨‹å®ˆæŠ¤](#supervisorè¿›ç¨‹å®ˆæŠ¤)
9. [ç³»ç»Ÿä½¿ç”¨è¯´æ˜Ž](#ç³»ç»Ÿä½¿ç”¨è¯´æ˜Ž)
10. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ç³»ç»Ÿç®€ä»‹

æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ªäº¬ä¸œè®¢å•ç®¡ç†å¹³å°ï¼Œæ”¯æŒå¯¹æŽ¥ä»¥ä¸‹ä¸‰ä¸ªå¹³å°æŽ¥å£ï¼š

| å¹³å° | è¯´æ˜Ž | æŽ¥å£åŠŸèƒ½ |
|------|------|----------|
| **äº¬ä¸œæ¸¸æˆç‚¹å¡å¹³å°** | ç®¡ç†æ¸¸æˆç‚¹å¡ç±»è®¢å• | MD5ç­¾åéªŒè¯ã€è®¢å•æŽ¥æ”¶ã€ç›´å……å›žè°ƒã€å¡å¯†å›žè°ƒã€é€€æ¬¾å›žè°ƒ |
| **äº¬ä¸œé€šç”¨äº¤æ˜“å¹³å°** | ç®¡ç†é€šç”¨äº¤æ˜“ç±»è®¢å• | MD5ç­¾åéªŒè¯ã€è®¢å•æŽ¥æ”¶ã€å……å€¼å›žè°ƒã€å¡å¯†å›žè°ƒã€é€€æ¬¾å›žè°ƒ |
| **é˜¿å¥‡ç´¢å¼€æ”¾å¹³å°** | è‡ªåŠ¨å‘è´§æœåŠ¡ | ç­¾åè®¤è¯ã€è‡ªåŠ¨å‘è´§ã€è®¢å•çŠ¶æ€æŸ¥è¯¢ |

---

## åŠŸèƒ½è¯´æ˜Ž

### ðŸª åº—é“ºç®¡ç†ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
- **æ–°å»º/ç¼–è¾‘/åˆ é™¤åº—é“º**ï¼šæ”¯æŒæ¸¸æˆç‚¹å¡å’Œé€šç”¨äº¤æ˜“ä¸¤ç§ç±»åž‹
- **æŽ¥å£é…ç½®**ï¼šé…ç½®äº¬ä¸œå¹³å°çš„å®¢æˆ·IDã€å¯†é’¥ã€å›žè°ƒåœ°å€ç­‰
- **é˜¿å¥‡ç´¢é…ç½®**ï¼šé…ç½®é˜¿å¥‡ç´¢å¼€æ”¾å¹³å°çš„åº”ç”¨IDã€å¯†é’¥ã€è®¿é—®ä»¤ç‰Œ
- **é€šçŸ¥é…ç½®**ï¼šé…ç½®é’‰é’‰/ä¼ä¸šå¾®ä¿¡æœºå™¨äººWebhookï¼Œæ–°è®¢å•è‡ªåŠ¨æŽ¨é€é€šçŸ¥

### ðŸ“¦ è®¢å•ç®¡ç†
- **è®¢å•åˆ—è¡¨**ï¼šæŒ‰åº—é“ºã€ç±»åž‹ã€çŠ¶æ€ã€æ—¶é—´èŒƒå›´ã€äº¬ä¸œè®¢å•å·ç­›é€‰
- **ç›´å……å‘è´§**ï¼šç‚¹å‡»"é€šçŸ¥æˆåŠŸ"å®Œæˆç›´å……è®¢å•ï¼Œè‡ªåŠ¨å›žè°ƒäº¬ä¸œå¹³å°
- **å¡å¯†å‘è´§**ï¼šè¾“å…¥å¡å·å¯†ç å®Œæˆå¡å¯†è®¢å•ï¼Œè‡ªåŠ¨å›žè°ƒäº¬ä¸œå¹³å°ä¼ é€’å¡å¯†ä¿¡æ¯
- **é˜¿å¥‡ç´¢å‘è´§**ï¼šä¸€é”®è°ƒç”¨é˜¿å¥‡ç´¢å¼€æ”¾å¹³å°æŽ¥å£è‡ªåŠ¨å‘è´§
- **é€€æ¬¾æ“ä½œ**ï¼šé€šçŸ¥é€€æ¬¾å¹¶è‡ªåŠ¨å›žè°ƒäº¬ä¸œå¹³å°
- **è‡ªåŠ©è”è°ƒ**ï¼šç›´æŽ¥ä¿®æ”¹è®¢å•çŠ¶æ€ï¼ˆä¸è§¦å‘äº¬ä¸œå›žè°ƒï¼‰ï¼Œä»…ç”¨äºŽè”è°ƒæµ‹è¯•

### ðŸ“Š ç»Ÿè®¡æŠ¥è¡¨ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
- æ€»è®¢å•æ•°ã€æ€»é‡‘é¢ã€å·²å®Œæˆã€å¾…å¤„ç†ç»Ÿè®¡
- æŒ‰åº—é“ºç»Ÿè®¡è®¢å•æ•°å’Œé‡‘é¢
- è¿‘7å¤©è®¢å•è¶‹åŠ¿

### ðŸ‘¥ ç”¨æˆ·ç®¡ç†ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
- **ç®¡ç†å‘˜**ï¼šå¯ç®¡ç†æ‰€æœ‰åº—é“ºã€è®¢å•ã€ç”¨æˆ·ã€æŸ¥çœ‹ç»Ÿè®¡å’Œé€šçŸ¥æ—¥å¿—
- **æ“ä½œå‘˜**ï¼šä»…èƒ½æŸ¥çœ‹æŽˆæƒåº—é“ºçš„è®¢å•ï¼Œå¯æ“ä½œå‘è´§/é€€æ¬¾ï¼ˆæŒ‰æƒé™é…ç½®ï¼‰
- æ”¯æŒä¸ºæ“ä½œå‘˜åˆ†é…åº—é“ºæƒé™å’ŒåŠŸèƒ½æƒé™ï¼ˆæŸ¥çœ‹è®¢å•ã€å‘è´§ã€é€€æ¬¾ï¼‰

### ðŸ”” é€šçŸ¥ç³»ç»Ÿ
- **é’‰é’‰é€šçŸ¥**ï¼šé€šè¿‡é’‰é’‰æœºå™¨äººWebhookæŽ¨é€æ–°è®¢å•é€šçŸ¥ï¼Œæ”¯æŒåŠ ç­¾éªŒè¯
- **ä¼ä¸šå¾®ä¿¡é€šçŸ¥**ï¼šé€šè¿‡ä¼ä¸šå¾®ä¿¡æœºå™¨äººWebhookæŽ¨é€æ–°è®¢å•é€šçŸ¥
- **é€šçŸ¥é‡è¯•**ï¼šå‘é€å¤±è´¥è‡ªåŠ¨é‡è¯•3æ¬¡ï¼ˆé—´éš”1ç§’ã€3ç§’ã€5ç§’ï¼‰
- **é€šçŸ¥æ—¥å¿—**ï¼šæŸ¥çœ‹æ‰€æœ‰é€šçŸ¥å‘é€è®°å½•ï¼Œæ”¯æŒæ‰‹åŠ¨é‡å‘å¤±è´¥é€šçŸ¥

### ðŸ”Œ æŽ¥å£å¯¹æŽ¥è¯´æ˜Ž

#### äº¬ä¸œæ¸¸æˆç‚¹å¡å¹³å°
- **ç­¾åéªŒè¯**ï¼šæŽ¥æ”¶äº¬ä¸œè®¢å•æ—¶ï¼Œä½¿ç”¨MD5ç­¾åéªŒè¯è¯·æ±‚åˆæ³•æ€§
- **ç­¾åè§„åˆ™**ï¼šå‚æ•°æŒ‰ASCIIå‡åºæŽ’åˆ—ï¼Œæ‹¼æŽ¥`key1=value1&key2=value2&...&key=å¯†é’¥`ï¼ŒMD5æ‘˜è¦
- **ç›´å……å›žè°ƒ**ï¼šå……å€¼æˆåŠŸåŽè‡ªåŠ¨POSTé€šçŸ¥äº¬ä¸œå¹³å°ï¼ŒåŒ…å«ç­¾å
- **å¡å¯†å›žè°ƒ**ï¼šå¡å¯†å‘è´§åŽè‡ªåŠ¨POSTå¡å¯†ä¿¡æ¯åˆ°äº¬ä¸œå¹³å°ï¼ŒåŒ…å«ç­¾å
- **é€€æ¬¾å›žè°ƒ**ï¼šé€€æ¬¾æ“ä½œåŽè‡ªåŠ¨POSTé€šçŸ¥äº¬ä¸œå¹³å°

#### äº¬ä¸œé€šç”¨äº¤æ˜“å¹³å°
- **ç­¾åéªŒè¯**ï¼šä¸Žæ¸¸æˆç‚¹å¡å¹³å°ç›¸åŒçš„MD5ç­¾åéªŒè¯è§„åˆ™
- **å›žè°ƒé€šçŸ¥**ï¼šå……å€¼æˆåŠŸ/å¡å¯†å‘è´§/é€€æ¬¾æ—¶è‡ªåŠ¨å›žè°ƒäº¬ä¸œé€šç”¨äº¤æ˜“å¹³å°
- **AESåŠ å¯†**ï¼šæ”¯æŒé…ç½®AESå¯†é’¥ï¼ˆæŒ‰äº¬ä¸œé€šç”¨äº¤æ˜“å¹³å°æ–‡æ¡£è¦æ±‚ï¼‰

#### é˜¿å¥‡ç´¢å¼€æ”¾å¹³å°
- **è®¤è¯æ–¹å¼**ï¼šHTTPå¤´éƒ¨æºå¸¦`Authorization: Bearer {access_token}`å’Œ`ApiVersion: 1`
- **ç­¾åç®—æ³•**ï¼šå‚æ•°æŒ‰ASCIIæŽ’åºæ‹¼æŽ¥ï¼Œå‰åŽåŠ AppSecretï¼ŒMD5æ‘˜è¦
- **è‡ªåŠ¨å‘è´§**ï¼šè°ƒç”¨é˜¿å¥‡ç´¢æŽ¥å£è‡ªåŠ¨å®Œæˆè®¢å•å‘è´§
- **è®¢å•æŸ¥è¯¢**ï¼šæŸ¥è¯¢é˜¿å¥‡ç´¢å¹³å°ä¸Šçš„è®¢å•çŠ¶æ€

---

## çŽ¯å¢ƒè¦æ±‚

| é¡¹ç›® | è¦æ±‚ |
|------|------|
| æ“ä½œç³»ç»Ÿ | CentOS 7/8ã€Ubuntu 18.04/20.04/22.04ã€Debian 10/11 |
| å®å¡”é¢æ¿ | 8.0 æˆ–æ›´é«˜ç‰ˆæœ¬ |
| Python | 3.9 æˆ–æ›´é«˜ç‰ˆæœ¬ |
| MySQL | 5.7 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆæŽ¨è 8.0ï¼‰ |
| å†…å­˜ | æœ€ä½Ž 1GBï¼ŒæŽ¨è 2GB |
| ç¡¬ç›˜ | æœ€ä½Ž 10GB å¯ç”¨ç©ºé—´ |

---

## å®å¡”é¢æ¿å®‰è£…

å¦‚æžœæœåŠ¡å™¨å°šæœªå®‰è£…å®å¡”é¢æ¿ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

### CentOS
```bash
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec
```

### Ubuntu/Debian
```bash
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec
```

å®‰è£…å®ŒæˆåŽï¼Œè®°å½•ç»ˆç«¯æ˜¾ç¤ºçš„é¢æ¿åœ°å€ã€ç”¨æˆ·åå’Œå¯†ç ã€‚

---

## éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…è¿è¡ŒçŽ¯å¢ƒ

1. ç™»å½•å®å¡”é¢æ¿
2. è¿›å…¥ **è½¯ä»¶å•†åº—**
3. å®‰è£…ä»¥ä¸‹è½¯ä»¶ï¼š
   - âœ… **Nginx**ï¼ˆæŽ¨èæœ€æ–°ç¨³å®šç‰ˆï¼‰
   - âœ… **MySQL 8.0**ï¼ˆæˆ– 5.7ï¼‰
   - âœ… **Pythoné¡¹ç›®ç®¡ç†å™¨**ï¼ˆå®å¡”æ’ä»¶ï¼‰
   - âœ… **Supervisorç®¡ç†å™¨**ï¼ˆå®å¡”æ’ä»¶ï¼‰

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºMySQLæ•°æ®åº“

1. åœ¨å®å¡”é¢æ¿å·¦ä¾§èœå•ç‚¹å‡» **æ•°æ®åº“**
2. ç‚¹å‡» **æ·»åŠ æ•°æ®åº“**
3. å¡«å†™ä¿¡æ¯ï¼š
   - æ•°æ®åº“åï¼š`dianshang`
   - ç”¨æˆ·åï¼š`dianshang`
   - å¯†ç ï¼šè®¾ç½®ä¸€ä¸ªå®‰å…¨çš„å¯†ç ï¼ˆè®°ä½è¿™ä¸ªå¯†ç ï¼‰
   - è®¿é—®æƒé™ï¼šæœ¬åœ°æœåŠ¡å™¨
   - å­—ç¬¦é›†ï¼š`utf8mb4`
4. ç‚¹å‡» **æäº¤**

### ç¬¬ä¸‰æ­¥ï¼šä¸Šä¼ é¡¹ç›®ä»£ç 

**æ–¹æ³•ä¸€ï¼šé€šè¿‡Gitæ‹‰å–**

1. é€šè¿‡å®å¡”é¢æ¿çš„ **ç»ˆç«¯** æˆ–SSHè¿žæŽ¥æœåŠ¡å™¨
2. æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /www/wwwroot/ds
cd /www/wwwroot/ds

# æ‹‰å–ä»£ç 
git clone https://github.com/qq419701/ds.git .
```

**æ–¹æ³•äºŒï¼šæ‰‹åŠ¨ä¸Šä¼ **

1. åœ¨å®å¡”é¢æ¿å·¦ä¾§èœå•ç‚¹å‡» **æ–‡ä»¶**
2. è¿›å…¥ `/www/wwwroot/` ç›®å½•
3. åˆ›å»º `dianshang` æ–‡ä»¶å¤¹
4. å°†æ‰€æœ‰é¡¹ç›®æ–‡ä»¶ä¸Šä¼ åˆ°è¯¥æ–‡ä»¶å¤¹ä¸­

### ç¬¬å››æ­¥ï¼šå®‰è£…Pythonä¾èµ–

é€šè¿‡å®å¡”é¢æ¿ **ç»ˆç«¯** æ‰§è¡Œï¼š

```bash
cd /www/wwwroot/ds

# åˆ›å»ºPythonè™šæ‹ŸçŽ¯å¢ƒ
python3 -m venv venv

# æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒ
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å®‰è£…gunicornï¼ˆç”Ÿäº§çŽ¯å¢ƒWSGIæœåŠ¡å™¨ï¼‰
pip install gunicorn
```

### ç¬¬äº”æ­¥ï¼šé…ç½®çŽ¯å¢ƒå˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
cd /www/wwwroot/ds
```

åœ¨å®å¡”é¢æ¿ **æ–‡ä»¶ç®¡ç†** ä¸­åˆ›å»º `.env` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ini
# æ•°æ®åº“é…ç½®ï¼ˆä¿®æ”¹ä¸ºç¬¬äºŒæ­¥åˆ›å»ºçš„æ•°æ®åº“ä¿¡æ¯ï¼‰
DATABASE_URL=mysql+pymysql://dianshang:ä½ çš„æ•°æ®åº“å¯†ç @localhost:3306/dianshang?charset=utf8mb4

# åº”ç”¨å¯†é’¥ï¼ˆè¯·ä¿®æ”¹ä¸ºéšæœºå­—ç¬¦ä¸²ï¼‰
SECRET_KEY=è¯·ä¿®æ”¹ä¸ºä¸€ä¸ªéšæœºçš„é•¿å­—ç¬¦ä¸²ä¾‹å¦‚abc123def456ghi789

# Flaské…ç½®
FLASK_DEBUG=0
```

> âš ï¸ **é‡è¦å®‰å…¨æç¤º**ï¼š
> - `SECRET_KEY` å¿…é¡»ä¿®æ”¹ä¸ºéšæœºå­—ç¬¦ä¸²ï¼Œä¸è¦ä½¿ç”¨é»˜è®¤å€¼
> - æ•°æ®åº“å¯†ç ä¸­å¦‚åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œéœ€è¦è¿›è¡ŒURLç¼–ç 

### ç¬¬å…­æ­¥ï¼šåˆå§‹åŒ–æ•°æ®åº“

```bash
cd /www/wwwroot/ds
source venv/bin/activate

# åˆå§‹åŒ–æ•°æ®åº“è¡¨å’Œé»˜è®¤ç®¡ç†å‘˜è´¦å·
python migrations/init_db.py
```

æˆåŠŸåŽä¼šæ˜¾ç¤ºï¼š
```
Default admin user created: admin / admin123
Database initialized successfully
```

> âš ï¸ **é¦–æ¬¡ç™»å½•åŽè¯·ç«‹å³ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç ï¼**

### ç¬¬ä¸ƒæ­¥ï¼šæµ‹è¯•è¿è¡Œ

```bash
cd /www/wwwroot/ds
source venv/bin/activate

# æµ‹è¯•å¯åŠ¨åº”ç”¨
gunicorn -w 2 -b 127.0.0.1:5000 run:app
```

æ‰“å¼€æµè§ˆå™¨è®¿é—® `http://æœåŠ¡å™¨IP:5000`ï¼Œç¡®è®¤èƒ½çœ‹åˆ°ç™»å½•é¡µé¢åŽï¼ŒæŒ‰ `Ctrl+C` åœæ­¢æµ‹è¯•ã€‚

---

## é…ç½®è¯´æ˜Ž

### é…ç½®æ–‡ä»¶è¯´æ˜Žï¼ˆconfig.pyï¼‰

| é…ç½®é¡¹ | è¯´æ˜Ž | é»˜è®¤å€¼ |
|--------|------|--------|
| `SECRET_KEY` | Flaskåº”ç”¨å¯†é’¥ï¼Œç”¨äºŽä¼šè¯åŠ å¯† | é€šè¿‡çŽ¯å¢ƒå˜é‡è®¾ç½® |
| `DATABASE_URL` | æ•°æ®åº“è¿žæŽ¥åœ°å€ | é€šè¿‡çŽ¯å¢ƒå˜é‡è®¾ç½® |
| `SQLALCHEMY_TRACK_MODIFICATIONS` | SQLAlchemyä¿®æ”¹è·Ÿè¸ª | False |

### çŽ¯å¢ƒå˜é‡è¯´æ˜Ž

| å˜é‡å | è¯´æ˜Ž | å¿…å¡« |
|--------|------|------|
| `DATABASE_URL` | MySQLæ•°æ®åº“è¿žæŽ¥åœ°å€ | âœ… æ˜¯ |
| `SECRET_KEY` | Flaskåº”ç”¨å¯†é’¥ | âœ… æ˜¯ |
| `FLASK_DEBUG` | è°ƒè¯•æ¨¡å¼ï¼Œç”Ÿäº§çŽ¯å¢ƒå¿…é¡»è®¾ä¸º0 | å¦ï¼ˆé»˜è®¤0ï¼‰ |

---

## Nginxåå‘ä»£ç†é…ç½®

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç½‘ç«™

1. åœ¨å®å¡”é¢æ¿å·¦ä¾§èœå•ç‚¹å‡» **ç½‘ç«™**
2. ç‚¹å‡» **æ·»åŠ ç«™ç‚¹**
3. å¡«å†™ä¿¡æ¯ï¼š
   - åŸŸåï¼šå¡«å†™ä½ çš„åŸŸåï¼ˆå¦‚ `order.example.com`ï¼‰ï¼Œæ²¡æœ‰åŸŸåå¡«æœåŠ¡å™¨IP
   - æ ¹ç›®å½•ï¼š`/www/wwwroot/ds`
   - PHPç‰ˆæœ¬ï¼šé€‰æ‹© **çº¯é™æ€**
   - æ•°æ®åº“ï¼šä¸åˆ›å»ºï¼ˆå·²åœ¨ç¬¬äºŒæ­¥åˆ›å»ºï¼‰
4. ç‚¹å‡» **æäº¤**

### ç¬¬äºŒæ­¥ï¼šé…ç½®åå‘ä»£ç†

1. ç‚¹å‡»ç½‘ç«™åç§°è¿›å…¥ç½‘ç«™è®¾ç½®
2. ç‚¹å‡» **åå‘ä»£ç†**
3. ç‚¹å‡» **æ·»åŠ åå‘ä»£ç†**
4. å¡«å†™ä¿¡æ¯ï¼š
   - ä»£ç†åç§°ï¼š`dianshang`
   - ç›®æ ‡URLï¼š`http://127.0.0.1:5000`
   - å‘é€åŸŸåï¼š`$host`
5. ç‚¹å‡» **ç¡®è®¤**

### ç¬¬ä¸‰æ­¥ï¼ˆå¯é€‰ï¼‰ï¼šæ‰‹åŠ¨é…ç½®Nginx

å¦‚æžœéœ€è¦æ›´ç²¾ç»†çš„é…ç½®ï¼Œåœ¨ç½‘ç«™è®¾ç½®ä¸­ç‚¹å‡» **é…ç½®æ–‡ä»¶**ï¼Œå‚è€ƒä»¥ä¸‹é…ç½®ï¼š

```nginx
server {
    listen 80;
    server_name order.example.com;  # æ›¿æ¢ä¸ºä½ çš„åŸŸå

    # é™æ€æ–‡ä»¶ç›´æŽ¥ç”±Nginxæä¾›
    location /static/ {
        alias /www/wwwroot/ds/app/static/;
        expires 30d;
        access_log off;
    }

    # åå‘ä»£ç†åˆ°Flaskåº”ç”¨
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60;
        proxy_read_timeout 120;
        proxy_send_timeout 60;
    }

    # é™åˆ¶ä¸Šä¼ æ–‡ä»¶å¤§å°
    client_max_body_size 10m;

    # è®¿é—®æ—¥å¿—
    access_log /www/wwwlogs/dianshang.log;
    error_log /www/wwwlogs/dianshang.error.log;
}
```

### ç¬¬å››æ­¥ï¼ˆæŽ¨èï¼‰ï¼šé…ç½®SSLè¯ä¹¦

1. åœ¨ç½‘ç«™è®¾ç½®ä¸­ç‚¹å‡» **SSL**
2. é€‰æ‹© **Let's Encrypt** å…è´¹è¯ä¹¦
3. å‹¾é€‰ä½ çš„åŸŸå
4. ç‚¹å‡» **ç”³è¯·** å¹¶å¼€å¯ **å¼ºåˆ¶HTTPS**

---

## Supervisorè¿›ç¨‹å®ˆæŠ¤

ä½¿ç”¨Supervisorç¡®ä¿åº”ç”¨åœ¨åŽå°æŒç»­è¿è¡Œå¹¶è‡ªåŠ¨é‡å¯ã€‚

### æ–¹æ³•ä¸€ï¼šé€šè¿‡å®å¡”Supervisorç®¡ç†å™¨

1. åœ¨å®å¡”é¢æ¿å·¦ä¾§ç‚¹å‡» **è½¯ä»¶å•†åº—**
2. æ‰¾åˆ° **Supervisorç®¡ç†å™¨**ï¼Œç‚¹å‡» **è®¾ç½®**
3. ç‚¹å‡» **æ·»åŠ å®ˆæŠ¤è¿›ç¨‹**
4. å¡«å†™ä¿¡æ¯ï¼š
   - åç§°ï¼š`dianshang`
   - è¿è¡Œç›®å½•ï¼š`/www/wwwroot/ds`
   - å¯åŠ¨å‘½ä»¤ï¼š`/www/wwwroot/ds/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 --timeout 120 --access-logfile /www/wwwlogs/dianshang_access.log --error-logfile /www/wwwlogs/dianshang_error.log run:app`
   - å¯åŠ¨ç”¨æˆ·ï¼š`www`
5. ç‚¹å‡» **ç¡®è®¤**

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨é…ç½®Supervisor

åœ¨å®å¡” **ç»ˆç«¯** ä¸­æ‰§è¡Œï¼š

```bash
# åˆ›å»ºSupervisoré…ç½®æ–‡ä»¶
cat > /etc/supervisor/conf.d/dianshang.conf << 'EOF'
[program:dianshang]
directory=/www/wwwroot/ds
command=/www/wwwroot/ds/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 --timeout 120 --access-logfile /www/wwwlogs/dianshang_access.log --error-logfile /www/wwwlogs/dianshang_error.log run:app
user=www
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/www/wwwlogs/dianshang_supervisor.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
environment=DATABASE_URL="mysql+pymysql://dianshang:ä½ çš„æ•°æ®åº“å¯†ç @localhost:3306/dianshang?charset=utf8mb4",SECRET_KEY="ä½ çš„å¯†é’¥",FLASK_DEBUG="0"
EOF

# é‡æ–°åŠ è½½Supervisoré…ç½®
supervisorctl reread
supervisorctl update
supervisorctl start dianshang
```

### Supervisorå¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹çŠ¶æ€
supervisorctl status

# å¯åŠ¨åº”ç”¨
supervisorctl start dianshang

# åœæ­¢åº”ç”¨
supervisorctl stop dianshang

# é‡å¯åº”ç”¨
supervisorctl restart dianshang

# æŸ¥çœ‹æ—¥å¿—
tail -f /www/wwwlogs/dianshang_error.log
```

---

## ç³»ç»Ÿä½¿ç”¨è¯´æ˜Ž

### é¦–æ¬¡ç™»å½•

1. æ‰“å¼€æµè§ˆå™¨è®¿é—®ä½ çš„åŸŸåæˆ–æœåŠ¡å™¨IP
2. ä½¿ç”¨é»˜è®¤è´¦å·ç™»å½•ï¼š
   - ç”¨æˆ·åï¼š`admin`
   - å¯†ç ï¼š`admin123`
3. **ç«‹å³ä¿®æ”¹å¯†ç **ï¼ˆåœ¨ç”¨æˆ·ç®¡ç†ä¸­ç¼–è¾‘ç®¡ç†å‘˜è´¦å·ï¼‰

### ç®¡ç†å‘˜æ“ä½œæµç¨‹

#### 1. é…ç½®åº—é“º

1. ç‚¹å‡» **ðŸª åº—é“ºç®¡ç†** â†’ **æ–°å»ºåº—é“º**
2. å¡«å†™åŸºæœ¬ä¿¡æ¯ï¼ˆåº—é“ºåç§°ã€ä»£ç ã€ç±»åž‹ï¼‰
3. æ ¹æ®åº—é“ºç±»åž‹å¡«å†™æŽ¥å£é…ç½®ï¼š

**æ¸¸æˆç‚¹å¡åº—é“ºï¼š**
- å®¢æˆ·IDï¼šäº¬ä¸œåˆ†é…çš„æ¸¸æˆç‚¹å¡å®¢æˆ·ID
- MD5å¯†é’¥ï¼šç”¨äºŽç­¾åéªŒè¯çš„å¯†é’¥
- ç›´å……å›žè°ƒåœ°å€ï¼šäº¬ä¸œæä¾›çš„ç›´å……æˆåŠŸå›žè°ƒURL
- å¡å¯†å›žè°ƒåœ°å€ï¼šäº¬ä¸œæä¾›çš„å¡å¯†å‘è´§å›žè°ƒURL
- æŽ¥å£åœ°å€ï¼šäº¬ä¸œæ¸¸æˆç‚¹å¡å¹³å°APIåœ°å€

**é€šç”¨äº¤æ˜“åº—é“ºï¼š**
- å•†å®¶IDï¼šäº¬ä¸œåˆ†é…çš„é€šç”¨äº¤æ˜“å•†å®¶ID
- MD5å¯†é’¥ï¼šç”¨äºŽç­¾åéªŒè¯çš„å¯†é’¥
- AESå¯†é’¥ï¼šç”¨äºŽæ•°æ®åŠ å¯†çš„å¯†é’¥
- å›žè°ƒåœ°å€ï¼šäº¬ä¸œæä¾›çš„é€šç”¨äº¤æ˜“å›žè°ƒURL
- æŽ¥å£åœ°å€ï¼šäº¬ä¸œé€šç”¨äº¤æ˜“å¹³å°APIåœ°å€

4. å¦‚éœ€ä½¿ç”¨é˜¿å¥‡ç´¢è‡ªåŠ¨å‘è´§ï¼Œé…ç½®é˜¿å¥‡ç´¢å‚æ•°ï¼š
   - å¯ç”¨é˜¿å¥‡ç´¢
   - å¡«å†™ä¸»æœºåœ°å€ã€ç«¯å£
   - å¡«å†™åº”ç”¨IDã€åº”ç”¨å¯†é’¥ã€è®¿é—®ä»¤ç‰Œ

5. å¦‚éœ€è®¢å•é€šçŸ¥ï¼Œé…ç½®é€šçŸ¥å‚æ•°ï¼š
   - å¯ç”¨è®¢å•é€šçŸ¥
   - å¡«å†™é’‰é’‰Webhookåœ°å€å’ŒåŠ ç­¾å¯†é’¥
   - æˆ–å¡«å†™ä¼ä¸šå¾®ä¿¡Webhookåœ°å€

#### 2. åˆ›å»ºæ“ä½œå‘˜è´¦å·

1. ç‚¹å‡» **ðŸ‘¥ ç”¨æˆ·ç®¡ç†** â†’ **æ–°å»ºç”¨æˆ·**
2. è®¾ç½®ç”¨æˆ·åã€å¯†ç ã€å§“å
3. è§’è‰²é€‰æ‹© **æ“ä½œå‘˜**
4. å‹¾é€‰éœ€è¦çš„æƒé™ï¼ˆæŸ¥çœ‹è®¢å•ã€å‘è´§ã€é€€æ¬¾ï¼‰
5. å‹¾é€‰æŽˆæƒçš„åº—é“º

#### 3. å¤„ç†è®¢å•

è®¢å•ç”±äº¬ä¸œå¹³å°è‡ªåŠ¨æŽ¨é€åˆ°ç³»ç»Ÿï¼Œæ“ä½œå‘˜åªéœ€å¤„ç†å‘è´§ï¼š

**ç›´å……è®¢å•ï¼š**
1. åœ¨è®¢å•åˆ—è¡¨æ‰¾åˆ°å¾…å¤„ç†è®¢å•
2. ç‚¹å‡» **æ“ä½œ** â†’ **âœ… é€šçŸ¥æˆåŠŸ**
3. ç³»ç»Ÿè‡ªåŠ¨å›žè°ƒäº¬ä¸œå¹³å°é€šçŸ¥å……å€¼æˆåŠŸ

**å¡å¯†è®¢å•ï¼š**
1. åœ¨è®¢å•åˆ—è¡¨æ‰¾åˆ°å¾…å¤„ç†è®¢å•
2. ç‚¹å‡» **æ“ä½œ** â†’ **ðŸšš å¡å¯†å‘è´§**
3. åœ¨å¼¹çª—ä¸­è¾“å…¥å¯¹åº”æ•°é‡çš„å¡å·å’Œå¯†ç 
4. ç³»ç»Ÿè‡ªåŠ¨å›žè°ƒäº¬ä¸œå¹³å°ä¼ é€’å¡å¯†ä¿¡æ¯

**é˜¿å¥‡ç´¢è‡ªåŠ¨å‘è´§ï¼š**
1. ç¡®ä¿åº—é“ºå·²é…ç½®é˜¿å¥‡ç´¢å‚æ•°
2. ç‚¹å‡» **æ“ä½œ** â†’ **ðŸšš é˜¿å¥‡ç´¢å‘è´§**
3. ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨é˜¿å¥‡ç´¢æŽ¥å£å®Œæˆå‘è´§

### æŽ¥å£åœ°å€è¯´æ˜Ž

éƒ¨ç½²å®ŒæˆåŽï¼Œä»¥ä¸‹æŽ¥å£åœ°å€éœ€è¦é…ç½®åˆ°äº¬ä¸œå¹³å°ï¼š

| æŽ¥å£ | åœ°å€ | è¯´æ˜Ž |
|------|------|------|
| è®¢å•æŽ¥æ”¶ | `https://ä½ çš„åŸŸå/api/order/create` | äº¬ä¸œå¹³å°æŽ¨é€è®¢å•åˆ°æ­¤åœ°å€ |
| æµ‹è¯•é€šçŸ¥ | `https://ä½ çš„åŸŸå/api/shop/test-notification` | æµ‹è¯•é€šçŸ¥å‘é€ |
| é‡å‘é€šçŸ¥ | `https://ä½ çš„åŸŸå/api/notification/resend` | é‡å‘å¤±è´¥é€šçŸ¥ |

---

## å¸¸è§é—®é¢˜

### 1. è®¿é—®ç½‘ç«™æ˜¾ç¤º502é”™è¯¯
**åŽŸå› **ï¼šFlaskåº”ç”¨æœªå¯åŠ¨æˆ–å·²å´©æºƒ

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥SupervisorçŠ¶æ€
supervisorctl status dianshang

# å¦‚æžœçŠ¶æ€ä¸æ˜¯RUNNINGï¼ŒæŸ¥çœ‹æ—¥å¿—
tail -50 /www/wwwlogs/dianshang_error.log

# é‡å¯åº”ç”¨
supervisorctl restart dianshang
```

### 2. ç™»å½•åŽæ˜¾ç¤ºç©ºç™½é¡µé¢æˆ–æŠ¥é”™
**åŽŸå› **ï¼šæ•°æ®åº“æœªåˆå§‹åŒ–

**è§£å†³æ–¹æ³•**ï¼š
```bash
cd /www/wwwroot/ds
source venv/bin/activate
python migrations/init_db.py
```

### 3. æ•°æ®åº“è¿žæŽ¥å¤±è´¥
**åŽŸå› **ï¼šæ•°æ®åº“é…ç½®é”™è¯¯

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `DATABASE_URL` é…ç½®
- ç¡®è®¤æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç æ­£ç¡®
- ç¡®è®¤MySQLæœåŠ¡æ­£åœ¨è¿è¡Œ
- å¦‚å¯†ç åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ `@`ã€`#`ï¼‰ï¼Œéœ€è¦URLç¼–ç 

### 4. äº¬ä¸œè®¢å•æŽ¨é€å¤±è´¥
**åŽŸå› **ï¼šç­¾åéªŒè¯å¤±è´¥æˆ–æŽ¥å£ä¸å¯è¾¾

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥åº—é“ºé…ç½®ä¸­çš„MD5å¯†é’¥æ˜¯å¦ä¸Žäº¬ä¸œå¹³å°ä¸€è‡´
- ç¡®è®¤æœåŠ¡å™¨é˜²ç«å¢™å·²å¼€æ”¾80/443ç«¯å£
- æ£€æŸ¥Nginxé…ç½®æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼š`tail -f /www/wwwlogs/dianshang_error.log`

### 5. é’‰é’‰/ä¼ä¸šå¾®ä¿¡é€šçŸ¥å‘é€å¤±è´¥
**åŽŸå› **ï¼šWebhooké…ç½®é”™è¯¯æˆ–ç½‘ç»œé—®é¢˜

**è§£å†³æ–¹æ³•**ï¼š
- åœ¨åº—é“ºç¼–è¾‘é¡µé¢ç‚¹å‡» **æµ‹è¯•å‘é€** æŒ‰é’®éªŒè¯é…ç½®
- æ£€æŸ¥Webhookåœ°å€æ˜¯å¦å®Œæ•´
- é’‰é’‰åŠ ç­¾å¯†é’¥æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹é€šçŸ¥æ—¥å¿—é¡µé¢çš„é”™è¯¯ä¿¡æ¯

### 6. é˜¿å¥‡ç´¢å‘è´§å¤±è´¥
**åŽŸå› **ï¼šé˜¿å¥‡ç´¢é…ç½®ä¸å®Œæ•´æˆ–Tokenè¿‡æœŸ

**è§£å†³æ–¹æ³•**ï¼š
- ç¡®è®¤åº”ç”¨IDã€å¯†é’¥ã€è®¿é—®ä»¤ç‰Œéƒ½å·²æ­£ç¡®å¡«å†™
- æ£€æŸ¥è®¿é—®ä»¤ç‰Œæ˜¯å¦è¿‡æœŸï¼Œéœ€è¦é‡æ–°ä»Žé˜¿å¥‡ç´¢å¹³å°èŽ·å–
- ç¡®è®¤ä¸»æœºåœ°å€å’Œç«¯å£é…ç½®æ­£ç¡®
- æŸ¥çœ‹åº”ç”¨æ—¥å¿—èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

### 7. å¦‚ä½•å¤‡ä»½æ•°æ®ï¼Ÿ

**æ•°æ®åº“å¤‡ä»½**ï¼š
1. åœ¨å®å¡”é¢æ¿ç‚¹å‡» **æ•°æ®åº“**
2. æ‰¾åˆ° `dianshang` æ•°æ®åº“
3. ç‚¹å‡» **å¤‡ä»½**

**å®šæ—¶å¤‡ä»½**ï¼š
1. åœ¨å®å¡”é¢æ¿ç‚¹å‡» **è®¡åˆ’ä»»åŠ¡**
2. æ·»åŠ ä»»åŠ¡ï¼š
   - ä»»åŠ¡ç±»åž‹ï¼šå¤‡ä»½æ•°æ®åº“
   - æ•°æ®åº“ï¼šdianshang
   - æ‰§è¡Œå‘¨æœŸï¼šæ¯å¤©

### 8. å¦‚ä½•æ›´æ–°ç³»ç»Ÿï¼Ÿ

```bash
cd /www/wwwroot/ds

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒ
source venv/bin/activate

# æ›´æ–°ä¾èµ–
pip install -r requirements.txt

# é‡å¯åº”ç”¨
supervisorctl restart dianshang
```

---

## é¡¹ç›®æ–‡ä»¶ç»“æž„è¯´æ˜Ž

```
dianshang/
â”œâ”€â”€ app/                          # åº”ç”¨ä¸»ç›®å½•
â”‚   â”œâ”€â”€ __init__.py              # Flaskåº”ç”¨å·¥åŽ‚
â”‚   â”œâ”€â”€ extensions.py            # æ‰©å±•åˆå§‹åŒ–ï¼ˆæ•°æ®åº“ã€ç™»å½•ç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ models/                  # æ•°æ®æ¨¡åž‹
â”‚   â”‚   â”œâ”€â”€ shop.py              # åº—é“ºæ¨¡åž‹
â”‚   â”‚   â”œâ”€â”€ order.py             # è®¢å•æ¨¡åž‹
â”‚   â”‚   â”œâ”€â”€ user.py              # ç”¨æˆ·æ¨¡åž‹
â”‚   â”‚   â””â”€â”€ notification_log.py  # é€šçŸ¥æ—¥å¿—æ¨¡åž‹
â”‚   â”œâ”€â”€ routes/                  # è·¯ç”±ï¼ˆé¡µé¢å’ŒæŽ¥å£ï¼‰
â”‚   â”‚   â”œâ”€â”€ auth.py              # ç™»å½•/ç™»å‡º
â”‚   â”‚   â”œâ”€â”€ shop.py              # åº—é“ºç®¡ç†
â”‚   â”‚   â”œâ”€â”€ order.py             # è®¢å•ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ user.py              # ç”¨æˆ·ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ notification.py      # é€šçŸ¥æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ statistics.py        # ç»Ÿè®¡æŠ¥è¡¨
â”‚   â”‚   â””â”€â”€ api.py               # å¤–éƒ¨APIæŽ¥å£
â”‚   â”œâ”€â”€ services/                # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ notification.py      # é’‰é’‰/ä¼ä¸šå¾®ä¿¡é€šçŸ¥
â”‚   â”‚   â”œâ”€â”€ jd_game.py           # äº¬ä¸œæ¸¸æˆç‚¹å¡å¹³å°æŽ¥å£
â”‚   â”‚   â”œâ”€â”€ jd_general.py        # äº¬ä¸œé€šç”¨äº¤æ˜“å¹³å°æŽ¥å£
â”‚   â”‚   â””â”€â”€ agiso.py             # é˜¿å¥‡ç´¢å¼€æ”¾å¹³å°æŽ¥å£
â”‚   â”œâ”€â”€ templates/               # HTMLæ¨¡æ¿
â”‚   â””â”€â”€ static/                  # é™æ€æ–‡ä»¶ï¼ˆCSS/JSï¼‰
â”œâ”€â”€ migrations/                  # æ•°æ®åº“è¿ç§»
â”‚   â”œâ”€â”€ init.sql                 # SQLå»ºè¡¨è„šæœ¬
â”‚   â””â”€â”€ init_db.py               # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ tests/                       # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ config.py                    # é…ç½®æ–‡ä»¶
â”œâ”€â”€ run.py                       # åº”ç”¨å…¥å£
â”œâ”€â”€ requirements.txt             # Pythonä¾èµ–
â””â”€â”€ å®å¡”éƒ¨ç½²æ•™ç¨‹.md              # æœ¬æ–‡æ¡£
```

---

## å®‰å…¨å»ºè®®

1. **ä¿®æ”¹é»˜è®¤å¯†ç **ï¼šé¦–æ¬¡éƒ¨ç½²åŽç«‹å³ä¿®æ”¹ `admin` ç”¨æˆ·çš„é»˜è®¤å¯†ç 
2. **ä½¿ç”¨HTTPS**ï¼šé…ç½®SSLè¯ä¹¦ï¼Œå¯ç”¨HTTPSåŠ å¯†ä¼ è¾“
3. **SECRET_KEY**ï¼šä½¿ç”¨éšæœºé•¿å­—ç¬¦ä¸²ï¼Œä¸è¦ä½¿ç”¨é»˜è®¤å€¼
4. **æ•°æ®åº“å¯†ç **ï¼šä½¿ç”¨å¼ºå¯†ç 
5. **é˜²ç«å¢™**ï¼šä»…å¼€æ”¾å¿…è¦ç«¯å£ï¼ˆ80/443ï¼‰
6. **å®šæœŸå¤‡ä»½**ï¼šè®¾ç½®è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
7. **æ—¥å¿—ç›‘æŽ§**ï¼šå®šæœŸæ£€æŸ¥é”™è¯¯æ—¥å¿—

---

> ðŸ“Œ å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥åº”ç”¨æ—¥å¿—ï¼š`/www/wwwlogs/dianshang_error.log`
