# 宝塔面板部署教程

## 1. 服务器要求

| 项目 | 最低配置 | 推荐配置 |
|------|---------|---------|
| 操作系统 | CentOS 7+ / Ubuntu 18.04+ | Ubuntu 22.04 LTS |
| CPU | 1核 | 2核+ |
| 内存 | 1GB | 2GB+ |
| 硬盘 | 20GB | 40GB+ |
| Python | 3.8+ | 3.10+ |

---

## 2. 安装宝塔面板

```bash
# CentOS
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec

# Ubuntu/Debian
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec
```

安装完成后，在宝塔面板中安装：
- **Nginx** 1.22+
- **MySQL** 5.7 或 8.0
- **Python项目管理器**

---

## 3. 创建数据库

1. 登录宝塔面板 → 数据库 → 添加数据库
2. 数据库名：`ds`
3. 用户名：`ds_user`
4. 密码：设置强密码
5. 记录数据库连接信息

---

## 4. 代码部署

### 4.1 上传代码

```bash
# 方式一：通过宝塔文件管理器上传压缩包到 /www/wwwroot/ds
# 方式二：使用 Git
cd /www/wwwroot
git clone https://your-repo-url.git ds
```

### 4.2 创建虚拟环境

```bash
cd /www/wwwroot/ds
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

---

## 5. 环境变量配置

在 `/www/wwwroot/ds` 目录下创建 `.env` 文件（或直接设置环境变量）：

```bash
export FLASK_ENV=production
export SECRET_KEY=your-very-long-random-secret-key-here
export DATABASE_URL=mysql+pymysql://ds_user:your_password@localhost/ds
export ADMIN_PASSWORD=your_admin_password_here
```

建议将上述内容添加到 `start.sh` 顶部或使用宝塔的环境变量配置。

---

## 6. 数据库初始化

```bash
cd /www/wwwroot/ds
source venv/bin/activate
export FLASK_ENV=production
export DATABASE_URL=mysql+pymysql://ds_user:password@localhost/ds

flask db init
flask db migrate -m "initial"
flask db upgrade
```

---

## 7. 创建日志目录

```bash
mkdir -p /www/wwwroot/ds/logs
chmod 755 /www/wwwroot/ds/logs
```

---

## 8. 配置 Gunicorn 启动脚本

编辑 `/www/wwwroot/ds/start.sh`：

```bash
#!/bin/bash
cd /www/wwwroot/ds
source venv/bin/activate
export FLASK_ENV=production
export SECRET_KEY=your-secret-key
export DATABASE_URL=mysql+pymysql://ds_user:password@localhost/ds
export ADMIN_PASSWORD=your_admin_password

mkdir -p logs
gunicorn -c gunicorn_conf.py run:app --daemon
echo "服务已启动"
```

```bash
chmod +x start.sh stop.sh restart.sh
./start.sh
```

验证服务：
```bash
curl http://127.0.0.1:5000/login
```

---

## 9. Nginx 反向代理配置

在宝塔面板 → 网站 → 添加站点，然后修改 Nginx 配置：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名或IP

    # 强制HTTPS（可选）
    # return 301 https://$server_name$request_uri;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
    }

    location /static/ {
        alias /www/wwwroot/ds/app/static/;
        expires 7d;
    }

    access_log /www/wwwlogs/ds.access.log;
    error_log /www/wwwlogs/ds.error.log;
}
```

重载 Nginx：
```bash
nginx -t && nginx -s reload
```

---

## 10. IP 白名单配置

京东服务器IP白名单，编辑 `config.py` 中的 `ALLOWED_IPS`：

```python
ALLOWED_IPS = [
    '59.110.9.236',   # 京东服务器IP（示例，请以实际为准）
    '127.0.0.1',      # 本地测试
]
```

若部署在 Nginx 反向代理后，需确保 Nginx 转发了真实IP：
```nginx
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
```

系统会读取 `X-Forwarded-For` 头中的第一个IP作为客户端真实IP。

---

## 11. 设置开机自启

使用宝塔计划任务或 systemd：

### 方式一：宝塔计划任务

宝塔面板 → 计划任务 → 添加任务：
- 任务类型：Shell脚本
- 任务名称：DS订单系统启动
- 执行周期：服务器启动时
- 脚本内容：`/www/wwwroot/ds/start.sh`

### 方式二：systemd 服务

创建 `/etc/systemd/system/ds.service`：

```ini
[Unit]
Description=DS Order Management System
After=network.target mysql.service

[Service]
Type=forking
User=www
WorkingDirectory=/www/wwwroot/ds
Environment=FLASK_ENV=production
Environment=SECRET_KEY=your-secret-key
Environment=DATABASE_URL=mysql+pymysql://ds_user:password@localhost/ds
Environment=ADMIN_PASSWORD=your_admin_password
ExecStart=/www/wwwroot/ds/start.sh
ExecStop=/www/wwwroot/ds/stop.sh
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

```bash
systemctl daemon-reload
systemctl enable ds
systemctl start ds
```

---

## 12. 访问后台管理

浏览器访问 `http://your-domain.com/login`

- 默认用户名：`admin`
- 默认密码：环境变量 `ADMIN_PASSWORD`（默认 `admin123`，**生产环境必须修改**）

---

## 13. 常见问题排查

### 服务无法启动
```bash
cd /www/wwwroot/ds
source venv/bin/activate
python run.py  # 直接运行查看错误
```

### 查看日志
```bash
tail -f /www/wwwroot/ds/logs/error.log
tail -f /www/wwwroot/ds/logs/access.log
```

### 数据库连接失败
```bash
# 测试数据库连接
mysql -u ds_user -p ds
```

### 重启服务
```bash
cd /www/wwwroot/ds
./restart.sh
```
