{% extends "layouts/base.html" %}
{% block title %}è®¢å•ç®¡ç†{% endblock %}

{% block content %}
<div class="card">
    <div class="card-title">
        ğŸ“¦ è®¢å•ç®¡ç†
        <div style="float: right; display: flex; gap: 8px; align-items: center;">
            <span class="badge">æ€»è®¡: {{ pagination.total }} ä¸ªè®¢å•</span>
            <a href="{{ url_for('order.export_orders', **request.args) }}" class="btn btn-sm btn-primary">ğŸ“¤ å¯¼å‡ºCSV</a>
            {% if current_user.can_deliver or current_user.is_admin %}
            <button class="btn btn-sm btn-success" onclick="batchNotifySuccess()">âœ… æ‰¹é‡é€šçŸ¥æˆåŠŸ</button>
            {% endif %}
        </div>
    </div>

    <!-- æœç´¢å’Œç­›é€‰ -->
    <form method="GET" action="{{ url_for('order.order_list') }}" class="mb-4">
        <div class="form-row">
            <div class="form-group">
                <input type="text" name="keyword" class="form-control" placeholder="è®¢å•å·/äº¬ä¸œè®¢å•å·/å•†å“/è´¦å·" value="{{ request.args.get('keyword', '') }}">
            </div>
            <div class="form-group">
                <select name="order_status" class="form-control">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="0" {{ 'selected' if request.args.get('order_status') == '0' }}>å¾…å¤„ç†</option>
                    <option value="1" {{ 'selected' if request.args.get('order_status') == '1' }}>å¤„ç†ä¸­</option>
                    <option value="2" {{ 'selected' if request.args.get('order_status') == '2' }}>å·²å®Œæˆ</option>
                    <option value="3" {{ 'selected' if request.args.get('order_status') == '3' }}>å·²å–æ¶ˆ</option>
                    <option value="4" {{ 'selected' if request.args.get('order_status') == '4' }}>å·²é€€æ¬¾</option>
                    <option value="5" {{ 'selected' if request.args.get('order_status') == '5' }}>å¼‚å¸¸</option>
                </select>
            </div>
            <div class="form-group">
                <select name="order_type" class="form-control">
                    <option value="">å…¨éƒ¨è®¢å•ç±»å‹</option>
                    <option value="1" {{ 'selected' if request.args.get('order_type') == '1' }}>ç›´å……</option>
                    <option value="2" {{ 'selected' if request.args.get('order_type') == '2' }}>å¡å¯†</option>
                </select>
            </div>
            <div class="form-group">
                <select name="shop_id" class="form-control">
                    <option value="">å…¨éƒ¨åº—é“º</option>
                    {% for shop in shops %}
                    <option value="{{ shop.id }}" {{ 'selected' if request.args.get('shop_id') == shop.id|string }}>{{ shop.shop_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">ğŸ” æœç´¢</button>
                <a href="{{ url_for('order.order_list') }}" class="btn">é‡ç½®</a>
            </div>
        </div>
    </form>

    <!-- å…¨é€‰ -->
    {% if current_user.can_deliver or current_user.is_admin %}
    <div style="margin-bottom: 8px;">
        <label style="cursor:pointer;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"> å…¨é€‰</label>
    </div>
    {% endif %}

    <!-- è®¢å•åˆ—è¡¨ -->
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    {% if current_user.can_deliver or current_user.is_admin %}<th style="width:36px;"></th>{% endif %}
                    <th>äº¬ä¸œè®¢å•å·</th>
                    <th>åº—é“º</th>
                    <th>åº—é“ºç±»å‹</th>
                    <th>è®¢å•ç±»å‹</th>
                    <th>çŠ¶æ€</th>
                    <th>å•†å“ä¿¡æ¯</th>
                    <th>é‡‘é¢</th>
                    <th>æ•°é‡</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% if orders %}
                    {% for order in orders %}
                    <tr>
                        {% if current_user.can_deliver or current_user.is_admin %}
                        <td><input type="checkbox" class="order-checkbox" value="{{ order.id }}" data-status="{{ order.order_status }}" data-type="{{ order.order_type }}"></td>
                        {% endif %}
                        <td>
                            <a href="javascript:void(0)" onclick="showOrderDetail({{ order.id }})" title="{{ order.order_no }}">
                                {{ order.jd_order_no }}
                            </a>
                        </td>
                        <td>
                            {% if order.shop %}
                                {{ order.shop.shop_name }}
                            {% else %}
                                <span class="text-muted">æœªçŸ¥åº—é“º</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.shop_type == 1 %}
                                <span class="badge badge-info">æ¸¸æˆç‚¹å¡</span>
                            {% else %}
                                <span class="badge badge-success">é€šç”¨äº¤æ˜“</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.order_type == 1 %}
                                <span class="badge badge-primary">âš¡ ç›´å……</span>
                            {% else %}
                                <span class="badge badge-purple">ğŸ”‘ å¡å¯†</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.order_status == 0 %}
                                <span class="badge badge-warning">â³ å¾…å¤„ç†</span>
                            {% elif order.order_status == 1 %}
                                <span class="badge badge-info">ğŸ”„ å¤„ç†ä¸­</span>
                            {% elif order.order_status == 2 %}
                                <span class="badge badge-success">âœ… å·²å®Œæˆ</span>
                            {% elif order.order_status == 3 %}
                                <span class="badge badge-secondary">âŒ å·²å–æ¶ˆ</span>
                            {% elif order.order_status == 4 %}
                                <span class="badge badge-danger">ğŸ’° å·²é€€æ¬¾</span>
                            {% elif order.order_status == 5 %}
                                <span class="badge badge-error">âš ï¸ å¼‚å¸¸</span>
                            {% else %}
                                <span class="badge">æœªçŸ¥({{ order.order_status }})</span>
                            {% endif %}
                        </td>
                        <td>
                            <span title="{{ order.product_info or '-' }}">
                                {% if order.product_info and order.product_info|length > 10 %}
                                    {{ order.product_info[:10] }}...
                                {% else %}
                                    {{ order.product_info or '-' }}
                                {% endif %}
                            </span>
                        </td>
                        <td>Â¥{{ '%.2f'|format(order.amount / 100) }}</td>
                        <td>{{ order.quantity }}</td>
                        <td>{{ order.create_time.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="javascript:void(0)" onclick="showOrderDetail({{ order.id }})" class="btn btn-sm btn-detail">ğŸ“„ è¯¦æƒ…</a>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-success dropdown-toggle">æ“ä½œ â–¼</button>
                                    <div class="dropdown-menu">
                                        {% if current_user.is_admin or current_user.can_deliver %}
                                        <a href="javascript:void(0)" onclick="notifySuccess({{ order.id }})">âœ… é€šçŸ¥æˆåŠŸ</a>
                                        {% endif %}
                                        {% if current_user.is_admin or current_user.can_refund %}
                                        <a href="javascript:void(0)" onclick="notifyRefund({{ order.id }})">ğŸ’° é€šçŸ¥é€€æ¬¾</a>
                                        {% endif %}
                                        {% if (current_user.is_admin or current_user.can_deliver) and order.shop and order.shop.agiso_enabled %}
                                        <a href="javascript:void(0)" onclick="agisoDeliver({{ order.id }})">ğŸšš é˜¿å¥‡ç´¢å‘è´§</a>
                                        {% endif %}
                                        <div class="dropdown-divider"></div>
                                        <div class="dropdown-submenu">
                                            <a href="javascript:void(0)">ğŸ”§ è‡ªåŠ©è”è°ƒ â–¼</a>
                                            <div class="dropdown-submenu-content">
                                                <a href="javascript:void(0)" onclick="debugSuccess({{ order.id }})">âš ï¸ å……å€¼æˆåŠŸ</a>
                                                <a href="javascript:void(0)" onclick="debugProcessing({{ order.id }})">âš ï¸ å……å€¼ä¸­</a>
                                                <a href="javascript:void(0)" onclick="debugFailed({{ order.id }})">âš ï¸ å……å€¼å¤±è´¥</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="{% if current_user.can_deliver or current_user.is_admin %}11{% else %}10{% endif %}" class="text-center text-muted">æš‚æ— è®¢å•æ•°æ®</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- åˆ†é¡µ -->
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
            <a href="{{ url_for('order.order_list', page=pagination.prev_num, keyword=request.args.get('keyword', ''), order_status=request.args.get('order_status', ''), order_type=request.args.get('order_type', ''), shop_id=request.args.get('shop_id', '')) }}" class="page-link">ä¸Šä¸€é¡µ</a>
        {% endif %}

        {% for page in pagination.iter_pages() %}
            {% if page %}
                {% if page == pagination.page %}
                    <span class="page-link active">{{ page }}</span>
                {% else %}
                    <a href="{{ url_for('order.order_list', page=page, keyword=request.args.get('keyword', ''), order_status=request.args.get('order_status', ''), order_type=request.args.get('order_type', ''), shop_id=request.args.get('shop_id', '')) }}" class="page-link">{{ page }}</a>
                {% endif %}
            {% else %}
                <span class="page-link">...</span>
            {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
            <a href="{{ url_for('order.order_list', page=pagination.next_num, keyword=request.args.get('keyword', ''), order_status=request.args.get('order_status', ''), order_type=request.args.get('order_type', ''), shop_id=request.args.get('shop_id', '')) }}" class="page-link">ä¸‹ä¸€é¡µ</a>
        {% endif %}
    </div>
    {% endif %}

    <!-- è‡ªåŠ¨åˆ·æ–° -->
    <div style="text-align:center;margin-top:16px;">
        <button id="autoRefreshBtn" class="btn btn-sm" onclick="toggleAutoRefresh()">â± å¼€å¯è‡ªåŠ¨åˆ·æ–°</button>
        <span id="refreshCountdown" style="margin-left:8px;color:#666;font-size:13px;"></span>
    </div>
</div>

<!-- è®¢å•è¯¦æƒ…å¼¹çª— -->
<div id="orderModal" class="modal">
    <div class="modal-content" style="position: relative; width: 450px; min-width: 400px; max-width: 95vw; margin: 2vh auto; max-height: 90vh; overflow-y: auto; overflow-x: hidden; padding: 0;">
        <div class="modal-header">
            <h3>ğŸ“„ è®¢å•è¯¦æƒ…</h3>
            <span class="modal-close" onclick="closeOrderModal()">&times;</span>
        </div>
        <div class="modal-body" id="orderDetailContent">
            <div style="text-align: center; padding: 40px;">
                <div class="loading-spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>
</div>

<style data-ts="1771484721">
/* Cache Buster: 1771484342 */

.badge {
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: 500;
    display: inline-block;
}
.badge-warning { background: #faad14; color: white; }
.badge-info { background: #1890ff; color: white; }
.badge-success { background: #52c41a; color: white; }
.badge-secondary { background: #8c8c8c; color: white; }
.badge-danger { background: #ff4d4f; color: white; }
.badge-error { background: #fa541c; color: white; }
.badge-primary { background: #722ed1; color: white; }
.badge-purple { background: #eb2f96; color: white; }

.table-responsive { overflow-x: auto; }
.table { width: 100%; border-collapse: collapse; }
.table th, .table td {
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
    text-align: left;
    white-space: nowrap;
}
.table th { background: #fafafa; font-weight: 600; }
.table tbody tr:hover { background: #f5f5f5; }

.action-buttons { display: flex; gap: 5px; align-items: center; }
.btn-detail { background: #1890ff; color: white; }
.btn-detail:hover { background: #096dd9; }

.dropdown { position: relative; display: inline-block; }
.dropdown-toggle {
    background: #52c41a;
    color: white;
    border: none;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 13px;
}
.dropdown-toggle:hover { background: #389e0d; }
.dropdown-menu {
    display: none;
    position: absolute;
    right: 0;
    background: white;
    min-width: 160px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border-radius: 4px;
    z-index: 1000;
    padding: 4px 0;
}
.dropdown:hover .dropdown-menu { display: block; }
.dropdown-menu a {
    display: block;
    padding: 8px 16px;
    color: #333;
    text-decoration: none;
    font-size: 13px;
}
.dropdown-menu a:hover { background: #f5f5f5; }
.dropdown-divider { height: 1px; background: #e8e8e8; margin: 4px 0; }

.dropdown-submenu { position: relative; }
.dropdown-submenu > a::after { content: ' â–¶'; float: right; }
.dropdown-submenu-content {
    display: none;
    position: absolute;
    left: 100%;
    top: 0;
    background: white;
    min-width: 140px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border-radius: 4px;
    padding: 4px 0;
}
.dropdown-submenu:hover .dropdown-submenu-content { display: block; }

.pagination {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin-top: 20px;
}
.page-link {
    padding: 8px 12px;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    text-decoration: none;
    color: #333;
}
.page-link:hover { background: #f0f0f0; }
.page-link.active {
    background: #1890ff;
    color: white;
    border-color: #1890ff;
}

/* å¼¹çª—æ ·å¼ */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    overflow: auto;
}
.modal-content {
    background-color: #fefefe;
    margin: 2vh auto !important;
    padding: 0;
    border: 1px solid #888;
    width: 500px !important;
    max-width: 90vw !important;
    max-height: 90vh;
    overflow-y: auto;
    overflow-x: hidden;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    position: relative;
}
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; border-bottom: 1px solid #e8e8e8; width: 100%; box-sizing: border-box; background: #fafafa; }
.modal-header h3 { margin: 0; font-size: 18px; }
.modal-close {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 28px;
    font-weight: bold;
    z-index: 10;
    color: #999;
    cursor: pointer;
    line-height: 1;
}
.modal-close:hover { color: #333; }
.modal-body { padding: 20px 30px; width: 100%; box-sizing: border-box; }

.loading-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #1890ff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// æ˜¾ç¤ºè®¢å•è¯¦æƒ…å¼¹çª—
function showOrderDetail(orderId) {
    const modal = document.getElementById('orderModal');
    const content = document.getElementById('orderDetailContent');
    modal.style.display = 'block';
    const modalContent = modal.querySelector('.modal-content');
    if (modalContent) {
        modalContent.style.width = '96vw';
        modalContent.style.maxWidth = '96vw';
        modalContent.style.height = '96vh';
        modalContent.style.maxHeight = '96vh';
        modalContent.style.margin = '2vh auto';
    }
    content.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading-spinner"></div><p>åŠ è½½ä¸­...</p></div>';
    fetch('/order/' + orderId + '/detail-html')
        .then(function(res) { return res.text(); })
        .then(function(html) {
            content.innerHTML = html;
            setTimeout(function() {
                var card = content.querySelector('.card');
                if (card) {
                    card.style.width = '90vw';
                    card.style.maxWidth = '90vw';
                    card.style.margin = '0 auto';
                }
            }, 100);
        })
        .catch(function() {
            content.innerHTML = '<div style="text-align: center; padding: 40px; color: red;">åŠ è½½å¤±è´¥</div>';
        });
}

function closeOrderModal() {
    document.getElementById('orderModal').style.display = 'none';
}

window.onclick = function(event) {
    var modal = document.getElementById('orderModal');
    if (event.target == modal) modal.style.display = 'none';
};

function notifySuccess(orderId) {
    if (!confirm('ç¡®å®šè¦é€šçŸ¥æˆåŠŸå—ï¼Ÿ')) return;
    fetch('/order/' + orderId + '/notify-success', { method: 'POST' })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            alert(data.success ? 'âœ… ' + data.message : 'âŒ ' + data.message);
            if (data.success) location.reload();
        });
}

function notifyRefund(orderId) {
    if (!confirm('ç¡®å®šè¦é€šçŸ¥é€€æ¬¾å—ï¼Ÿ')) return;
    fetch('/order/' + orderId + '/notify-refund', { method: 'POST' })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            alert(data.success ? 'âœ… ' + data.message : 'âŒ ' + data.message);
            if (data.success) location.reload();
        });
}

function agisoDeliver(orderId) {
    if (!confirm('ç¡®å®šè¦ Agiso å‘è´§å—ï¼Ÿ')) return;
    fetch('/order/' + orderId + '/agiso-deliver', { method: 'POST' })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            alert(data.success ? 'âœ… ' + data.message : 'âŒ ' + data.message);
            if (data.success) location.reload();
        });
}

function debugSuccess(orderId) {
    if (!confirm('ã€è°ƒè¯•ã€‘ç¡®å®šæ ‡è®°ä¸ºå·²å®Œæˆï¼Ÿ')) return;
    fetch('/order/' + orderId + '/debug-success', { method: 'POST' })
        .then(function(res) { return res.json(); })
        .then(function(data) { alert(data.message); location.reload(); });
}

function debugProcessing(orderId) {
    if (!confirm('ã€è°ƒè¯•ã€‘ç¡®å®šæ ‡è®°ä¸ºå¤„ç†ä¸­ï¼Ÿ')) return;
    fetch('/order/' + orderId + '/debug-processing', { method: 'POST' })
        .then(function(res) { return res.json(); })
        .then(function(data) { alert(data.message); location.reload(); });
}

function debugFailed(orderId) {
    if (!confirm('ã€è°ƒè¯•ã€‘ç¡®å®šæ ‡è®°ä¸ºå·²å¤±è´¥ï¼Ÿ')) return;
    fetch('/order/' + orderId + '/debug-failed', { method: 'POST' })
        .then(function(res) { return res.json(); })
        .then(function(data) { alert(data.message); location.reload(); });
}

// å…¨é€‰/å–æ¶ˆå…¨é€‰
function toggleSelectAll(cb) {
    document.querySelectorAll('.order-checkbox').forEach(function(c) { c.checked = cb.checked; });
}

// æ‰¹é‡é€šçŸ¥æˆåŠŸ
function batchNotifySuccess() {
    var checked = Array.from(document.querySelectorAll('.order-checkbox:checked'));
    var ids = checked
        .filter(function(c) { return (c.dataset.status == '0' || c.dataset.status == '1') && c.dataset.type == '1'; })
        .map(function(c) { return parseInt(c.value); });
    if (ids.length === 0) {
        alert('è¯·é€‰æ‹©å¾…å¤„ç†æˆ–å¤„ç†ä¸­çš„ç›´å……è®¢å•');
        return;
    }
    if (!confirm('ç¡®å®šæ‰¹é‡é€šçŸ¥æˆåŠŸ ' + ids.length + ' ä¸ªè®¢å•ï¼Ÿ')) return;
    fetch('/order/batch-notify-success', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order_ids: ids })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        alert('æˆåŠŸ: ' + data.ok_count + ' ä¸ªï¼Œå¤±è´¥: ' + data.fail_count + ' ä¸ª');
        location.reload();
    });
}

// è‡ªåŠ¨åˆ·æ–°
var autoRefreshEnabled = localStorage.getItem('autoRefresh') === 'true';
var refreshTimer = null;
var countdown = 30;

function updateAutoRefreshBtn() {
    var btn = document.getElementById('autoRefreshBtn');
    var cd = document.getElementById('refreshCountdown');
    if (autoRefreshEnabled) {
        btn.textContent = 'â± å…³é—­è‡ªåŠ¨åˆ·æ–°';
        btn.className = 'btn btn-sm btn-warning';
    } else {
        btn.textContent = 'â± å¼€å¯è‡ªåŠ¨åˆ·æ–°';
        btn.className = 'btn btn-sm';
        if (cd) cd.textContent = '';
    }
}

function startAutoRefresh() {
    countdown = 30;
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(function() {
        countdown--;
        var cd = document.getElementById('refreshCountdown');
        if (cd) cd.textContent = countdown + 'ç§’åè‡ªåŠ¨åˆ·æ–°...';
        if (countdown <= 0) {
            location.reload();
        }
    }, 1000);
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    localStorage.setItem('autoRefresh', autoRefreshEnabled);
    updateAutoRefreshBtn();
    if (autoRefreshEnabled) {
        startAutoRefresh();
    } else {
        if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
        var cd = document.getElementById('refreshCountdown');
        if (cd) cd.textContent = '';
    }
}

updateAutoRefreshBtn();
if (autoRefreshEnabled) startAutoRefresh();
</script>

{% endblock %}
