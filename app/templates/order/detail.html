{% extends "layouts/base.html" %}
{% block title %}è®¢å•è¯¦æƒ…{% endblock %}

{% block content %}
<div class="card">
    <div class="card-title">
        ğŸ“„ è®¢å•è¯¦æƒ…
        <a href="{{ url_for('order.order_list') }}" class="btn btn-sm" style="float: right;">è¿”å›åˆ—è¡¨</a>
    </div>

    <div class="detail-section">
        <h3>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
        <div class="detail-grid">
            <div class="detail-item">
                <label>ç³»ç»Ÿè®¢å•å·ï¼š</label>
                <span>{{ order.order_no }}</span>
            </div>
            <div class="detail-item">
                <label>äº¬ä¸œè®¢å•å·ï¼š</label>
                <span>{{ order.jd_order_no }}</span>
            </div>
            <div class="detail-item">
                <label>åº—é“ºåç§°ï¼š</label>
                <span>{{ order.shop.shop_name if order.shop else 'æœªçŸ¥' }}</span>
            </div>
            <div class="detail-item">
                <label>è®¢å•ç±»å‹ï¼š</label>
                <span>
                    {% if order.shop_type == 1 %}
                        <span class="badge badge-info">æ¸¸æˆç‚¹å¡</span>
                    {% else %}
                        <span class="badge badge-success">é€šç”¨äº¤æ˜“</span>
                    {% endif %}
                    -
                    {% if order.order_type == 1 %}
                        <span class="badge badge-primary">ç›´å……</span>
                    {% else %}
                        <span class="badge badge-warning">å¡å¯†</span>
                    {% endif %}
                </span>
            </div>
            <div class="detail-item">
                <label>è®¢å•çŠ¶æ€ï¼š</label>
                <span>
                    {% if order.order_status == 0 %}
                        <span class="badge badge-warning">â³ å¾…å¤„ç†</span>
                    {% elif order.order_status == 1 %}
                        <span class="badge badge-info">ğŸ”„ å¤„ç†ä¸­</span>
                    {% elif order.order_status == 2 %}
                        <span class="badge badge-success">âœ… å·²å®Œæˆ</span>
                    {% elif order.order_status == 3 %}
                        <span class="badge badge-secondary">âŒ å·²å–æ¶ˆ</span>
                    {% elif order.order_status == 4 %}
                        <span class="badge badge-danger">ğŸ’° å·²é€€æ¬¾</span>
                    {% elif order.order_status == 5 %}
                        <span class="badge badge-error">âš ï¸ å¼‚å¸¸</span>
                    {% endif %}
                </span>
            </div>
            <div class="detail-item">
                <label>å•†å“ä¿¡æ¯ï¼š</label>
                <span>{{ order.product_info or '-' }}</span>
            </div>
            <div class="detail-item">
                <label>SKU IDï¼š</label>
                <span>{{ order.sku_id or '-' }}</span>
            </div>
            <div class="detail-item">
                <label>è®¢å•é‡‘é¢ï¼š</label>
                <span class="amount">Â¥{{ '%.2f'|format(order.amount / 100) }}</span>
            </div>
            <div class="detail-item">
                <label>è®¢å•æ•°é‡ï¼š</label>
                <span>{{ order.quantity }}</span>
            </div>
            <div class="detail-item">
                <label>å……å€¼è´¦å·ï¼š</label>
                <span>{{ order.produce_account or '-' }}</span>
            </div>
            <div class="detail-item">
                <label>åˆ›å»ºæ—¶é—´ï¼š</label>
                <span>{{ order.create_time.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </div>
            <div class="detail-item">
                <label>å¤‡æ³¨ï¼š</label>
                <span>{{ order.remark or '-' }}</span>
            </div>
        </div>
    </div>

    <!-- å¡å¯†è®¢å•ï¼šæ˜¾ç¤ºæˆ–å¡«å†™å¡å¯† -->
    {% if order.order_type == 2 %}
    <div class="detail-section">
        <h3>ğŸ’³ å¡å¯†ä¿¡æ¯</h3>
        
        {% if order.card_info_parsed %}
            <!-- å·²æœ‰å¡å¯†ï¼Œæ˜¾ç¤ºåˆ—è¡¨ -->
            <div class="card-list-container">
                <table class="card-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>å¡å·</th>
                            <th>å¯†ç </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for card in order.card_info_parsed %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ card.cardNo }}</td>
                            <td>{{ card.cardPwd }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <!-- æœªå¡«å†™å¡å¯†ï¼Œæ˜¾ç¤ºå¡«å†™è¡¨å• -->
            <div class="alert alert-warning">
                âš ï¸ è¯¥è®¢å•éœ€è¦ <strong>{{ order.quantity }}</strong> ç»„å¡å¯†ï¼Œï¿½ï¿½ï¿½å¡«å†™åæäº¤
            </div>
            
            <div class="card-input-tools mb-3">
                <button type="button" class="btn btn-primary" onclick="generateRandomCards()">
                    ğŸ² ä¸€é”®ç”Ÿæˆéšæœºå¡å¯†ï¼ˆ{{ order.quantity }}ç»„ï¼‰
                </button>
                <button type="button" class="btn" onclick="clearAllCards()">
                    ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨
                </button>
            </div>
            
            <form id="cardForm" onsubmit="submitCards(event)">
                <div id="cardInputs">
                    {% for i in range(order.quantity) %}
                    <div class="card-input-row">
                        <span class="card-index">ç¬¬ {{ i+1 }} ç»„ï¼š</span>
                        <input type="text" 
                               class="form-control card-no" 
                               name="cardNo_{{ i }}" 
                               placeholder="å¡å·ï¼ˆ16ä½æ•°å­—ï¼‰" 
                               required 
                               pattern="[0-9]{16}"
                               maxlength="16">
                        <input type="text" 
                               class="form-control card-pwd" 
                               name="cardPwd_{{ i }}" 
                               placeholder="å¯†ç ï¼ˆ6ä½ï¼‰" 
                               required 
                               pattern="[A-Za-z0-9]{6}"
                               maxlength="6">
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-success">ğŸ’¾ ä¿å­˜å¡å¯†</button>
                    <a href="{{ url_for('order.order_list') }}" class="btn">å–æ¶ˆ</a>
                </div>
            </form>
        {% endif %}
    </div>
    {% endif %}

    <!-- æ“ä½œæ—¥å¿— -->
    <div class="detail-section">
        <h3>ğŸ“œ æ“ä½œæ—¥å¿—</h3>
        <div class="log-container">
            <div class="log-item">
                <span class="log-time">{{ order.create_time.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                <span class="log-content">è®¢å•åˆ›å»º</span>
            </div>
            {% if order.card_info_parsed %}
            <div class="log-item">
                <span class="log-time">-</span>
                <span class="log-content">å·²å¡«å†™ {{ order.card_info_parsed|length }} ç»„å¡å¯†</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.detail-section {
    margin-bottom: 30px;
}
.detail-section h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #1890ff;
}
.detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}
.detail-item {
    display: flex;
    align-items: center;
}
.detail-item label {
    min-width: 120px;
    font-weight: 600;
    color: #666;
}
.detail-item .amount {
    color: #ff4d4f;
    font-weight: bold;
    font-size: 16px;
}
.badge {
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: 500;
}
.badge-info { background: #1890ff; color: white; }
.badge-success { background: #52c41a; color: white; }
.badge-primary { background: #722ed1; color: white; }
.badge-warning { background: #faad14; color: white; }
.badge-danger { background: #ff4d4f; color: white; }
.badge-secondary { background: #8c8c8c; color: white; }
.badge-error { background: #fa541c; color: white; }

/* å¡å¯†è¡¨æ ¼ */
.card-list-container {
    overflow-x: auto;
}
.card-table {
    width: 100%;
    border-collapse: collapse;
}
.card-table th,
.card-table td {
    padding: 10px;
    border: 1px solid #e8e8e8;
    text-align: left;
}
.card-table th {
    background: #fafafa;
    font-weight: 600;
}
.card-table tbody tr:hover {
    background: #f5f5f5;
}

/* å¡å¯†è¾“å…¥ */
.card-input-tools {
    display: flex;
    gap: 10px;
}
.card-input-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}
.card-index {
    min-width: 80px;
    font-weight: 600;
    color: #666;
}
.card-no,
.card-pwd {
    flex: 1;
    max-width: 300px;
}

/* æ—¥å¿— */
.log-container {
    background: #fafafa;
    padding: 15px;
    border-radius: 4px;
}
.log-item {
    padding: 8px 0;
    border-bottom: 1px solid #e8e8e8;
}
.log-item:last-child {
    border-bottom: none;
}
.log-time {
    color: #999;
    font-size: 13px;
    margin-right: 15px;
}
.log-content {
    color: #333;
}
</style>

<script>
// ç”Ÿæˆéšæœºå¡å¯†
function generateRandomCards() {
    const quantity = {{ order.quantity }};
    
    for (let i = 0; i < quantity; i++) {
        // ç”Ÿæˆ16ä½éšæœºå¡å·
        const cardNo = generateRandomNumber(16);
        // ç”Ÿæˆ6ä½éšæœºå¯†ç ï¼ˆæ•°å­—+å­—æ¯ï¼‰
        const cardPwd = generateRandomPassword(6);
        
        document.querySelector(`input[name="cardNo_${i}"]`).value = cardNo;
        document.querySelector(`input[name="cardPwd_${i}"]`).value = cardPwd;
    }
    
    alert('âœ… å·²ç”Ÿæˆ ' + quantity + ' ç»„éšæœºå¡å¯†');
}

// ç”Ÿæˆéšæœºæ•°å­—
function generateRandomNumber(length) {
    let result = '';
    for (let i = 0; i < length; i++) {
        result += Math.floor(Math.random() * 10);
    }
    return result;
}

// ç”Ÿæˆéšæœºå¯†ç ï¼ˆæ•°å­—+å­—æ¯ï¼‰
function generateRandomPassword(length) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// æ¸…ç©ºæ‰€æœ‰å¡å¯†
function clearAllCards() {
    if (confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰å¡å¯†è¾“å…¥ï¼Ÿ')) {
        const quantity = {{ order.quantity }};
        for (let i = 0; i < quantity; i++) {
            document.querySelector(`input[name="cardNo_${i}"]`).value = '';
            document.querySelector(`input[name="cardPwd_${i}"]`).value = '';
        }
    }
}

// æäº¤å¡å¯†
function submitCards(event) {
    event.preventDefault();
    
    const quantity = {{ order.quantity }};
    const cards = [];
    
    // æ”¶é›†æ‰€æœ‰å¡å¯†
    for (let i = 0; i < quantity; i++) {
        const cardNo = document.querySelector(`input[name="cardNo_${i}"]`).value.trim();
        const cardPwd = document.querySelector(`input[name="cardPwd_${i}"]`).value.trim();
        
        if (!cardNo || !cardPwd) {
            alert(`âŒ ç¬¬ ${i+1} ç»„å¡å¯†æœªå¡«å†™å®Œæ•´`);
            return;
        }
        
        if (cardNo.length !== 16 || !/^\d{16}$/.test(cardNo)) {
            alert(`âŒ ç¬¬ ${i+1} ç»„å¡å·å¿…é¡»æ˜¯16ä½æ•°å­—`);
            return;
        }
        
        if (cardPwd.length !== 6 || !/^[A-Za-z0-9]{6}$/.test(cardPwd)) {
            alert(`âŒ ç¬¬ ${i+1} ç»„å¯†ç å¿…é¡»æ˜¯6ä½æ•°å­—æˆ–å­—æ¯`);
            return;
        }
        
        cards.push({
            cardNo: cardNo,
            cardPwd: cardPwd
        });
    }
    
    // æäº¤åˆ°åç«¯
    fetch('/order/{{ order.id }}/save-cards', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({cards: cards})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ' + data.message);
            location.reload();
        } else {
            alert('âŒ ' + data.message);
        }
    })
    .catch(err => {
        alert('âŒ æäº¤å¤±è´¥ï¼š' + err);
    });
}
</script>
{% endblock %}
