{% extends "layouts/base.html" %}
{% block title %}{{ 'ç¼–è¾‘å•†å“é…ç½®' if product else 'æ–°å»ºå•†å“é…ç½®' }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-title">{{ 'âœï¸ ç¼–è¾‘å•†å“é…ç½®' if product else 'ğŸ›ï¸ æ–°å»ºå•†å“é…ç½®' }}</div>

    <div class="alert alert-info mb-3" style="background:#e6f7ff;border:1px solid #91d5ff;padding:12px;border-radius:4px;font-size:13px;">
        <strong>ğŸ’¡ é…ç½®è¯´æ˜ï¼š</strong><br>
        â€¢ æ¯æ¡é…ç½®å¯¹åº” <strong>ä¸€ä¸ª SKU ID</strong>ï¼Œç»‘å®šä¸€ç§å‘è´§æ–¹å¼ï¼ˆ91å¡åˆ¸å¡ç§ æˆ– ç›´å……æœåŠ¡ï¼‰<br>
        â€¢ åŒä¸€ä¸ªäº¬ä¸œå•†å“æœ‰å¤šä¸ªè§„æ ¼ï¼ˆæœˆå¡/å­£å¡/å¹´å¡ï¼‰ï¼Œè¯·åˆ†åˆ«æ–°å»ºå¤šæ¡é…ç½®ï¼Œæ¯æ¡å¡«å†™ä¸åŒçš„ SKU ID å’Œå¯¹åº”å¡ç§<br>
        â€¢ ä¾‹å¦‚ï¼šçˆ±å¥‡è‰ºæœˆå¡ SKU=100001 â†’ 91å¡åˆ¸å¡ç§Aï¼›çˆ±å¥‡è‰ºå­£å¡ SKU=100002 â†’ 91å¡åˆ¸å¡ç§B<br>
        â€¢ SKU ID ä¸å¡«åˆ™æŒ‰å•†å“åç§°åŒ¹é…è®¢å•ï¼ˆä¸ç²¾ç¡®ï¼Œå»ºè®®å¡«å†™ï¼‰
    </div>

    <form method="POST" id="productForm">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="section-title">ğŸ“¦ åŸºæœ¬ä¿¡æ¯</div>
        <div class="form-row">
            <div class="form-group">
                <label>æ‰€å±åº—é“º *</label>
                <div style="display:flex;gap:8px;align-items:center;">
                    <select name="shop_id" id="shopSelect" class="form-control"
                            onchange="onShopChange()" required {{ 'disabled' if product }}>
                        <option value="">è¯·é€‰æ‹©åº—é“º</option>
                        {% for shop in shops %}
                        <option value="{{ shop.id }}"
                                data-has-card91="{{ '1' if shop.card91_api_key else '0' }}"
                                {{ 'selected' if (product and product.shop_id == shop.id) or (not product and default_shop_id == shop.id) }}>
                            {{ shop.shop_name }}{% if shop.card91_api_key %} ğŸ«{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-sm btn-info" onclick="openCard91ConfigModal()">âš™ï¸ é…ç½®91å¡åˆ¸</button>
                </div>
                {% if product %}
                <input type="hidden" name="shop_id" value="{{ product.shop_id }}">
                {% endif %}
            </div>
            <div class="form-group">
                <label>å•†å“åç§° * <small class="text-muted">ï¼ˆäº¬ä¸œå•†å“æ ‡é¢˜ï¼Œä¾¿äºè¯†åˆ«ï¼‰</small></label>
                <input type="text" name="product_name" class="form-control"
                       value="{{ product.product_name if product else '' }}"
                       required placeholder="ä¾‹å¦‚ï¼šçˆ±å¥‡è‰ºé»„é‡‘ä¼šå‘˜æœˆå¡">
            </div>
        </div>

        <!-- äº¬ä¸œå•†å“ä¿¡æ¯ -->
        <div class="section-title">ğŸ”— äº¬ä¸œ SKU ä¿¡æ¯</div>
        <div class="alert" style="background:#f6ffed;border:1px solid #b7eb8f;padding:10px;border-radius:4px;margin-bottom:12px;font-size:13px;">
            <strong>ğŸ“Œ ä¸€æ¡é…ç½® = ä¸€ä¸ª SKU ID = ä¸€ç§å‘è´§æ–¹å¼</strong><br>
            å¦‚æœåŒä¸€ä¸ªäº¬ä¸œå•†å“æœ‰å¤šä¸ªè§„æ ¼ï¼Œè¯·åˆ†åˆ«æ–°å»ºå¤šæ¡é…ç½®ï¼Œæ¯æ¡å¡«å†™ä¸åŒçš„ SKU IDã€‚
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>äº¬ä¸œå•†å“ID <small class="text-muted">ï¼ˆé€‰å¡«ï¼Œä»…ç”¨äºè®°å½•ï¼‰</small></label>
                <input type="text" name="jd_product_id" class="form-control"
                       value="{{ product.jd_product_id or '' if product else '' }}"
                       placeholder="ä¾‹å¦‚ï¼š10209904245352">
            </div>
            <div class="form-group">
                <label>SKU ID * <small class="text-muted">ï¼ˆç²¾ç¡®åŒ¹é…è®¢å•ï¼Œå¡«å†™å•ä¸ªï¼‰</small></label>
                <input type="text" name="sku_id" class="form-control"
                       value="{{ product.sku_id or '' if product else '' }}"
                       placeholder="ä¾‹å¦‚ï¼š100001">
                <small class="text-muted" style="display:block;margin-top:4px;">
                    ğŸ’¡ æ¯æ¡é…ç½®åªå¡« <strong>ä¸€ä¸ª</strong> SKU IDï¼Œå¤šä¸ªè§„æ ¼è¯·åˆ†åˆ«æ–°å»ºé…ç½®
                </small>
            </div>
            <div class="form-group">
                <label>è§„æ ¼åç§° <small class="text-muted">ï¼ˆé€‰å¡«ï¼Œä¾¿äºè¯†åˆ«ï¼‰</small></label>
                <input type="text" name="sku_name" class="form-control"
                       value="{{ product.sku_name or '' if product else '' }}"
                       placeholder="ä¾‹å¦‚ï¼šæœˆå¡ / å­£å¡ / å¹´å¡">
            </div>
        </div>

        <!-- å‘è´§æ–¹å¼ -->
        <div class="section-title">ğŸšš å‘è´§æ–¹å¼</div>
        <div class="form-group">
            <label>é€‰æ‹©å‘è´§æ–¹å¼ *</label>
            <div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:6px;">
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:10px 16px;border:2px solid #d9d9d9;border-radius:6px;font-size:14px;"
                       id="label_deliver_0">
                    <input type="radio" name="deliver_type" value="0" onchange="onDeliverTypeChange()"
                           {{ 'checked' if not product or product.deliver_type == 0 }}>
                    ğŸ‘‹ æ‰‹åŠ¨å‘è´§
                </label>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:10px 16px;border:2px solid #d9d9d9;border-radius:6px;font-size:14px;"
                       id="label_deliver_1">
                    <input type="radio" name="deliver_type" value="1" onchange="onDeliverTypeChange()"
                           {{ 'checked' if product and product.deliver_type == 1 }}>
                    ğŸ« 91å¡åˆ¸å¡å¯†ï¼ˆè‡ªåŠ¨æå¡ï¼‰
                </label>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:10px 16px;border:2px solid #d9d9d9;border-radius:6px;font-size:14px;"
                       id="label_deliver_2">
                    <input type="radio" name="deliver_type" value="2" onchange="onDeliverTypeChange()"
                           {{ 'checked' if product and product.deliver_type == 2 }}>
                    âš¡ ç›´å……APIï¼ˆé¢„ç•™ï¼‰
                </label>
            </div>
        </div>

        <!-- 91å¡åˆ¸é…ç½®åŒºå— -->
        <div id="card91Section" style="display:none;">
            <div class="card mb-3" style="background:#f6ffed;border:1px solid #b7eb8f;padding:16px;border-radius:6px;">
                <div style="font-weight:bold;margin-bottom:12px;font-size:15px;">ğŸ« 91å¡åˆ¸å¡ç§é…ç½®</div>
                <div id="card91Notice" style="display:none;background:#fff7e6;border:1px solid #ffd591;padding:8px;border-radius:4px;margin-bottom:12px;font-size:13px;">
                    âš ï¸ è¯¥åº—é“ºæœªé…ç½®91å¡åˆ¸APIï¼Œè¯·å…ˆç‚¹å‡»ä¸Šæ–¹ã€Œâš™ï¸ é…ç½®91å¡åˆ¸ã€æŒ‰é’®å¡«å†™ã€‚
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å¡ç§ID <small class="text-muted">ï¼ˆ91å¡åˆ¸ä»“åº“ä¸­çš„å¡ç§IDï¼‰</small></label>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input type="text" name="card91_card_type_id" id="card91CardTypeId"
                                   class="form-control"
                                   value="{{ product.card91_card_type_id or '' if product else '' }}"
                                   placeholder="å¡«å†™å¡ç§IDï¼Œæˆ–ç‚¹å‡»å³ä¾§æŒ‰é’®ä»ä»“åº“é€‰æ‹©">
                            <button type="button" class="btn btn-sm btn-info" onclick="loadCard91Types()">ğŸ”„ è·å–å¡ç§åˆ—è¡¨</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å¡ç§åç§° <small class="text-muted">ï¼ˆè‡ªåŠ¨å¡«å…¥æˆ–æ‰‹åŠ¨å¡«å†™ï¼‰</small></label>
                        <input type="text" name="card91_card_type_name" id="card91CardTypeName"
                               class="form-control"
                               value="{{ product.card91_card_type_name or '' if product else '' }}"
                               placeholder="é€‰æ‹©å¡ç§åè‡ªåŠ¨å¡«å…¥">
                    </div>
                </div>
                <!-- å¡ç§é€‰æ‹©ä¸‹æ‹‰ -->
                <div id="card91TypesContainer" style="display:none;margin-bottom:12px;">
                    <label>ä»91å¡åˆ¸ä»“åº“é€‰æ‹©å¡ç§ï¼š</label>
                    <select id="card91TypesSelect" class="form-control" onchange="onCard91TypeSelect()">
                        <option value="">-- è¯·é€‰æ‹©å¡ç§ --</option>
                    </select>
                    <div id="card91StockInfo" style="margin-top:6px;font-size:13px;color:#666;"></div>
                </div>
                <div class="form-group">
                    <label>æ–¹æ¡ˆID <small class="text-muted">ï¼ˆé€‰å¡«ï¼‰</small></label>
                    <input type="text" name="card91_plan_id" class="form-control"
                           value="{{ product.card91_plan_id or '' if product else '' }}"
                           placeholder="ç•™ç©ºè¡¨ç¤ºä¸ç»‘å®šæ–¹æ¡ˆ">
                </div>
            </div>
        </div>

        <!-- ç›´å……APIåŒºå— -->
        <div id="directChargeSection" style="display:none;">
            <div class="card mb-3" style="background:#f9f9f9;border:1px solid #d9d9d9;padding:16px;border-radius:6px;">
                <div style="font-weight:bold;margin-bottom:8px;font-size:15px;">âš¡ ç›´å……APIï¼ˆé¢„ç•™ï¼‰</div>
                <div style="background:#fff7e6;border:1px solid #ffd591;padding:10px;border-radius:4px;font-size:13px;">
                    <strong>âš ï¸ åŠŸèƒ½é¢„ç•™ï¼š</strong>ç›´å……APIæ¥å£æ­£åœ¨å¯¹æ¥ä¸­ï¼Œå½“å‰é€‰æ‹©æ­¤æ–¹å¼çš„è®¢å•å°†ä»¥æ‰‹åŠ¨å‘è´§å¤„ç†ã€‚
                </div>
            </div>
        </div>

        <!-- å…¶ä»–è®¾ç½® -->
        <div class="section-title">âš™ï¸ å…¶ä»–è®¾ç½®</div>
        <div class="form-row">
            <div class="form-group">
                <label>çŠ¶æ€</label>
                <select name="is_enabled" class="form-control" style="width:auto;">
                    <option value="1" {{ 'selected' if not product or product.is_enabled == 1 }}>å¯ç”¨</option>
                    <option value="0" {{ 'selected' if product and product.is_enabled == 0 }}>ç¦ç”¨</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>å¤‡æ³¨</label>
            <textarea name="remark" class="form-control" rows="2"
                      placeholder="å¯å¡«å†™å•†å“å¤‡æ³¨ä¿¡æ¯">{{ product.remark or '' if product else '' }}</textarea>
        </div>

        <div class="flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
            <a href="{{ url_for('product.product_list') }}" class="btn">å–æ¶ˆ</a>
            {% if product %}
            <a href="{{ url_for('product.product_create') }}?shop_id={{ product.shop_id }}"
               class="btn btn-info" style="margin-left:auto;">
                â• ä¸ºåŒä¸€åº—é“ºå†æ·»åŠ ä¸€ä¸ªSKUé…ç½®
            </a>
            {% endif %}
        </div>
    </form>
</div>

<!-- 91å¡åˆ¸APIé…ç½®å¼¹çª— -->
<div id="card91ConfigModal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);">
    <div style="background:#fff;margin:8vh auto;padding:0;width:560px;max-width:95vw;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px;border-bottom:1px solid #e8e8e8;background:#fafafa;border-radius:8px 8px 0 0;">
            <h3 style="margin:0;font-size:16px;">âš™ï¸ 91å¡åˆ¸ APIé…ç½®</h3>
            <span onclick="closeCard91ConfigModal()" style="cursor:pointer;font-size:24px;color:#999;line-height:1;">Ã—</span>
        </div>
        <div style="padding:20px;">
            <div id="card91ConfigShopName" style="margin-bottom:12px;font-weight:bold;color:#1890ff;font-size:14px;"></div>
            <div class="form-group">
                <label>APIå¯†é’¥ï¼ˆapi_keyï¼‰<span style="color:red;">*</span></label>
                <input type="text" id="modal_card91_api_key" class="form-control" placeholder="åœ¨91å¡åˆ¸åå°-APIç®¡ç†ä¸­è·å–">
            </div>
            <div class="form-group">
                <label>APIç­¾åå¯†é’¥ï¼ˆapi_secretï¼‰<span style="color:red;">*</span> <small class="text-muted">ï¼ˆä¸å¡«åˆ™ä¿ç•™åŸæœ‰ï¼‰</small></label>
                <input type="password" id="modal_card91_api_secret" class="form-control" placeholder="åœ¨91å¡åˆ¸åå°-APIç®¡ç†ä¸­è·å–">
            </div>
            <div id="card91ConfigMsg" style="margin:8px 0;font-weight:bold;min-height:20px;"></div>
            <div style="display:flex;gap:8px;margin-top:12px;">
                <button type="button" class="btn btn-primary" onclick="saveCard91Config()">ğŸ’¾ ä¿å­˜</button>
                <button type="button" class="btn btn-info" onclick="testCard91Config()">ğŸ” æµ‹è¯•è¿æ¥</button>
                <button type="button" class="btn" onclick="closeCard91ConfigModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<script>
var currentShopId = {{ (product.shop_id if product else (default_shop_id or 0)) or 0 }};

function onShopChange() {
    var sel = document.getElementById('shopSelect');
    if (!sel) return;
    currentShopId = parseInt(sel.value) || 0;
    var opt = sel.options[sel.selectedIndex];
    var hasCard91 = opt && opt.getAttribute('data-has-card91') === '1';
    var notice = document.getElementById('card91Notice');
    if (notice) notice.style.display = hasCard91 ? 'none' : 'block';
    resetCard91Types();
}

function onDeliverTypeChange() {
    var val = document.querySelector('input[name="deliver_type"]:checked');
    var v = val ? val.value : '0';
    document.getElementById('card91Section').style.display = v === '1' ? '' : 'none';
    document.getElementById('directChargeSection').style.display = v === '2' ? '' : 'none';
    // é«˜äº®é€‰ä¸­çš„radio label
    ['0','1','2'].forEach(function(i){
        var lbl = document.getElementById('label_deliver_' + i);
        if (lbl) lbl.style.borderColor = (v === i) ? '#1890ff' : '#d9d9d9';
        if (lbl) lbl.style.background = (v === i) ? '#e6f7ff' : '';
    });
    if (v === '1') onShopChange();
}

function loadCard91Types() {
    if (!currentShopId) { alert('è¯·å…ˆé€‰æ‹©åº—é“º'); return; }
    var container = document.getElementById('card91TypesContainer');
    var sel = document.getElementById('card91TypesSelect');
    var info = document.getElementById('card91StockInfo');
    info.textContent = 'æ­£åœ¨è·å–å¡ç§åˆ—è¡¨...'; info.style.color = '#666';
    container.style.display = '';
    fetch('/product/api/card91-types/' + currentShopId)
    .then(function(r){ return r.json(); })
    .then(function(data){
        if (data.success && data.data && data.data.length > 0) {
            sel.innerHTML = '<option value="">-- è¯·é€‰æ‹©å¡ç§ï¼ˆå…±' + data.data.length + 'ä¸ªï¼‰--</option>';
            data.data.forEach(function(item){
                var o = document.createElement('option');
                o.value = item.id;
                o.textContent = item.name + 'ï¼ˆåº“å­˜ï¼š' + item.stock + 'å¼ ï¼‰';
                o.setAttribute('data-name', item.name);
                o.setAttribute('data-stock', item.stock);
                sel.appendChild(o);
            });
            info.textContent = 'âœ… å…±' + data.data.length + 'ä¸ªå¡ç§ï¼Œè¯·ä»ä¸‹æ‹‰æ¡†é€‰æ‹©';
            info.style.color = '#52c41a';
        } else {
            sel.innerHTML = '<option value="">æš‚æ— å¡ç§æ•°æ®</option>';
            info.textContent = 'âŒ ' + (data.message || 'è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥91å¡åˆ¸APIé…ç½®');
            info.style.color = '#dc3545';
        }
    })
    .catch(function(){ info.textContent = 'âŒ è¯·æ±‚å¤±è´¥'; info.style.color = '#dc3545'; });
}

function onCard91TypeSelect() {
    var sel = document.getElementById('card91TypesSelect');
    var opt = sel.options[sel.selectedIndex];
    if (!opt || !opt.value) return;
    document.getElementById('card91CardTypeId').value = opt.value;
    document.getElementById('card91CardTypeName').value = opt.getAttribute('data-name') || '';
    var stock = parseInt(opt.getAttribute('data-stock') || '0');
    var info = document.getElementById('card91StockInfo');
    info.textContent = 'å½“å‰åº“å­˜ï¼š' + stock + 'å¼ ' + (stock === 0 ? ' âš ï¸ åº“å­˜ä¸è¶³ï¼' : ' âœ…');
    info.style.color = stock > 0 ? '#52c41a' : '#dc3545';
}

function resetCard91Types() {
    var c = document.getElementById('card91TypesContainer');
    if (c) c.style.display = 'none';
    var s = document.getElementById('card91TypesSelect');
    if (s) s.innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©åº—é“ºåè·å– --</option>';
    var info = document.getElementById('card91StockInfo');
    if (info) info.textContent = '';
}

function openCard91ConfigModal() {
    if (!currentShopId) { alert('è¯·å…ˆé€‰æ‹©åº—é“º'); return; }
    var modal = document.getElementById('card91ConfigModal');
    var msg = document.getElementById('card91ConfigMsg');
    msg.textContent = 'åŠ è½½ä¸­...'; modal.style.display = 'block';
    fetch('/product/api/shop-card91-config/' + currentShopId)
    .then(function(r){ return r.json(); })
    .then(function(data){
        if (data.success) {
            document.getElementById('modal_card91_api_key').value = data.data.card91_api_key || '';
            document.getElementById('modal_card91_api_secret').value = '';
            document.getElementById('modal_card91_api_secret').placeholder = data.data.has_secret ? 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°å¡«å†™ï¼‰' : 'è¯·å¡«å†™api_secret';
            var sel = document.getElementById('shopSelect');
            var shopName = sel ? sel.options[sel.selectedIndex].text : '';
            document.getElementById('card91ConfigShopName').textContent = 'åº—é“ºï¼š' + shopName;
            msg.textContent = '';
        } else { msg.textContent = 'âŒ ' + data.message; msg.style.color = '#dc3545'; }
    })
    .catch(function(){ msg.textContent = 'âŒ åŠ è½½å¤±è´¥'; msg.style.color = '#dc3545'; });
}

function closeCard91ConfigModal() {
    document.getElementById('card91ConfigModal').style.display = 'none';
}

function saveCard91Config() {
    if (!currentShopId) return;
    var msg = document.getElementById('card91ConfigMsg');
    msg.textContent = 'ä¿å­˜ä¸­...'; msg.style.color = '#1890ff';
    fetch('/product/api/save-shop-card91/' + currentShopId, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            card91_api_key: document.getElementById('modal_card91_api_key').value.trim(),
            card91_api_secret: document.getElementById('modal_card91_api_secret').value.trim()
        })
    })
    .then(function(r){ return r.json(); })
    .then(function(data){
        if (data.success) {
            msg.textContent = 'âœ… ' + data.message; msg.style.color = '#52c41a';
            var sel = document.getElementById('shopSelect');
            if (sel) { var opt = sel.options[sel.selectedIndex]; if(opt) opt.setAttribute('data-has-card91','1'); }
            var notice = document.getElementById('card91Notice'); if(notice) notice.style.display = 'none';
        } else { msg.textContent = 'âŒ ' + data.message; msg.style.color = '#dc3545'; }
    })
    .catch(function(){ msg.textContent = 'âŒ ä¿å­˜å¤±è´¥'; msg.style.color = '#dc3545'; });
}

function testCard91Config() {
    if (!currentShopId) return;
    var msg = document.getElementById('card91ConfigMsg');
    msg.textContent = 'æµ‹è¯•ä¸­...'; msg.style.color = '#1890ff';
    fetch('/shop/card91-test/' + currentShopId)
    .then(function(r){ return r.json(); })
    .then(function(data){
        if (data.success) { msg.textContent = 'âœ… ' + data.message; msg.style.color = '#52c41a'; }
        else { msg.textContent = 'âŒ ' + data.message; msg.style.color = '#dc3545'; }
    })
    .catch(function(){ msg.textContent = 'âŒ è¯·æ±‚å¤±è´¥'; msg.style.color = '#dc3545'; });
}

document.addEventListener('DOMContentLoaded', function(){ onDeliverTypeChange(); onShopChange(); });
document.getElementById('card91ConfigModal').addEventListener('click', function(e){ if(e.target===this) closeCard91ConfigModal(); });
</script>
{% endblock %}
