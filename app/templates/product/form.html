{% extends "layouts/base.html" %}
{% block title %}{{ 'ç¼–è¾‘å•†å“é…ç½®' if product else 'æ–°å»ºå•†ï¿½ï¿½ï¿½é…ç½®' }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-title">{{ 'âœï¸ ç¼–è¾‘å•†å“é…ç½®' if product else 'ğŸ›ï¸ æ–°å»ºå•†å“é…ç½®' }}</div>

    <div class="alert alert-info mb-3" style="background:#e6f7ff;border:1px solid #91d5ff;padding:12px;border-radius:4px;font-size:13px;">
        <strong>ğŸ’¡ é…ç½®è¯´æ˜ï¼š</strong><br>
        â€¢ ä¸ºæ¯ä¸ªäº¬ä¸œå•†å“SKUè®¾ç½®å¯¹åº”çš„è‡ªåŠ¨å‘è´§æ–¹å¼<br>
        â€¢ é€‰æ‹© <strong>91å¡åˆ¸å¡å¯†</strong> åï¼Œæ”¶åˆ°è¯¥SKUçš„è®¢å•æ—¶ç³»ç»Ÿè‡ªåŠ¨ä»91å¡åˆ¸ä»“åº“æå–å¡å¯†å‘è´§<br>
        â€¢ <strong>SKU ID</strong> ç”¨äºç²¾ç¡®åŒ¹é…äº¬ä¸œæ¨é€è¿‡æ¥çš„è®¢å•ï¼Œå¯å¡«å†™å¤šä¸ªï¼ˆç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼‰ï¼Œä¸å¡«åˆ™åªåŒ¹é…å•†å“åç§°<br>
        â€¢ ä¸è®¾ç½®å‘è´§æ–¹å¼æ—¶é»˜è®¤ä¸ºæ‰‹ï¿½ï¿½å‘è´§
    </div>

    <form method="POST" id="productForm">
        <div class="section-title">ğŸ“¦ åŸºæœ¬ä¿¡æ¯</div>
        <div class="form-row">
            <div class="form-group">
                <label>æ‰€å±åº—é“º *</label>
                <div style="display:flex;gap:8px;align-items:center;">
                    <select name="shop_id" id="shopSelect" class="form-control"
                            onchange="onShopChange()" required {{ 'disabled' if product }}>
                        <option value="">è¯·é€‰æ‹©åº—é“º</option>
                        {% for shop in shops %}
                        <option value="{{ shop.id }}"
                                data-has-card91="{{ '1' if shop.card91_api_key else '0' }}"
                                {{ 'selected' if (product and product.shop_id == shop.id) or (not product and default_shop_id == shop.id) }}>
                            {{ shop.shop_name }}{% if shop.card91_api_key %} ğŸ«{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-sm btn-info" onclick="openCard91ConfigModal()">âš™ï¸ é…ç½®91å¡åˆ¸</button>
                </div>
                {% if product %}
                <input type="hidden" name="shop_id" value="{{ product.shop_id }}">
                {% endif %}
            </div>
            <div class="form-group">
                <label>å•†å“åç§° *</label>
                <input type="text" name="product_name" id="productName" class="form-control"
                       value="{{ product.product_name if product else '' }}"
                       required placeholder="ä¾‹å¦‚ï¼šçˆ±å¥‡è‰ºé»„é‡‘ä¼šå‘˜æœˆå¡">
            </div>
        </div>

        <div class="section-title">ğŸ”— äº¬ä¸œå•†å“ä¿¡æ¯</div>
        <div class="form-row">
            <div class="form-group">
                <label>äº¬ä¸œå•†å“ID <small class="text-muted">ï¼ˆé€‰å¡«ï¼‰</small></label>
                <input type="text" name="jd_product_id" id="jdProductId" class="form-control"
                       value="{{ product.jd_product_id or '' if product else '' }}"
                       placeholder="ä¾‹å¦‚ï¼š10209904245352">
            </div>
            <div class="form-group">
                <label>SKU ID <small class="text-muted">ï¼ˆç²¾ç¡®åŒ¹é…è®¢å•ï¼Œå¯å¡«å¤šä¸ªç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼‰</small></label>
                <input type="text" name="sku_id" id="skuId" class="form-control"
                       value="{{ product.sku_id or '' if product else '' }}"
                       placeholder="ä¾‹å¦‚ï¼š10209904245352,10209904245353">
                <small class="text-muted" style="display:block;margin-top:4px;">
                    ğŸ’¡ å¤šä¸ªSKU IDç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼Œå¦‚ï¼š<code>100001,100002,100003</code>
                </small>
            </div>
            <div class="form-group">
                <label>å¥—é¤/è§„æ ¼åç§°</label>
                <input type="text" name="sku_name" id="skuName" class="form-control"
                       value="{{ product.sku_name or '' if product else '' }}"
                       placeholder="ä¾‹å¦‚ï¼šæœˆå¡ / å­£å¡ / å¹´å¡">
            </div>
        </div>

        <div class="section-title">ğŸšš å‘è´§æ–¹å¼é…ç½®</div>
        <div class="form-group">
            <label>å‘è´§æ–¹å¼ *</label>
            <select name="deliver_type" id="deliverTypeSelect" class="form-control"
                    onchange="onDeliverTypeChange()" style="width:auto;">
                <option value="0" {{ 'selected' if not product or product.deliver_type == 0 }}>ğŸ‘‹ æ‰‹åŠ¨å‘è´§</option>
                <option value="1" {{ 'selected' if product and product.deliver_type == 1 }}>ğŸ« 91å¡åˆ¸å¡å¯†ï¼ˆè‡ªåŠ¨æå¡ï¼‰</option>
                <option value="2" {{ 'selected' if product and product.deliver_type == 2 }}>âš¡ ç›´å……APIï¼ˆé¢„ç•™ï¼‰</option>
            </select>
        </div>

        <div id="card91Section" style="{{ '' if (product and product.deliver_type == 1) else 'display:none;' }}">
            <div class="card mb-3" style="background:#f6ffed;border:1px solid #b7eb8f;padding:16px;border-radius:4px;">
                <div style="font-weight:bold;margin-bottom:12px;">ğŸ« 91å¡åˆ¸å¡ç§é…ç½®</div>
                <div id="card91Notice" style="display:none;background:#fff7e6;border:1px solid #ffd591;padding:8px;border-radius:4px;margin-bottom:12px;font-size:13px;">
                    âš ï¸ è¯¥åº—é“ºæœªé…ç½®91å¡åˆ¸APIå¯†é’¥ï¼Œè¯·å…ˆåœ¨
                    <a href="{{ url_for('shop.shop_list') }}" target="_blank">åº—é“ºé…ç½®</a> ä¸­å¡«å†™91å¡åˆ¸APIä¿¡æ¯ã€‚
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å¡ç§ID <small class="text-muted">ï¼ˆ91å¡åˆ¸ä»“åº“ä¸­çš„å¡ç§å”¯ä¸€æ ‡è¯†ï¼‰</small></label>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input type="text" name="card91_card_type_id" id="card91CardTypeId"
                                   class="form-control"
                                   value="{{ product.card91_card_type_id or '' if product else '' }}"
                                   placeholder="å¡«å†™å¡ç§IDï¼Œæˆ–ç‚¹å‡»å³ä¾§æŒ‰é’®è‡ªåŠ¨è·å–">
                            <button type="button" class="btn btn-sm btn-info" onclick="loadCard91Types()">ğŸ”„ è·å–å¡ç§åˆ—è¡¨</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å¡ç§åç§°</label>
                        <input type="text" name="card91_card_type_name" id="card91CardTypeName"
                               class="form-control"
                               value="{{ product.card91_card_type_name or '' if product else '' }}"
                               placeholder="å¡ç§åç§°ï¼ˆè‡ªåŠ¨å¡«å…¥æˆ–æ‰‹åŠ¨å¡«å†™ï¼‰">
                    </div>
                </div>
                <div id="card91TypesContainer" style="display:none;margin-bottom:12px;">
                    <label>ä»91å¡åˆ¸ä»“åº“é€‰æ‹©å¡ç§ï¼š</label>
                    <select id="card91TypesSelect" class="form-control" onchange="onCard91TypeSelect()">
                        <option value="">-- è¯·é€‰æ‹©å¡ç§ --</option>
                    </select>
                    <div id="card91StockInfo" style="margin-top:6px;font-size:13px;color:#666;"></div>
                </div>
                <div class="form-group">
                    <label>æ–¹æ¡ˆID <small class="text-muted">ï¼ˆé€‰å¡«ï¼‰</small></label>
                    <input type="text" name="card91_plan_id" class="form-control"
                           value="{{ product.card91_plan_id or '' if product else '' }}"
                           placeholder="ç•™ç©ºè¡¨ç¤ºä¸ç»‘å®šæ–¹æ¡ˆ">
                </div>
            </div>
        </div>

        <div id="directChargeSection" style="{{ '' if (product and product.deliver_type == 2) else 'display:none;' }}">
            <div class="card mb-3" style="background:#f9f9f9;border:1px solid #d9d9d9;padding:16px;border-radius:4px;">
                <div style="font-weight:bold;margin-bottom:12px;">âš¡ ç›´å……APIé…ç½®ï¼ˆé¢„ç•™ï¼‰</div>
                <div class="alert alert-warning" style="background:#fff7e6;border:1px solid #ffd591;padding:10px;border-radius:4px;font-size:13px;">
                    <strong>âš ï¸ åŠŸèƒ½é¢„ç•™ï¼š</strong>ç›´å……APIæ¥å£æ­£åœ¨å¯¹æ¥ä¸­ï¼Œåç»­ç‰ˆæœ¬å°†æ”¯æŒå¤šç§ç›´å……è´§æºæ–¹ã€‚å½“å‰é€‰æ‹©æ­¤æ–¹å¼çš„è®¢å•å°†ä»¥æ‰‹åŠ¨å‘è´§å¤„ç†ã€‚
                </div>
            </div>
        </div>

        <div class="section-title">âš™ï¸ å…¶ä»–è®¾ç½®</div>
        <div class="form-row">
            <div class="form-group">
                <label>çŠ¶æ€</label>
                <select name="is_enabled" class="form-control" style="width:auto;">
                    <option value="1" {{ 'selected' if not product or product.is_enabled == 1 }}>å¯ç”¨</option>
                    <option value="0" {{ 'selected' if product and product.is_enabled == 0 }}>ç¦ç”¨</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>å¤‡æ³¨</label>
            <textarea name="remark" class="form-control" rows="2" placeholder="å¯å¡«å†™å•†å“å¤‡æ³¨ä¿¡æ¯">{{ product.remark or '' if product else '' }}</textarea>
        </div>

        <div class="flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®</button>
            <a href="{{ url_for('product.product_list') }}" class="btn">å–æ¶ˆ</a>
        </div>
    </form>
</div>

<!-- 91å¡åˆ¸APIé…ç½®å¼¹çª— -->
<div id="card91ConfigModal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);overflow:auto;">
    <div style="background:#fff;margin:5vh auto;padding:0;width:600px;max-width:95vw;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:15px 20px;border-bottom:1px solid #e8e8e8;background:#fafafa;border-radius:8px 8px 0 0;">
            <h3 style="margin:0;font-size:16px;">ğŸ« 91å¡åˆ¸ APIé…ç½®</h3>
            <span onclick="closeCard91ConfigModal()" style="cursor:pointer;font-size:24px;color:#999;">Ã—</span>
        </div>
        <div style="padding:20px;">
            <div id="card91ConfigShopName" style="margin-bottom:12px;font-weight:bold;color:#1890ff;"></div>
            <div class="form-group">
                <label>APIåœ°å€ <small class="text-muted">ï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤å®˜æ–¹åœ°å€ï¼‰</small></label>
                <input type="text" id="modal_card91_api_url" class="form-control" placeholder="https://api.91kaquan.com">
            </div>
            <div class="form-group">
                <label>APIå¯†é’¥ï¼ˆapi_keyï¼‰<span style="color:red;">*</span></label>
                <input type="text" id="modal_card91_api_key" class="form-control" placeholder="åœ¨91å¡åˆ¸åå°-APIç®¡ç†ä¸­è·å–">
            </div>
            <div class="form-group">
                <label>APIç­¾åå¯†é’¥ï¼ˆapi_secretï¼‰<span style="color:red;">*</span> <small class="text-muted">ï¼ˆä¸å¡«åˆ™ä¿ç•™åŸæœ‰å¯†é’¥ï¼‰</small></label>
                <input type="password" id="modal_card91_api_secret" class="form-control" placeholder="åœ¨91å¡åˆ¸åå°-APIç®¡ç†ä¸­è·å–">
            </div>
            <div id="card91ConfigMsg" style="margin:8px 0;font-weight:bold;"></div>
            <div style="display:flex;gap:8px;margin-top:12px;">
                <button type="button" class="btn btn-primary" onclick="saveCard91Config()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <button type="button" class="btn btn-info" onclick="testCard91Config()">ğŸ” æµ‹è¯•è¿æ¥</button>
                <button type="button" class="btn" onclick="closeCard91ConfigModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<script>
var currentShopId = {{ (product.shop_id if product else (default_shop_id or 0)) or 0 }};

function onShopChange() {
    var select = document.getElementById('shopSelect');
    if (!select) return;
    currentShopId = parseInt(select.value) || 0;
    var option = select.options[select.selectedIndex];
    var hasCard91 = option && option.getAttribute('data-has-card91') === '1';
    var notice = document.getElementById('card91Notice');
    if (notice) notice.style.display = hasCard91 ? 'none' : 'block';
    resetCard91Types();
}

function onDeliverTypeChange() {
    var val = document.getElementById('deliverTypeSelect').value;
    document.getElementById('card91Section').style.display = val === '1' ? '' : 'none';
    document.getElementById('directChargeSection').style.display = val === '2' ? '' : 'none';
    if (val === '1') onShopChange();
}

function loadCard91Types() {
    if (!currentShopId) { alert('è¯·å…ˆé€‰æ‹©åº—é“º'); return; }
    var container = document.getElementById('card91TypesContainer');
    var select = document.getElementById('card91TypesSelect');
    var stockInfo = document.getElementById('card91StockInfo');
    stockInfo.textContent = 'æ­£åœ¨è·å–å¡ç§åˆ—è¡¨...';
    container.style.display = '';
    fetch('/product/api/card91-types/' + currentShopId)
    .then(function(res){ return res.json(); })
    .then(function(data){
        if (data.success && data.data && data.data.length > 0) {
            select.innerHTML = '<option value="">-- è¯·é€‰æ‹©å¡ç§ï¼ˆå…±' + data.data.length + 'ä¸ªï¼‰--</option>';
            data.data.forEach(function(item){
                var opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = item.name + 'ï¼ˆåº“å­˜ï¼š' + item.stock + 'å¼ ï¼‰';
                opt.setAttribute('data-name', item.name);
                opt.setAttribute('data-stock', item.stock);
                select.appendChild(opt);
            });
            stockInfo.textContent = 'âœ… æˆåŠŸè·å–' + data.data.length + 'ä¸ªå¡ç§';
            stockInfo.style.color = '#52c41a';
        } else {
            select.innerHTML = '<option value="">è·å–å¤±è´¥æˆ–æ— å¡ç§æ•°æ®</option>';
            stockInfo.textContent = 'âŒ ' + (data.message || 'è·å–å¤±è´¥');
            stockInfo.style.color = '#dc3545';
        }
    })
    .catch(function(){ stockInfo.textContent = 'âŒ è¯·æ±‚å¤±è´¥'; stockInfo.style.color = '#dc3545'; });
}

function onCard91TypeSelect() {
    var select = document.getElementById('card91TypesSelect');
    var option = select.options[select.selectedIndex];
    if (!option || !option.value) return;
    document.getElementById('card91CardTypeId').value = option.value;
    document.getElementById('card91CardTypeName').value = option.getAttribute('data-name') || '';
    var stock = option.getAttribute('data-stock') || '0';
    var stockInfo = document.getElementById('card91StockInfo');
    stockInfo.textContent = 'å½“å‰åº“å­˜ï¼š' + stock + 'å¼ ';
    stockInfo.style.color = parseInt(stock) > 0 ? '#52c41a' : '#dc3545';
}

function resetCard91Types() {
    var c = document.getElementById('card91TypesContainer'); if(c) c.style.display = 'none';
    var s = document.getElementById('card91TypesSelect'); if(s) s.innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©åº—é“ºåè·å– --</option>';
}

function openCard91ConfigModal() {
    if (!currentShopId) { alert('è¯·å…ˆé€‰æ‹©åº—é“º'); return; }
    var modal = document.getElementById('card91ConfigModal');
    var msg = document.getElementById('card91ConfigMsg');
    msg.textContent = 'åŠ è½½ä¸­...'; modal.style.display = 'block';
    fetch('/product/api/shop-card91-config/' + currentShopId)
    .then(function(res){ return res.json(); })
    .then(function(data){
        if (data.success) {
            document.getElementById('modal_card91_api_url').value = data.data.card91_api_url || '';
            document.getElementById('modal_card91_api_key').value = data.data.card91_api_key || '';
            document.getElementById('modal_card91_api_secret').value = '';
            var shopSelect = document.getElementById('shopSelect');
            var shopName = shopSelect ? shopSelect.options[shopSelect.selectedIndex].text : '';
            document.getElementById('card91ConfigShopName').textContent = 'åº—é“ºï¼š' + shopName;
            if (data.data.has_secret) document.getElementById('modal_card91_api_secret').placeholder = 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°å¡«å†™ï¼‰';
            msg.textContent = '';
        } else { msg.textContent = 'âŒ ' + data.message; msg.style.color = '#dc3545'; }
    })
    .catch(function(){ msg.textContent = 'âŒ åŠ è½½å¤±è´¥'; msg.style.color = '#dc3545'; });
}

function closeCard91ConfigModal() { document.getElementById('card91ConfigModal').style.display = 'none'; }

function saveCard91Config() {
    if (!currentShopId) return;
    var msg = document.getElementById('card91ConfigMsg');
    msg.textContent = 'ä¿å­˜ä¸­...'; msg.style.color = '#1890ff';
    fetch('/product/api/save-shop-card91/' + currentShopId, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            card91_api_url: document.getElementById('modal_card91_api_url').value.trim(),
            card91_api_key: document.getElementById('modal_card91_api_key').value.trim(),
            card91_api_secret: document.getElementById('modal_card91_api_secret').value.trim(),
        })
    })
    .then(function(res){ return res.json(); })
    .then(function(data){
        if (data.success) {
            msg.textContent = 'âœ… ' + data.message; msg.style.color = '#52c41a';
            var shopSelect = document.getElementById('shopSelect');
            if (shopSelect) { var opt = shopSelect.options[shopSelect.selectedIndex]; if(opt) opt.setAttribute('data-has-card91','1'); }
            var notice = document.getElementById('card91Notice'); if(notice) notice.style.display = 'none';
        } else { msg.textContent = 'âŒ ' + data.message; msg.style.color = '#dc3545'; }
    })
    .catch(function(){ msg.textContent = 'âŒ ä¿å­˜å¤±è´¥'; msg.style.color = '#dc3545'; });
}

function testCard91Config() {
    if (!currentShopId) return;
    var msg = document.getElementById('card91ConfigMsg');
    msg.textContent = 'æµ‹è¯•ä¸­...'; msg.style.color = '#1890ff';
    fetch('/shop/card91-test/' + currentShopId)
    .then(function(res){ return res.json(); })
    .then(function(data){
        if (data.success) { msg.textContent = 'âœ… ' + data.message; msg.style.color = '#52c41a'; }
        else { msg.textContent = 'âŒ ' + data.message; msg.style.color = '#dc3545'; }
    })
    .catch(function(){ msg.textContent = 'âŒ è¯·æ±‚å¤±è´¥'; msg.style.color = '#dc3545'; });
}

document.addEventListener('DOMContentLoaded', function(){ onDeliverTypeChange(); });
document.getElementById('card91ConfigModal').addEventListener('click', function(e){ if(e.target === this) closeCard91ConfigModal(); });
</script>
{% endblock %}
