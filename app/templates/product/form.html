{% extends "layouts/base.html" %}
{% block title %}{{ 'ç¼–è¾‘å•†å“é…ç½®' if product else 'æ–°å»ºå•†å“é…ç½®' }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-title">{{ 'âœï¸ ç¼–è¾‘å•†å“é…ç½®' if product else 'ğŸ›ï¸ æ–°å»ºå•†å“é…ç½®' }}</div>

    <div class="alert alert-info mb-3" style="background:#e6f7ff;border:1px solid #91d5ff;padding:12px;border-radius:4px;font-size:13px;">
        <strong>ğŸ’¡ é…ç½®è¯´æ˜ï¼š</strong><br>
        â€¢ ç²˜è´´äº¬ä¸œå•†å“é“¾æ¥è‡ªåŠ¨æå–SKU IDï¼Œå•†å“åç§°è¯·æ‰‹åŠ¨å¡«å†™æˆ–ä»è®¢å•è®°å½•å¤åˆ¶<br>
        â€¢ é€‰æ‹© <strong>91å¡åˆ¸å¡å¯†</strong> åï¼Œæ”¶åˆ°è¯¥SKUè®¢å•æ—¶ç³»ç»Ÿè‡ªåŠ¨ä»91å¡åˆ¸ä»“åº“æå–å¡å¯†å‘è´§<br>
        â€¢ ä¸€ä¸ªå•†å“å¯æœ‰å¤šä¸ªSKUï¼ˆå¦‚æœˆå¡/å­£å¡/å¹´å¡ï¼‰ï¼Œç‚¹å‡»ã€Œæ·»åŠ SKUè¡Œã€é€ä¸€é…ç½®
    </div>

    <form method="POST" id="productForm" onsubmit="return beforeSubmit()">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="section-title">ğŸ“¦ åŸºæœ¬ä¿¡æ¯</div>
        <div class="form-row">
            <div class="form-group">
                <label>æ‰€å±åº—é“º <span style="color:red">*</span></label>
                <div style="display:flex;gap:8px;align-items:center;">
                    {% if product %}
                    <input type="hidden" name="shop_id" value="{{ product.shop_id }}">
                    <input type="text" class="form-control" value="{{ product.shop.shop_name }}" disabled style="background:#f5f5f5;">
                    {% else %}
                    <select name="shop_id" id="shopSelect" class="form-control" onchange="onShopChange()" required>
                        <option value="">è¯·é€‰æ‹©åº—é“º</option>
                        {% for shop in shops %}
                        <option value="{{ shop.id }}"
                                data-has-card91="{{ '1' if shop.card91_api_key else '0' }}"
                                {{ 'selected' if default_shop_id == shop.id }}>
                            {{ shop.shop_name }}{% if shop.card91_api_key %} ğŸ«{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-sm btn-info" onclick="openCard91ConfigModal()">âš™ï¸ é…ç½®91å¡åˆ¸</button>
                    {% endif %}
                </div>
            </div>
            <div class="form-group">
                <label>å•†å“åç§° <span style="color:red">*</span></label>
                <input type="text" name="product_name" id="productName" class="form-control"
                       value="{{ product.product_name if product else '' }}"
                       required placeholder="ä¾‹å¦‚ï¼šçˆ±å¥‡è‰ºé»„é‡‘ä¼šå‘˜">
            </div>
        </div>

        <!-- äº¬ä¸œé“¾æ¥è§£æ -->
        <div class="form-group" style="background:#f6ffed;border:1px solid #b7eb8f;padding:12px;border-radius:4px;margin-bottom:16px;">
            <label style="font-weight:bold;">ğŸ”— äº¬ä¸œå•†å“é“¾æ¥è§£æ</label>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
                <input type="text" id="jdUrlInput" class="form-control"
                       placeholder="ç²˜è´´äº¬ä¸œé“¾æ¥è‡ªåŠ¨æå–SKU IDï¼Œå¦‚ï¼šhttps://item.jd.com/100011935867.html">
                <button type="button" class="btn btn-sm btn-success" onclick="parseJdUrl()">ğŸ” æå–</button>
                <button type="button" class="btn btn-sm" onclick="document.getElementById('jdUrlInput').value=''">æ¸…ç©º</button>
            </div>
            <div id="jdUrlMsg" style="margin-top:6px;font-size:12px;color:#888;">
                ğŸ’¡ æç¤ºï¼šäº¬ä¸œå•†å“é¡µå·²å…¨é¢JSæ¸²æŸ“ï¼Œæ— æ³•è‡ªåŠ¨è·å–å•†å“åç§°ï¼Œè¯·æ‰‹åŠ¨å¡«å†™å•†å“åç§°å’Œå¥—é¤å
            </div>
        </div>

        <!-- å‘è´§æ–¹å¼ -->
        <div class="section-title">ğŸšš å‘è´§æ–¹å¼</div>
        <div class="form-group">
            <select name="deliver_type" id="deliverTypeSelect" class="form-control"
                    onchange="onDeliverTypeChange()" style="width:auto;">
                <option value="0" {{ 'selected' if not product or product.deliver_type == 0 }}>ğŸ‘‹ æ‰‹åŠ¨å‘è´§</option>
                <option value="1" {{ 'selected' if product and product.deliver_type == 1 }}>ğŸ« 91å¡åˆ¸å¡å¯†ï¼ˆè‡ªåŠ¨æå¡ï¼‰</option>
                <option value="2" {{ 'selected' if product and product.deliver_type == 2 }}>âš¡ ç›´å……APIï¼ˆé¢„ç•™ï¼‰</option>
            </select>
        </div>

        <!-- SKUåˆ—è¡¨é…ç½® -->
        <div class="section-title">ğŸ“‹ SKUé…ç½®åˆ—è¡¨</div>
        <div style="margin-bottom:8px;font-size:13px;color:#666;">æ¯ä¸ªSKUå¯¹åº”äº¬ä¸œå•†å“çš„ä¸€ä¸ªè§„æ ¼ï¼Œå¦‚æœˆå¡/å­£å¡/å¹´å¡ï¼Œåˆ†åˆ«å¡«å†™SKU IDå’Œå¥—é¤å</div>

        <div id="skuList" style="border:1px solid #e8e8e8;border-radius:4px;overflow:hidden;margin-bottom:12px;">
            <!-- SKUè¡Œå¤´éƒ¨ -->
            <div style="display:grid;grid-template-columns:160px 1fr 120px 40px;gap:0;background:#fafafa;border-bottom:1px solid #e8e8e8;padding:8px 12px;font-weight:bold;font-size:13px;">
                <div>SKU ID <span style="color:red">*</span></div>
                <div>å¥—é¤/è§„æ ¼åç§°</div>
                <div id="card91ColHeader" style="{{ '' if (product and product.deliver_type == 1) else 'display:none' }}">å¡ç§</div>
                <div></div>
            </div>
            <div id="skuRows">
                <!-- åŠ¨æ€ç”ŸæˆSKUè¡Œ -->
            </div>
        </div>

        <button type="button" class="btn btn-sm btn-info" onclick="addSkuRow()">â• æ·»åŠ SKUè¡Œ</button>

        <!-- 91å¡åˆ¸é…ç½®è¯´æ˜ï¼ˆä»…å‘è´§æ–¹å¼=1æ—¶æ˜¾ç¤ºï¼‰ -->
        <div id="card91Section" style="{{ '' if (product and product.deliver_type == 1) else 'display:none;' }}margin-top:12px;">
            <div style="background:#f6ffed;border:1px solid #b7eb8f;padding:10px 14px;border-radius:4px;font-size:12px;">
                <strong>ğŸ« 91å¡åˆ¸è¯´æ˜ï¼š</strong>ç‚¹å‡»å„SKUè¡Œçš„ã€Œé€‰å¡ç§ã€æŒ‰é’®ï¼Œä»91å¡åˆ¸ä»“åº“é€‰æ‹©å¯¹åº”å¡ç§ï¼›
                æˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰¹é‡åŠ è½½å¡ç§åˆ—è¡¨ã€‚<br>
                <div id="card91Notice" style="display:none;color:#d46b08;margin-top:4px;">
                    âš ï¸ è¯¥åº—é“ºæœªé…ç½®91å¡åˆ¸APIå¯†é’¥ï¼Œè¯·å…ˆ
                    <a href="javascript:openCard91ConfigModal()">é…ç½®91å¡åˆ¸</a>
                </div>
                <button type="button" class="btn btn-sm btn-info" style="margin-top:8px;" onclick="loadCard91Types()">ğŸ”„ åŠ è½½å¡ç§åˆ—è¡¨</button>
                <span id="card91LoadStatus" style="margin-left:8px;font-size:12px;color:#666;"></span>
            </div>
        </div>

        <!-- å…¶ä»–è®¾ç½® -->
        <div class="section-title" style="margin-top:16px;">âš™ï¸ å…¶ä»–è®¾ç½®</div>
        <div class="form-row">
            <div class="form-group">
                <label>äº¬ä¸œå•†å“ID <small class="text-muted">ï¼ˆé€‰å¡«ï¼‰</small></label>
                <input type="text" name="jd_product_id" id="jdProductId" class="form-control"
                       value="{{ product.jd_product_id or '' if product else '' }}"
                       placeholder="å•†å“å¤§IDï¼ˆéSKU IDï¼‰">
            </div>
            <div class="form-group">
                <label>91å¡åˆ¸æ–¹æ¡ˆID <small class="text-muted">ï¼ˆé€‰å¡«ï¼‰</small></label>
                <input type="text" name="card91_plan_id" class="form-control"
                       value="{{ product.card91_plan_id or '' if product else '' }}"
                       placeholder="ç•™ç©ºä¸ç»‘å®šæ–¹æ¡ˆ">
            </div>
            <div class="form-group">
                <label>çŠ¶æ€</label>
                <select name="is_enabled" class="form-control" style="width:auto;">
                    <option value="1" {{ 'selected' if not product or product.is_enabled == 1 }}>å¯ç”¨</option>
                    <option value="0" {{ 'selected' if product and product.is_enabled == 0 }}>ç¦ç”¨</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>å¤‡æ³¨</label>
            <textarea name="remark" class="form-control" rows="2"
                      placeholder="å¯å¡«å†™å¤‡æ³¨ä¿¡æ¯">{{ product.remark or '' if product else '' }}</textarea>
        </div>

        <!-- éšè—å­—æ®µï¼šå®é™…æäº¤çš„SKUä¿¡æ¯ï¼ˆç¬¬ä¸€ä¸ªSKUï¼‰ -->
        <input type="hidden" name="sku_id" id="hiddenSkuId" value="{{ product.sku_id or '' if product else '' }}">
        <input type="hidden" name="sku_name" id="hiddenSkuName" value="{{ product.sku_name or '' if product else '' }}">
        <input type="hidden" name="card91_card_type_id" id="hiddenCard91TypeId" value="{{ product.card91_card_type_id or '' if product else '' }}">
        <input type="hidden" name="card91_card_type_name" id="hiddenCard91TypeName" value="{{ product.card91_card_type_name or '' if product else '' }}">

        <div class="flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary" id="submitBtn">ğŸ’¾ ä¿å­˜é…ç½®</button>
            <a href="{{ url_for('product.product_list') }}" class="btn">å–æ¶ˆ</a>
        </div>
    </form>
</div>

<!-- å¡ç§é€‰æ‹©å¼¹çª— -->
<div id="card91SelectModal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);">
    <div style="background:#fff;margin:8vh auto;padding:0;width:560px;max-width:95vw;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px;border-bottom:1px solid #e8e8e8;background:#fafafa;border-radius:8px 8px 0 0;">
            <h3 style="margin:0;font-size:15px;">ğŸ« é€‰æ‹©91å¡åˆ¸å¡ç§</h3>
            <span onclick="closeCard91SelectModal()" style="cursor:pointer;font-size:22px;color:#999;">Ã—</span>
        </div>
        <div style="padding:16px;">
            <div id="card91SelectList" style="max-height:400px;overflow-y:auto;">
                <div style="text-align:center;color:#999;padding:20px;">ç‚¹å‡»ã€ŒåŠ è½½å¡ç§åˆ—è¡¨ã€åå†é€‰æ‹©</div>
            </div>
            <div style="margin-top:12px;text-align:right;">
                <button type="button" class="btn" onclick="closeCard91SelectModal()">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<!-- 91å¡åˆ¸APIé…ç½®å¼¹çª— -->
<div id="card91ConfigModal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);">
    <div style="background:#fff;margin:6vh auto;padding:0;width:560px;max-width:95vw;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px;border-bottom:1px solid #e8e8e8;background:#fafafa;border-radius:8px 8px 0 0;">
            <h3 style="margin:0;font-size:15px;">âš™ï¸ é…ç½®91å¡åˆ¸API</h3>
            <span onclick="closeCard91ConfigModal()" style="cursor:pointer;font-size:22px;color:#999;">Ã—</span>
        </div>
        <div style="padding:20px;">
            <div id="card91ConfigShopName" style="margin-bottom:12px;font-weight:bold;color:#1890ff;"></div>
            <div class="form-group">
                <label>APIåœ°å€ <small>(ç•™ç©ºç”¨å®˜æ–¹é»˜è®¤)</small></label>
                <input type="text" id="modal_card91_api_url" class="form-control" placeholder="https://api.91kaquan.com">
            </div>
            <div class="form-group">
                <label>APIå¯†é’¥(api_key) <span style="color:red">*</span></label>
                <input type="text" id="modal_card91_api_key" class="form-control" placeholder="åœ¨91å¡åˆ¸åå°è·å–">
            </div>
            <div class="form-group">
                <label>APIç­¾åå¯†é’¥(api_secret) <small>(ä¸å¡«ä¿ç•™åŸæœ‰)</small></label>
                <input type="password" id="modal_card91_api_secret" class="form-control" placeholder="åœ¨91å¡åˆ¸åå°è·å–">
            </div>
            <div id="card91ConfigMsg" style="margin:8px 0;font-weight:bold;min-height:20px;"></div>
            <div style="display:flex;gap:8px;">
                <button type="button" class="btn btn-primary" onclick="saveCard91Config()">ğŸ’¾ ä¿å­˜</button>
                <button type="button" class="btn btn-info" onclick="testCard91Config()">ğŸ” æµ‹è¯•è¿æ¥</button>
                <button type="button" class="btn" onclick="closeCard91ConfigModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============ å…¨å±€çŠ¶æ€ ============
var currentShopId = {{ (product.shop_id if product else (default_shop_id or 0)) or 0 }};
var card91Types = [];  // å·²åŠ è½½çš„å¡ç§åˆ—è¡¨
var currentSelectRowIndex = -1;  // å½“å‰æ­£åœ¨é€‰å¡ç§çš„è¡Œç´¢å¼•

// ============ SKUè¡Œç®¡ç† ============
var skuRows = [];  // [{skuId, skuName, card91TypeId, card91TypeName}]

// åˆå§‹åŒ–SKUè¡Œæ•°æ®ï¼ˆä»å·²æœ‰å•†å“åŠ è½½ï¼‰
var initSkuId = "{{ product.sku_id or '' if product else '' }}";
var initSkuName = "{{ product.sku_name or '' if product else '' }}";
var initCard91TypeId = "{{ product.card91_card_type_id or '' if product else '' }}";
var initCard91TypeName = "{{ product.card91_card_type_name or '' if product else '' }}";

function renderSkuRows() {
    var container = document.getElementById('skuRows');
    var deliverType = document.getElementById('deliverTypeSelect').value;
    var showCard91 = deliverType === '1';

    if (skuRows.length === 0) {
        container.innerHTML = '<div style="padding:16px;text-align:center;color:#999;font-size:13px;">æš‚æ— SKUé…ç½®ï¼Œè¯·ç‚¹å‡»ã€Œæ·»åŠ SKUè¡Œã€æˆ–ç²˜è´´äº¬ä¸œé“¾æ¥è‡ªåŠ¨æå–</div>';
        return;
    }

    var html = '';
    skuRows.forEach(function(row, idx) {
        html += '<div class="sku-row" data-idx="' + idx + '" style="display:grid;grid-template-columns:160px 1fr ' + (showCard91 ? '200px ' : '') + '40px;gap:0;border-bottom:1px solid #f0f0f0;padding:8px 12px;align-items:center;">';
        html += '<div><input type="text" class="form-control form-control-sm" placeholder="SKU ID" value="' + escHtml(row.skuId) + '" onchange="updateRow(' + idx + ',\'skuId\',this.value)" style="font-family:monospace;"></div>';
        html += '<div style="padding:0 8px;"><input type="text" class="form-control form-control-sm" placeholder="å¥—é¤åç§°ï¼Œå¦‚ï¼šæœˆå¡" value="' + escHtml(row.skuName) + '" onchange="updateRow(' + idx + ',\'skuName\',this.value)"></div>';
        if (showCard91) {
            var cardLabel = row.card91TypeId ? (row.card91TypeName || row.card91TypeId) : 'æœªé€‰æ‹©';
            var cardColor = row.card91TypeId ? '#52c41a' : '#999';
            html += '<div style="padding:0 4px;">';
            html += '<div style="font-size:12px;color:' + cardColor + ';margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="' + escHtml(cardLabel) + '">' + escHtml(cardLabel.length > 10 ? cardLabel.substring(0,10)+'â€¦' : cardLabel) + '</div>';
            html += '<button type="button" class="btn btn-xs btn-info" style="font-size:11px;padding:1px 6px;" onclick="openCard91SelectForRow(' + idx + ')">é€‰å¡ç§</button>';
            html += '</div>';
        }
        html += '<div style="text-align:center;"><button type="button" onclick="removeSkuRow(' + idx + ')" style="background:none;border:none;color:#ff4d4f;font-size:16px;cursor:pointer;padding:0 4px;">Ã—</button></div>';
        html += '</div>';
    });
    container.innerHTML = html;
}

function addSkuRow(skuId, skuName) {
    skuRows.push({
        skuId: skuId || '',
        skuName: skuName || '',
        card91TypeId: '',
        card91TypeName: ''
    });
    renderSkuRows();
}

function removeSkuRow(idx) {
    skuRows.splice(idx, 1);
    renderSkuRows();
}

function updateRow(idx, field, value) {
    if (skuRows[idx]) skuRows[idx][field] = value;
}

function escHtml(str) {
    return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============ äº¬ä¸œé“¾æ¥è§£æ ============
function parseJdUrl() {
    var url = document.getElementById('jdUrlInput').value.trim();
    var msgEl = document.getElementById('jdUrlMsg');
    if (!url) { msgEl.textContent = 'è¯·è¾“å…¥äº¬ä¸œå•†å“é“¾æ¥'; msgEl.style.color='#dc3545'; return; }

    var skuId = '', productId = '';
    try {
        var urlObj = new URL(url);
        // https://item.jd.com/123456.html
        var m = urlObj.pathname.match(/\/(\d+)\.html/);
        if (m) { skuId = m[1]; productId = m[1]; }
        // ?skuId=xxx ä¼˜å…ˆ
        var paramSku = urlObj.searchParams.get('skuId') || urlObj.searchParams.get('id');
        if (paramSku && /^\d+$/.test(paramSku)) skuId = paramSku;
    } catch(e) {
        var m2 = url.match(/\/(\d{6,13})\.html/);
        if (m2) { skuId = m2[1]; productId = m2[1]; }
    }

    if (skuId) {
        // å¡«å……å•†å“å¤§ID
        if (productId) document.getElementById('jdProductId').value = productId;
        // æ·»åŠ åˆ°SKUè¡Œ
        addSkuRow(skuId, '');
        msgEl.textContent = 'âœ… å·²æå–SKU IDï¼š' + skuId + 'ï¼Œå·²æ·»åŠ åˆ°SKUåˆ—è¡¨ï¼Œè¯·æ‰‹åŠ¨å¡«å†™å¥—é¤åç§°';
        msgEl.style.color = '#52c41a';
        document.getElementById('jdUrlInput').value = '';
    } else {
        msgEl.textContent = 'âŒ æ— æ³•æå–SKU IDï¼Œè¯·æ£€æŸ¥é“¾æ¥æ ¼å¼';
        msgEl.style.color = '#dc3545';
    }
}

// ============ å‘è´§æ–¹å¼åˆ‡æ¢ ============
function onDeliverTypeChange() {
    var val = document.getElementById('deliverTypeSelect').value;
    var card91Sec = document.getElementById('card91Section');
    var card91Header = document.getElementById('card91ColHeader');
    if (card91Sec) card91Sec.style.display = val === '1' ? '' : 'none';
    if (card91Header) card91Header.style.display = val === '1' ? '' : 'none';
    renderSkuRows();
    if (val === '1') checkCard91Config();
}

function onShopChange() {
    var select = document.getElementById('shopSelect');
    if (!select) return;
    currentShopId = parseInt(select.value) || 0;
    card91Types = [];
    document.getElementById('card91LoadStatus').textContent = '';
    checkCard91Config();
}

function checkCard91Config() {
    if (!currentShopId) return;
    var select = document.getElementById('shopSelect');
    if (!select) return;
    var opt = select.options[select.selectedIndex];
    var hasCard91 = opt && opt.getAttribute('data-has-card91') === '1';
    var notice = document.getElementById('card91Notice');
    if (notice) notice.style.display = hasCard91 ? 'none' : 'block';
}

// ============ 91å¡åˆ¸å¡ç§åŠ è½½ ============
function loadCard91Types() {
    if (!currentShopId) { alert('è¯·å…ˆé€‰æ‹©åº—é“º'); return; }
    var status = document.getElementById('card91LoadStatus');
    status.textContent = 'åŠ è½½ä¸­...'; status.style.color='#1890ff';

    fetch('/product/api/card91-types/' + currentShopId)
    .then(function(r){ return r.json(); })
    .then(function(data) {
        if (data.success && data.data && data.data.length > 0) {
            card91Types = data.data;
            status.textContent = 'âœ… å·²åŠ è½½ ' + data.data.length + ' ä¸ªå¡ç§';
            status.style.color = '#52c41a';
            renderCard91SelectList();
        } else {
            status.textContent = 'âŒ ' + (data.message || 'è·å–å¤±è´¥');
            status.style.color = '#dc3545';
        }
    })
    .catch(function(){ status.textContent = 'âŒ è¯·æ±‚å¤±è´¥'; status.style.color='#dc3545'; });
}

function renderCard91SelectList() {
    var container = document.getElementById('card91SelectList');
    if (!card91Types || card91Types.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— å¡ç§ï¼Œè¯·å…ˆåŠ è½½</div>';
        return;
    }
    var html = '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
    html += '<tr style="background:#fafafa;"><th style="padding:6px 10px;text-align:left;border-bottom:1px solid #e8e8e8;">å¡ç§åç§°</th><th style="padding:6px 10px;text-align:center;border-bottom:1px solid #e8e8e8;">åº“å­˜</th><th style="padding:6px 10px;text-align:center;border-bottom:1px solid #e8e8e8;">æ“ä½œ</th></tr>';
    card91Types.forEach(function(item) {
        var stockColor = parseInt(item.stock) > 0 ? '#52c41a' : '#dc3545';
        html += '<tr style="border-bottom:1px solid #f5f5f5;">';
        html += '<td style="padding:8px 10px;">' + escHtml(item.name) + '<br><small style="color:#999;">ID: ' + escHtml(item.id) + '</small></td>';
        html += '<td style="padding:8px 10px;text-align:center;color:' + stockColor + ';">' + escHtml(String(item.stock)) + '</td>';
        html += '<td style="padding:8px 10px;text-align:center;"><button type="button" class="btn btn-sm btn-primary" onclick="selectCard91Type(\'' + escHtml(item.id) + '\',\'' + escHtml(item.name) + '\')">é€‰æ‹©</button></td>';
        html += '</tr>';
    });
    html += '</table>';
    container.innerHTML = html;
}

function openCard91SelectForRow(idx) {
    if (card91Types.length === 0 && currentShopId) {
        loadCard91Types();
    }
    currentSelectRowIndex = idx;
    renderCard91SelectList();
    document.getElementById('card91SelectModal').style.display = 'block';
}

function closeCard91SelectModal() {
    document.getElementById('card91SelectModal').style.display = 'none';
    currentSelectRowIndex = -1;
}

function selectCard91Type(typeId, typeName) {
    if (currentSelectRowIndex >= 0 && skuRows[currentSelectRowIndex]) {
        skuRows[currentSelectRowIndex].card91TypeId = typeId;
        skuRows[currentSelectRowIndex].card91TypeName = typeName;
        renderSkuRows();
    }
    closeCard91SelectModal();
}

// ============ è¡¨å•æäº¤ ============
function beforeSubmit() {
    // ç¬¬ä¸€æ­¥ï¼šä»DOMåŒæ­¥æ–‡æœ¬è¾“å…¥æ¡†çš„æœ€æ–°å€¼åˆ°skuRowsï¼ˆåªåŒæ­¥æ–‡æœ¬è¾“å…¥ï¼Œä¸è¦†ç›–card91æ•°æ®ï¼‰
    var rows = document.querySelectorAll('.sku-row');
    rows.forEach(function(rowEl) {
        var idx = parseInt(rowEl.getAttribute('data-idx'));
        if (!skuRows[idx]) return;
        var inputs = rowEl.querySelectorAll('input[type=text]');
        // inputs[0]=SKU ID, inputs[1]=å¥—é¤åï¼Œcard91æ•°æ®åœ¨skuRowsä¸­ç»´æŠ¤ï¼Œä¸ä»DOMè¯»
        if (inputs[0]) skuRows[idx].skuId = inputs[0].value.trim();
        if (inputs[1]) skuRows[idx].skuName = inputs[1].value.trim();
        // card91TypeId / card91TypeName ç”± selectCard91Type() å†™å…¥ skuRowsï¼Œä¸ä»DOMè¯»å–
    });

    // ç¬¬äºŒæ­¥ï¼šéªŒè¯è‡³å°‘æœ‰ä¸€è¡Œå¡«äº†SKU ID
    var validRows = skuRows.filter(function(r){ return r.skuId && r.skuId.trim(); });
    if (validRows.length === 0) {
        alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªSKUé…ç½®ï¼ˆå¡«å†™SKU IDï¼‰');
        return false;
    }

    // ç¬¬ä¸‰æ­¥ï¼šå–ç¬¬ä¸€ä¸ªæœ‰æ•ˆè¡Œå†™å…¥hiddenå­—æ®µæäº¤
    var first = validRows[0];
    document.getElementById('hiddenSkuId').value = first.skuId || '';
    document.getElementById('hiddenSkuName').value = first.skuName || '';
    document.getElementById('hiddenCard91TypeId').value = first.card91TypeId || '';
    document.getElementById('hiddenCard91TypeName').value = first.card91TypeName || '';

    console.log('[ä¿å­˜] SKU ID:', first.skuId, 
                'å¥—é¤å:', first.skuName,
                'å¡ç§ID:', first.card91TypeId, 
                'å¡ç§å:', first.card91TypeName);
    return true;
}

// ============ 91å¡åˆ¸APIé…ç½®å¼¹çª— ============
function openCard91ConfigModal() {
    if (!currentShopId) { alert('è¯·å…ˆé€‰æ‹©åº—é“º'); return; }
    document.getElementById('card91ConfigModal').style.display = 'block';
    var msg = document.getElementById('card91ConfigMsg');
    msg.textContent = 'åŠ è½½ä¸­...'; msg.style.color='#1890ff';

    fetch('/product/api/shop-card91-config/' + currentShopId)
    .then(function(r){ return r.json(); })
    .then(function(data) {
        if (data.success) {
            document.getElementById('modal_card91_api_url').value = data.data.card91_api_url || '';
            document.getElementById('modal_card91_api_key').value = data.data.card91_api_key || '';
            document.getElementById('modal_card91_api_secret').value = '';
            document.getElementById('modal_card91_api_secret').placeholder = data.data.has_secret ? 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°å¡«å†™ï¼‰' : 'è¯·å¡«å†™';
            var sel = document.getElementById('shopSelect');
            var shopName = sel ? sel.options[sel.selectedIndex].text : '';
            document.getElementById('card91ConfigShopName').textContent = 'åº—é“ºï¼š' + shopName;
            msg.textContent = '';
        } else {
            msg.textContent = 'âŒ ' + data.message; msg.style.color='#dc3545';
        }
    });
}

function closeCard91ConfigModal() {
    document.getElementById('card91ConfigModal').style.display = 'none';
}

function saveCard91Config() {
    var msg = document.getElementById('card91ConfigMsg');
    msg.textContent = 'ä¿å­˜ä¸­...'; msg.style.color='#1890ff';
    fetch('/product/api/save-shop-card91/' + currentShopId, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            card91_api_url: document.getElementById('modal_card91_api_url').value.trim(),
            card91_api_key: document.getElementById('modal_card91_api_key').value.trim(),
            card91_api_secret: document.getElementById('modal_card91_api_secret').value.trim(),
        })
    }).then(function(r){ return r.json(); })
    .then(function(data) {
        if (data.success) {
            msg.textContent = 'âœ… ' + data.message; msg.style.color='#52c41a';
            var sel = document.getElementById('shopSelect');
            if (sel) sel.options[sel.selectedIndex].setAttribute('data-has-card91','1');
            var notice = document.getElementById('card91Notice');
            if (notice) notice.style.display = 'none';
        } else {
            msg.textContent = 'âŒ ' + data.message; msg.style.color='#dc3545';
        }
    });
}

function testCard91Config() {
    var msg = document.getElementById('card91ConfigMsg');
    msg.textContent = 'æµ‹è¯•ä¸­...'; msg.style.color='#1890ff';
    fetch('/shop/card91-test/' + currentShopId)
    .then(function(r){ return r.json(); })
    .then(function(data) {
        msg.textContent = (data.success ? 'âœ… ' : 'âŒ ') + data.message;
        msg.style.color = data.success ? '#52c41a' : '#dc3545';
    });
}

// ============ åˆå§‹åŒ– ============
document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½å·²æœ‰SKUæ•°æ®
    if (initSkuId) {
        skuRows.push({
            skuId: initSkuId,
            skuName: initSkuName,
            card91TypeId: initCard91TypeId,
            card91TypeName: initCard91TypeName
        });
    }
    renderSkuRows();
    onDeliverTypeChange();

    // äº¬ä¸œé“¾æ¥ç²˜è´´è‡ªåŠ¨è§£æ
    var urlInput = document.getElementById('jdUrlInput');
    urlInput.addEventListener('paste', function(e) {
        var text = e.clipboardData ? e.clipboardData.getData('text') : null;
        if (text) { e.preventDefault(); this.value = text; }
        setTimeout(parseJdUrl, 0);
    });
    urlInput.addEventListener('input', function() {
        if (this.value.indexOf('jd.com') !== -1) setTimeout(parseJdUrl, 300);
    });

    // ç‚¹å‡»å¤–éƒ¨å…³é—­å¼¹çª—
    document.getElementById('card91SelectModal').addEventListener('click', function(e){
        if (e.target === this) closeCard91SelectModal();
    });
    document.getElementById('card91ConfigModal').addEventListener('click', function(e){
        if (e.target === this) closeCard91ConfigModal();
    });
});
</script>
{% endblock %}
