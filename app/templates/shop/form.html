{% extends "layouts/base.html" %}
{% block title %}{{ '编辑店铺' if shop else '新建店铺' }}{% endblock %}

{% block content %}

<div class="card mb-4" style="background: #f0f8ff; border-left: 4px solid #1890ff;">
    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
        <span>📋 提交给京东官方的固定接口信息</span>
        <button type="button" class="btn btn-sm" onclick="copyAllInfo()" style="background: #52c41a; color: white;">📑 一键复制全部</button>
    </div>
    <div class="alert alert-warning mb-3" style="background: #fff7e6; border: 1px solid #ffd591; padding: 10px; border-radius: 4px;">
        <strong>⚠️ 重要：</strong>以下是固定接口信息，提供给所有客户申请京东接口时使用。
    </div>
    <div id="fixedApiInfo">
        <div class="info-row">
            <strong>服务器IP白名单：</strong>
            <span class="info-value">{{ request.host.split(':')[0] }}</span>
            <button class="btn-copy" onclick="copyText('{{ request.host.split(\':\')[0] }}')">📋 复制</button>
        </div>
        <hr style="margin: 15px 0; border-top: 1px solid #d9d9d9;">
        <div class="section-subtitle">🎮 游戏点卡接口配置</div>
        <div class="info-row">
            <strong>2.2.1 直充接单接口：</strong>
            <span class="info-value">{{ request.scheme }}://{{ request.host }}/api/game/direct</span>
            <button class="btn-copy" onclick="copyText('{{ request.scheme }}://{{ request.host }}/api/game/direct')">📋 复制</button>
        </div>
        <div class="info-row">
            <strong>2.2.2 直充订单查询：</strong>
            <span class="info-value">{{ request.scheme }}://{{ request.host }}/api/game/query</span>
            <button class="btn-copy" onclick="copyText('{{ request.scheme }}://{{ request.host }}/api/game/query')">📋 复制</button>
        </div>
        <div class="info-row">
            <strong>2.3.1 卡密接单接口：</strong>
            <span class="info-value">{{ request.scheme }}://{{ request.host }}/api/game/card</span>
            <button class="btn-copy" onclick="copyText('{{ request.scheme }}://{{ request.host }}/api/game/card')">📋 复制</button>
        </div>
        <div class="info-row">
            <strong>2.3.2 卡密订单查询：</strong>
            <span class="info-value">{{ request.scheme }}://{{ request.host }}/api/game/card-query</span>
            <button class="btn-copy" onclick="copyText('{{ request.scheme }}://{{ request.host }}/api/game/card-query')">📋 复制</button>
        </div>
        <hr style="margin: 15px 0; border-top: 1px solid #d9d9d9;">
        <div class="section-subtitle">🏪 通用交易接口配置</div>
        <div class="info-row">
            <strong>充值/提取卡密接口：</strong>
            <span class="info-value">{{ request.scheme }}://{{ request.host }}/api/general/distill</span>
            <button class="btn-copy" onclick="copyText('{{ request.scheme }}://{{ request.host }}/api/general/distill')">📋 复制</button>
        </div>
        <div class="info-row">
            <strong>反查订单接口：</strong>
            <span class="info-value">{{ request.scheme }}://{{ request.host }}/api/general/query</span>
            <button class="btn-copy" onclick="copyText('{{ request.scheme }}://{{ request.host }}/api/general/query')">📋 复制</button>
        </div>
        <hr style="margin: 15px 0; border-top: 1px solid #d9d9d9;">
        <div class="alert alert-info mb-0" style="background: #e6f7ff; border: 1px solid #91d5ff; padding: 10px; border-radius: 4px;">
            <strong>📝 使用说明：</strong><br>
            • 所有客户使用相同的固定接口地址<br>
            • 客户申请下来后，京东会分配：<strong>商家ID</strong> 和 <strong>MD5密钥</strong><br>
            • 客户拿到密钥后，在下方对应位置填写即可<br>
            • 京东推送订单时会携带店铺标识（shop_code 或 shop_id），系统自动识别
        </div>
    </div>
</div>

<style>
.info-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
.info-row:last-child { border-bottom: none; }
.info-row strong { min-width: 200px; color: #333; font-size: 14px; }
.info-value { flex: 1; color: #1890ff; font-family: 'Courier New', monospace; font-size: 13px; word-break: break-all; }
.btn-copy { margin-left: 10px; padding: 4px 12px; background: #52c41a; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; }
.btn-copy:hover { background: #389e0d; }
.section-subtitle { font-weight: bold; color: #1890ff; margin: 15px 0 10px 0; font-size: 16px; }
</style>

<script>
function copyText(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => { showToast('✅ 已复制：' + text); }).catch(() => { fallbackCopy(text); });
    } else { fallbackCopy(text); }
}
function fallbackCopy(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text; textarea.style.position = 'fixed'; textarea.style.opacity = '0';
    document.body.appendChild(textarea); textarea.select();
    try { document.execCommand('copy'); showToast('✅ 已复制：' + text); } catch (err) { showToast('❌ 复制失败，请手动复制'); }
    document.body.removeChild(textarea);
}
function copyAllInfo() {
    const text = `服务器IP白名单：{{ request.host.split(':')[0] }}

🎮 游戏点卡接口配置
2.2.1 直充接单接口：{{ request.scheme }}://{{ request.host }}/api/game/direct
2.2.2 直充订单查询：{{ request.scheme }}://{{ request.host }}/api/game/query
2.3.1 卡密接单接口：{{ request.scheme }}://{{ request.host }}/api/game/card
2.3.2 卡密订单查询：{{ request.scheme }}://{{ request.host }}/api/game/card-query

🏪 通用交易接口配置
充值/提取卡密接口：{{ request.scheme }}://{{ request.host }}/api/general/distill
反查订单接口：{{ request.scheme }}://{{ request.host }}/api/general/query`;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => { showToast('✅ 已复制全部接口信息到剪贴板'); }).catch(() => { fallbackCopy(text); });
    } else { fallbackCopy(text); }
}
function showToast(message) {
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;top:80px;right:20px;background:#52c41a;color:white;padding:15px 20px;border-radius:4px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.15);font-size:14px;';
    toast.textContent = message; document.body.appendChild(toast);
    setTimeout(() => { toast.style.transition = 'opacity 0.3s'; toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2500);
}
</script>

<div class="card">
    <div class="card-title">{{ '✏️ 编辑店铺配置' if shop else '🏪 新建店铺' }}</div>

    {% if shop %}
    <div class="alert alert-info mb-3" style="background: #e6f7ff; border: 1px solid #91d5ff; padding: 10px;">
        <strong>💡 提示：</strong>客户申请到京东密钥后，请在下方对应位置填写
    </div>
    {% endif %}

    <form method="POST">
        <div class="form-row">
            <div class="form-group">
                <label>店铺名称 *</label>
                <input type="text" name="shop_name" class="form-control" value="{{ shop.shop_name if shop else '' }}" required>
            </div>
            {% if not shop %}
            <div class="form-group">
                <label>店铺代码 * <small class="text-muted">(填写京东店铺ID)</small></label>
                <input type="text" name="shop_code" class="form-control" value="" required placeholder="例如：12919489">
            </div>
            {% endif %}
            <div class="form-group">
                <label>店铺类型 *</label>
                <select name="shop_type" class="form-control">
                    <option value="1" {{ 'selected' if shop and shop.shop_type == 1 }}>游戏点卡</option>
                    <option value="2" {{ 'selected' if shop and shop.shop_type == 2 }}>通用交易</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>状态</label>
                <select name="is_enabled" class="form-control">
                    <option value="1" {{ 'selected' if not shop or shop.is_enabled == 1 }}>启用</option>
                    <option value="0" {{ 'selected' if shop and shop.is_enabled == 0 }}>禁用</option>
                </select>
            </div>
            <div class="form-group">
                <label>到期时间</label>
                <input type="datetime-local" name="expire_time" class="form-control"
                       value="{{ shop.expire_time.strftime('%Y-%m-%dT%H:%M') if shop and shop.expire_time else '' }}">
            </div>
        </div>

        <div class="section-title">🎮 游戏点卡配置 <small class="text-muted">(客户申请下来后填写)</small></div>
        <div class="form-row">
            <div class="form-group">
                <label>商家ID <small class="text-muted">(京东分配)</small></label>
                <input type="text" name="game_customer_id" class="form-control" value="{{ shop.game_customer_id or '' if shop else '' }}" placeholder="例如：13750713">
            </div>
            <div class="form-group">
                <label>MD5密钥 <small class="text-muted">(京东分配)</small></label>
                <input type="text" name="game_md5_secret" class="form-control" value="{{ shop.game_md5_secret or '' if shop else '' }}" placeholder="京东分配的MD5密钥">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>直充回调地址 <small class="text-muted">(京东提供，选填)</small></label>
                <input type="text" name="game_direct_callback_url" class="form-control" value="{{ shop.game_direct_callback_url or 'https://vtpnotify.jd.com/vtp/produce/result' if shop else 'https://vtpnotify.jd.com/vtp/produce/result' }}">
            </div>
            <div class="form-group">
                <label>卡密回调地址 <small class="text-muted">(京东提供，选填)</small></label>
                <input type="text" name="game_card_callback_url" class="form-control" value="{{ shop.game_card_callback_url or 'https://vtpnotify.jd.com/vtp/produce/result' if shop else 'https://vtpnotify.jd.com/vtp/produce/result' }}">
            </div>
        </div>
        <div class="form-group">
            <label>接口地址 <small class="text-muted">(选填)</small></label>
            <input type="text" name="game_api_url" class="form-control" value="{{ shop.game_api_url or 'https://api.jd-game.com/v1' if shop else 'https://api.jd-game.com/v1' }}">
        </div>

        <div class="section-title">🏪 通用交易配置 <small class="text-muted">(客户申请下来后填写)</small></div>
        <div class="form-row">
            <div class="form-group">
                <label>商家ID <small class="text-muted">(京东分配)</small></label>
                <input type="text" name="general_vendor_id" class="form-control" value="{{ shop.general_vendor_id or '' if shop else '' }}" placeholder="例如：13750713">
            </div>
            <div class="form-group">
                <label>MD5密钥 <small class="text-muted">(京东分配)</small></label>
                <input type="text" name="general_md5_secret" class="form-control" value="{{ shop.general_md5_secret or '' if shop else '' }}" placeholder="京东分配的MD5密钥">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>AES密钥 <small class="text-muted">(可选)</small></label>
                <input type="text" name="general_aes_secret" class="form-control" value="{{ shop.general_aes_secret or '' if shop else '' }}" placeholder="如果京东提供则填写">
            </div>
            <div class="form-group">
                <label>回调地址 <small class="text-muted">(京东提供，选填)</small></label>
                <input type="text" name="general_callback_url" class="form-control" value="{{ shop.general_callback_url or 'https://vtpnotify.jd.com/vtp/produce/result' if shop else 'https://vtpnotify.jd.com/vtp/produce/result' }}">
            </div>
        </div>
        <div class="form-group">
            <label>接口地址 <small class="text-muted">(选填)</small></label>
            <input type="text" name="general_api_url" class="form-control" value="{{ shop.general_api_url or 'https://api.jd-general.com/v1' if shop else 'https://api.jd-general.com/v1' }}">
        </div>

        <!-- 91卡券配置 -->
        <div class="section-title">🎫 91卡券 API配置 <small class="text-muted">(每个店铺单独设置)</small></div>
        <div class="alert" style="background:#fff7e6;border:1px solid #ffd591;padding:14px;border-radius:6px;margin-bottom:16px;font-size:13px;line-height:1.8;">
            <b>📋 如何获取91卡券配置：</b><br>
            1. 登录 <a href="https://open.agiso.com/#/my/application/app-list" target="_blank" style="color:#1890ff;">https://open.agiso.com</a> → 「我的应用」<br>
            2. 找到你的应用，复制 <strong>AppId</strong>（即API密钥）和 <strong>AppSecret</strong>（即API签名密钥）<br>
            3. 访问 <a href="https://mai.91kami.com/#/open/authorize" target="_blank" style="color:#1890ff;">https://mai.91kami.com/#/open/authorize</a> 输入AppId授权后获取 AccessToken<br>
            4. 将三个值填入下方对应输入框保存即可
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>AppId（API密钥）<span style="color:red;">*</span></label>
                <input type="text" name="agiso_app_id" class="form-control"
                       value="{{ shop.agiso_app_id or '' if shop else '' }}"
                       placeholder="例如：2023052934478182340">
            </div>
            <div class="form-group">
                <label>AppSecret（API签名密钥）<span style="color:red;">*</span> <small class="text-muted">（不填则保留原有密钥）</small></label>
                <input type="password" name="agiso_app_secret" class="form-control" value=""
                       placeholder="{{ '已配置（如需修改请重新填写）' if shop and shop.agiso_app_secret else '请填写AppSecret' }}">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex:1;">
                <label>AccessToken <span style="color:red;">*</span> <small class="text-muted">（不填则保留原有Token）</small></label>
                <input type="text" name="agiso_access_token" class="form-control" value=""
                       placeholder="{{ '已配置（如需修改请重新填写）' if shop and shop.agiso_access_token else '请填写AccessToken' }}">
            </div>
        </div>
        {% if shop %}
        <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px;">
            <button type="button" class="btn btn-sm btn-info" onclick="testCard91Api({{ shop.id }})">🔍 测试91卡券连接</button>
            <span id="card91-test-result" style="font-weight:bold;font-size:14px;"></span>
        </div>
        {% endif %}
        <input type="hidden" name="card91_api_url" value="https://gw-api.agiso.com">
        <input type="hidden" name="card91_api_key" value="{{ shop.card91_api_key or '' if shop else '' }}">

        <!-- 订单通知配置 -->
        <div class="section-title">📢 订单通知配置</div>
        <div class="form-group">
            <label>启用订单通知</label>
            <select name="notify_enabled" class="form-control" style="width:auto;">
                <option value="0" {{ 'selected' if not shop or shop.notify_enabled == 0 }}>否</option>
                <option value="1" {{ 'selected' if shop and shop.notify_enabled == 1 }}>是</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>钉钉 Webhook 地址</label>
                <input type="text" name="dingtalk_webhook" class="form-control" value="{{ shop.dingtalk_webhook or '' if shop else '' }}" placeholder="https://oapi.dingtalk.com/robot/send?access_token=xxx">
            </div>
            <div class="form-group">
                <label>钉钉加签密钥</label>
                <input type="text" name="dingtalk_secret" class="form-control" value="{{ shop.dingtalk_secret or '' if shop else '' }}">
            </div>
        </div>
        {% if shop %}
        <div class="mb-4">
            <button type="button" class="btn btn-sm" onclick="testNotification({{ shop.id }}, 'dingtalk')">📤 测试钉钉通知</button>
        </div>
        {% endif %}
        <div class="form-group">
            <label>企业微信 Webhook 地址</label>
            <input type="text" name="wecom_webhook" class="form-control" value="{{ shop.wecom_webhook or '' if shop else '' }}" placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx">
        </div>
        {% if shop %}
        <div class="mb-4">
            <button type="button" class="btn btn-sm" onclick="testNotification({{ shop.id }}, 'wecom')">📤 测试企业微信通知</button>
        </div>
        {% endif %}

        <div class="form-group">
            <label>备注</label>
            <textarea name="remark" class="form-control" rows="3">{{ shop.remark or '' if shop else '' }}</textarea>
        </div>

        <div class="flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary">保存</button>
            <a href="{{ url_for('shop.shop_list') }}" class="btn">取消</a>
        </div>
    </form>
</div>

<script>
function testNotification(shopId, type) {
    fetch('/api/shop/test-notification', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({shop_id: shopId, notify_type: type})
    }).then(res => res.json()).then(data => { alert(data.success ? '✅ ' + data.message : '❌ ' + data.message); });
}
function testCard91Api(shopId) {
    const el = document.getElementById('card91-test-result');
    el.textContent = '测试中...'; el.style.color = '#666';
    fetch('/shop/card91-test/' + shopId).then(res => res.json()).then(data => {
        if (data.success) { el.textContent = '✅ ' + (data.message || '连接成功'); el.style.color = '#28a745'; }
        else { el.textContent = '❌ ' + data.message; el.style.color = '#dc3545'; }
    }).catch(() => { el.textContent = '❌ 请求失败，请检查网络'; el.style.color = '#dc3545'; });
}
</script>
{% endblock %}
