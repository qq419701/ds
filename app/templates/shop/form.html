{% extends "layouts/base.html" %}
{% block title %}{{ 'ç¼–è¾‘åº—é“º' if shop else 'æ–°å»ºåº—é“º' }}{% endblock %}

{% block content %}
{% set server_ip = request.host.split(':')[0] %}
{% set base_url = request.scheme + '://' + request.host %}

<div class="card mb-4" style="background: #f0f8ff; border-left: 4px solid #1890ff;">
    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
        <span>ğŸ“‹ æäº¤ç»™äº¬ä¸œå®˜æ–¹çš„å›ºå®šæ¥å£ä¿¡æ¯</span>
        <button type="button" class="btn btn-sm" onclick="copyAllInfo()" style="background: #52c41a; color: white;">ğŸ“‘ ä¸€é”®å¤åˆ¶å…¨éƒ¨</button>
    </div>
    <div class="alert alert-warning mb-3" style="background: #fff7e6; border: 1px solid #ffd591; padding: 10px; border-radius: 4px;">
        <strong>âš ï¸ é‡è¦ï¼š</strong>ä»¥ä¸‹æ˜¯å›ºå®šæ¥å£ä¿¡æ¯ï¼Œæä¾›ç»™æ‰€æœ‰å®¢æˆ·ç”³è¯·äº¬ä¸œæ¥å£æ—¶ä½¿ç”¨ã€‚
    </div>
    <div id="fixedApiInfo">
        <div class="info-row">
            <strong>æœåŠ¡å™¨IPç™½åå•ï¼š</strong>
            <span class="info-value" id="val_ip">{{ server_ip }}</span>
            <button class="btn-copy" onclick="copyById('val_ip')">ğŸ“‹ å¤åˆ¶</button>
        </div>
        <hr style="margin: 15px 0; border-top: 1px solid #d9d9d9;">
        <div class="section-subtitle">ğŸ® æ¸¸æˆç‚¹å¡æ¥å£é…ç½®</div>
        <div class="info-row">
            <strong>2.2.1 ç›´å……æ¥å•æ¥å£ï¼š</strong>
            <span class="info-value" id="val_direct">{{ base_url }}/api/game/direct</span>
            <button class="btn-copy" onclick="copyById('val_direct')">ğŸ“‹ å¤åˆ¶</button>
        </div>
        <div class="info-row">
            <strong>2.2.2 ç›´å……è®¢å•æŸ¥è¯¢ï¼š</strong>
            <span class="info-value" id="val_query">{{ base_url }}/api/game/query</span>
            <button class="btn-copy" onclick="copyById('val_query')">ğŸ“‹ å¤åˆ¶</button>
        </div>
        <div class="info-row">
            <strong>2.3.1 å¡å¯†æ¥å•æ¥å£ï¼š</strong>
            <span class="info-value" id="val_card">{{ base_url }}/api/game/card</span>
            <button class="btn-copy" onclick="copyById('val_card')">ğŸ“‹ å¤åˆ¶</button>
        </div>
        <div class="info-row">
            <strong>2.3.2 å¡å¯†è®¢å•æŸ¥è¯¢ï¼š</strong>
            <span class="info-value" id="val_cardquery">{{ base_url }}/api/game/card-query</span>
            <button class="btn-copy" onclick="copyById('val_cardquery')">ğŸ“‹ å¤åˆ¶</button>
        </div>
        <hr style="margin: 15px 0; border-top: 1px solid #d9d9d9;">
        <div class="section-subtitle">ğŸª é€šç”¨äº¤æ˜“æ¥å£é…ç½®</div>
        <div class="info-row">
            <strong>å……å€¼/æå–å¡å¯†æ¥å£ï¼š</strong>
            <span class="info-value" id="val_distill">{{ base_url }}/api/general/distill</span>
            <button class="btn-copy" onclick="copyById('val_distill')">ğŸ“‹ å¤åˆ¶</button>
        </div>
        <div class="info-row">
            <strong>åæŸ¥è®¢å•æ¥å£ï¼š</strong>
            <span class="info-value" id="val_genquery">{{ base_url }}/api/general/query</span>
            <button class="btn-copy" onclick="copyById('val_genquery')">ğŸ“‹ å¤åˆ¶</button>
        </div>
        <hr style="margin: 15px 0; border-top: 1px solid #d9d9d9;">
        <div class="alert alert-info mb-0" style="background: #e6f7ff; border: 1px solid #91d5ff; padding: 10px; border-radius: 4px;">
            <strong>ğŸ“ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
            â€¢ æ‰€æœ‰å®¢æˆ·ä½¿ç”¨ç›¸åŒçš„å›ºå®šæ¥å£åœ°å€<br>
            â€¢ å®¢æˆ·ç”³è¯·ä¸‹æ¥åï¼Œäº¬ä¸œä¼šåˆ†é…ï¼š<strong>å•†å®¶ID</strong> å’Œ <strong>MD5å¯†é’¥</strong><br>
            â€¢ å®¢æˆ·æ‹¿åˆ°å¯†é’¥åï¼Œåœ¨ä¸‹æ–¹å¯¹åº”ä½ç½®å¡«å†™å³å¯<br>
            â€¢ äº¬ä¸œæ¨é€è®¢å•æ—¶ä¼šæºå¸¦åº—é“ºæ ‡è¯†ï¼ˆshop_code æˆ– shop_idï¼‰ï¼Œç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«
        </div>
    </div>
</div>

<style>
.info-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
.info-row:last-child { border-bottom: none; }
.info-row strong { min-width: 200px; color: #333; font-size: 14px; }
.info-value { flex: 1; color: #1890ff; font-family: 'Courier New', monospace; font-size: 13px; word-break: break-all; }
.btn-copy { margin-left: 10px; padding: 4px 12px; background: #52c41a; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; }
.btn-copy:hover { background: #389e0d; }
.section-subtitle { font-weight: bold; color: #1890ff; margin: 15px 0 10px 0; font-size: 16px; }
</style>

<script>
function copyById(id) {
    var text = document.getElementById(id).textContent.trim();
    copyText(text);
}
function copyText(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function(){ showToast('âœ… å·²å¤åˆ¶ï¼š' + text); }).catch(function(){ fallbackCopy(text); });
    } else { fallbackCopy(text); }
}
function fallbackCopy(text) {
    var textarea = document.createElement('textarea');
    textarea.value = text; textarea.style.position = 'fixed'; textarea.style.opacity = '0';
    document.body.appendChild(textarea); textarea.select();
    try { document.execCommand('copy'); showToast('ï¿½ï¿½ï¿½ å·²å¤åˆ¶'); } catch(e) { showToast('âŒ å¤åˆ¶å¤±è´¥'); }
    document.body.removeChild(textarea);
}
function copyAllInfo() {
    var ids = ['val_ip','val_direct','val_query','val_card','val_cardquery','val_distill','val_genquery'];
    var labels = ['æœåŠ¡å™¨IPç™½åå•','ç›´å……æ¥å•æ¥å£','ç›´å……è®¢å•æŸ¥è¯¢','å¡å¯†æ¥å•æ¥å£','å¡å¯†è®¢å•æŸ¥è¯¢','å……å€¼/æå–å¡å¯†æ¥å£','åæŸ¥è®¢å•æ¥å£'];
    var text = '';
    for(var i=0;i<ids.length;i++){ text += labels[i]+'ï¼š'+document.getElementById(ids[i]).textContent.trim()+'\n'; }
    copyText(text);
}
function showToast(message) {
    var toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;top:80px;right:20px;background:#52c41a;color:white;padding:15px 20px;border-radius:4px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.15);font-size:14px;';
    toast.textContent = message; document.body.appendChild(toast);
    setTimeout(function(){ toast.style.transition='opacity 0.3s'; toast.style.opacity='0'; setTimeout(function(){ toast.remove(); },300); },2500);
}
</script>

<div class="card">
    <div class="card-title">{{ 'âœï¸ ç¼–è¾‘åº—é“ºé…ç½®' if shop else 'ğŸª æ–°å»ºåº—é“º' }}</div>
    {% if shop %}
    <div class="alert alert-info mb-3" style="background: #e6f7ff; border: 1px solid #91d5ff; padding: 10px;">
        <strong>ğŸ’¡ æç¤ºï¼š</strong>å®¢æˆ·ç”³è¯·åˆ°äº¬ä¸œå¯†é’¥åï¼Œè¯·åœ¨ä¸‹æ–¹å¯¹åº”ä½ç½®å¡«å†™
    </div>
    {% endif %}
    <form method="POST">
        <div class="form-row">
            <div class="form-group">
                <label>åº—é“ºåç§° *</label>
                <input type="text" name="shop_name" class="form-control" value="{{ shop.shop_name if shop else '' }}" required>
            </div>
            {% if not shop %}
            <div class="form-group">
                <label>åº—é“ºä»£ç  * <small class="text-muted">(å¡«å†™äº¬ä¸œåº—é“ºID)</small></label>
                <input type="text" name="shop_code" class="form-control" value="" required placeholder="ä¾‹å¦‚ï¼š12919489">
            </div>
            {% endif %}
            <div class="form-group">
                <label>åº—é“ºç±»å‹ *</label>
                <select name="shop_type" class="form-control">
                    <option value="1" {{ 'selected' if shop and shop.shop_type == 1 }}>æ¸¸æˆç‚¹å¡</option>
                    <option value="2" {{ 'selected' if shop and shop.shop_type == 2 }}>é€šç”¨äº¤æ˜“</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>çŠ¶æ€</label>
                <select name="is_enabled" class="form-control">
                    <option value="1" {{ 'selected' if not shop or shop.is_enabled == 1 }}>å¯ç”¨</option>
                    <option value="0" {{ 'selected' if shop and shop.is_enabled == 0 }}>ç¦ç”¨</option>
                </select>
            </div>
            <div class="form-group">
                <label>åˆ°æœŸæ—¶é—´</label>
                <input type="datetime-local" name="expire_time" class="form-control"
                       value="{{ shop.expire_time.strftime('%Y-%m-%dT%H:%M') if shop and shop.expire_time else '' }}">
            </div>
        </div>

        <div class="section-title">ğŸ® æ¸¸æˆç‚¹å¡é…ç½® <small class="text-muted">(å®¢æˆ·ç”³è¯·ä¸‹æ¥åå¡«å†™)</small></div>
        <div class="form-row">
            <div class="form-group">
                <label>å•†å®¶ID <small class="text-muted">(äº¬ä¸œåˆ†é…)</small></label>
                <input type="text" name="game_customer_id" class="form-control" value="{{ shop.game_customer_id or '' if shop else '' }}" placeholder="ä¾‹å¦‚ï¼š13750713">
            </div>
            <div class="form-group">
                <label>MD5å¯†é’¥ <small class="text-muted">(äº¬ä¸œåˆ†é…)</small></label>
                <input type="text" name="game_md5_secret" class="form-control" value="{{ shop.game_md5_secret or '' if shop else '' }}" placeholder="äº¬ä¸œåˆ†é…çš„MD5å¯†é’¥">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>ç›´å……å›è°ƒåœ°å€ <small class="text-muted">(äº¬ä¸œæä¾›ï¼Œé€‰å¡«)</small></label>
                <input type="text" name="game_direct_callback_url" class="form-control" value="{{ shop.game_direct_callback_url or 'https://vtpnotify.jd.com/vtp/produce/result' if shop else 'https://vtpnotify.jd.com/vtp/produce/result' }}">
            </div>
            <div class="form-group">
                <label>å¡å¯†å›è°ƒåœ°å€ <small class="text-muted">(äº¬ä¸œæä¾›ï¼Œé€‰å¡«)</small></label>
                <input type="text" name="game_card_callback_url" class="form-control" value="{{ shop.game_card_callback_url or 'https://vtpnotify.jd.com/vtp/produce/result' if shop else 'https://vtpnotify.jd.com/vtp/produce/result' }}">
            </div>
        </div>
        <div class="form-group">
            <label>æ¥å£åœ°å€ <small class="text-muted">(é€‰å¡«)</small></label>
            <input type="text" name="game_api_url" class="form-control" value="{{ shop.game_api_url or 'https://api.jd-game.com/v1' if shop else 'https://api.jd-game.com/v1' }}">
        </div>

        <div class="section-title">ğŸª é€šç”¨äº¤æ˜“é…ç½® <small class="text-muted">(å®¢æˆ·ç”³è¯·ä¸‹æ¥åå¡«å†™)</small></div>
        <div class="form-row">
            <div class="form-group">
                <label>å•†å®¶ID <small class="text-muted">(äº¬ä¸œåˆ†é…)</small></label>
                <input type="text" name="general_vendor_id" class="form-control" value="{{ shop.general_vendor_id or '' if shop else '' }}" placeholder="ä¾‹å¦‚ï¼š13750713">
            </div>
            <div class="form-group">
                <label>MD5å¯†é’¥ <small class="text-muted">(äº¬ä¸œåˆ†é…)</small></label>
                <input type="text" name="general_md5_secret" class="form-control" value="{{ shop.general_md5_secret or '' if shop else '' }}" placeholder="äº¬ä¸œåˆ†é…çš„MD5å¯†é’¥">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>AESå¯†é’¥ <small class="text-muted">(å¯é€‰)</small></label>
                <input type="text" name="general_aes_secret" class="form-control" value="{{ shop.general_aes_secret or '' if shop else '' }}" placeholder="å¦‚æœäº¬ä¸œæä¾›åˆ™å¡«å†™">
            </div>
            <div class="form-group">
                <label>å›è°ƒåœ°å€ <small class="text-muted">(äº¬ä¸œæä¾›ï¼Œé€‰å¡«)</small></label>
                <input type="text" name="general_callback_url" class="form-control" value="{{ shop.general_callback_url or 'https://vtpnotify.jd.com/vtp/produce/result' if shop else 'https://vtpnotify.jd.com/vtp/produce/result' }}">
            </div>
        </div>
        <div class="form-group">
            <label>æ¥å£åœ°å€ <small class="text-muted">(é€‰å¡«)</small></label>
            <input type="text" name="general_api_url" class="form-control" value="{{ shop.general_api_url or 'https://api.jd-general.com/v1' if shop else 'https://api.jd-general.com/v1' }}">
        </div>

        <div class="section-title">ğŸ« 91å¡åˆ¸ APIé…ç½® <small class="text-muted">(æ¯ä¸ªåº—é“ºå•ç‹¬è®¾ç½®)</small></div>
        <div class="alert" style="background:#fff7e6;border:1px solid #ffd591;padding:14px;border-radius:6px;margin-bottom:16px;font-size:13px;line-height:1.8;">
            <b>ğŸ“‹ å¦‚ä½•è·å–91å¡åˆ¸é…ç½®ï¼š</b><br>
            1. ç™»å½• <a href="https://open.agiso.com/#/my/application/app-list" target="_blank" style="color:#1890ff;">https://open.agiso.com</a> â†’ ã€Œæˆ‘çš„åº”ç”¨ã€<br>
            2. å¤åˆ¶ <strong>AppId</strong> å’Œ <strong>AppSecret</strong><br>
            3. è®¿é—® <a href="https://mai.91kami.com/#/open/authorize" target="_blank" style="color:#1890ff;">https://mai.91kami.com/#/open/authorize</a> è¾“å…¥AppIdæˆæƒåè·å– AccessToken<br>
            4. å°†ä¸‰ä¸ªå€¼å¡«å…¥ä¸‹æ–¹ä¿å­˜å³å¯
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>AppIdï¼ˆAPIå¯†é’¥ï¼‰<span style="color:red;">*</span></label>
                <input type="text" name="agiso_app_id" class="form-control"
                       value="{{ shop.agiso_app_id or '' if shop else '' }}"
                       placeholder="ä¾‹å¦‚ï¼š2023052934478182340">
            </div>
            <div class="form-group">
                <label>AppSecret <span style="color:red;">*</span> <small class="text-muted">ï¼ˆä¸å¡«åˆ™ä¿ç•™åŸæœ‰å¯†é’¥ï¼‰</small></label>
                <input type="password" name="agiso_app_secret" class="form-control" value=""
                       placeholder="{{ 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°å¡«å†™ï¼‰' if shop and shop.agiso_app_secret else 'è¯·å¡«å†™AppSecret' }}">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex:1;">
                <label>AccessToken <span style="color:red;">*</span> <small class="text-muted">ï¼ˆä¸å¡«åˆ™ä¿ç•™åŸæœ‰Tokenï¼‰</small></label>
                <input type="text" name="agiso_access_token" class="form-control" value=""
                       placeholder="{{ 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°å¡«å†™ï¼‰' if shop and shop.agiso_access_token else 'è¯·å¡«å†™AccessToken' }}">
            </div>
        </div>
        {% if shop %}
        <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px;">
            <button type="button" class="btn btn-sm btn-info" onclick="testCard91Api({{ shop.id }})">ğŸ” æµ‹è¯•91å¡åˆ¸è¿æ¥</button>
            <span id="card91-test-result" style="font-weight:bold;font-size:14px;"></span>
        </div>
        {% endif %}
        <input type="hidden" name="card91_api_url" value="https://gw-api.agiso.com">
        <input type="hidden" name="card91_api_key" value="{{ shop.card91_api_key or '' if shop else '' }}">

        <div class="section-title">ğŸ“¢ è®¢å•é€šçŸ¥é…ç½®</div>
        <div class="form-group">
            <label>å¯ç”¨è®¢å•é€šçŸ¥</label>
            <select name="notify_enabled" class="form-control" style="width:auto;">
                <option value="0" {{ 'selected' if not shop or shop.notify_enabled == 0 }}>å¦</option>
                <option value="1" {{ 'selected' if shop and shop.notify_enabled == 1 }}>æ˜¯</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>é’‰é’‰ Webhook åœ°å€</label>
                <input type="text" name="dingtalk_webhook" class="form-control" value="{{ shop.dingtalk_webhook or '' if shop else '' }}" placeholder="https://oapi.dingtalk.com/robot/send?access_token=xxx">
            </div>
            <div class="form-group">
                <label>é’‰é’‰åŠ ç­¾å¯†é’¥</label>
                <input type="text" name="dingtalk_secret" class="form-control" value="{{ shop.dingtalk_secret or '' if shop else '' }}">
            </div>
        </div>
        {% if shop %}
        <div class="mb-4">
            <button type="button" class="btn btn-sm" onclick="testNotification({{ shop.id }}, 'dingtalk')">ğŸ“¤ æµ‹è¯•é’‰é’‰é€šçŸ¥</button>
        </div>
        {% endif %}
        <div class="form-group">
            <label>ä¼ä¸šå¾®ä¿¡ Webhook åœ°å€</label>
            <input type="text" name="wecom_webhook" class="form-control" value="{{ shop.wecom_webhook or '' if shop else '' }}" placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx">
        </div>
        {% if shop %}
        <div class="mb-4">
            <button type="button" class="btn btn-sm" onclick="testNotification({{ shop.id }}, 'wecom')">ğŸ“¤ æµ‹è¯•ä¼ä¸šå¾®ä¿¡é€šçŸ¥</button>
        </div>
        {% endif %}

        <div class="form-group">
            <label>å¤‡æ³¨</label>
            <textarea name="remark" class="form-control" rows="3">{{ shop.remark or '' if shop else '' }}</textarea>
        </div>
        <div class="flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            <a href="{{ url_for('shop.shop_list') }}" class="btn">å–æ¶ˆ</a>
        </div>
    </form>
</div>

<script>
function testNotification(shopId, type) {
    fetch('/api/shop/test-notification', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({shop_id: shopId, notify_type: type})
    }).then(function(r){ return r.json(); }).then(function(data){ alert(data.success ? 'âœ… ' + data.message : 'âŒ ' + data.message); });
}
function testCard91Api(shopId) {
    var el = document.getElementById('card91-test-result');
    el.textContent = 'æµ‹è¯•ä¸­...'; el.style.color = '#666';
    fetch('/shop/card91-test/' + shopId).then(function(r){ return r.json(); }).then(function(data){
        if (data.success) { el.textContent = 'âœ… ' + (data.message || 'è¿æ¥æˆåŠŸ'); el.style.color = '#28a745'; }
        else { el.textContent = 'âŒ ' + data.message; el.style.color = '#dc3545'; }
    }).catch(function(){ el.textContent = 'âŒ è¯·æ±‚å¤±è´¥'; el.style.color = '#dc3545'; });
}
</script>
{% endblock %}
