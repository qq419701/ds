{% extends "layouts/base.html" %}
{% block title %}ç»Ÿè®¡æŠ¥è¡¨{% endblock %}

{% block extra_css %}
<style>
.charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
.chart-card { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
.chart-title { font-size: 15px; font-weight: bold; margin-bottom: 12px; }
.chart-box { width: 100%; height: 300px; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-title">ğŸ“Š ç»Ÿè®¡æŠ¥è¡¨</div>

    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-value">{{ total_orders }}</div>
            <div class="stat-label">æ€»è®¢å•æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">Â¥{{ '%.2f' % total_amount }}</div>
            <div class="stat-label">æ€»é‡‘é¢</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ completed_orders }}</div>
            <div class="stat-label">å·²å®Œæˆ</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ pending_orders }}</div>
            <div class="stat-label">å¾…å¤„ç†</div>
        </div>
    </div>
</div>

<!-- ECharts å›¾è¡¨ -->
<div class="charts-row">
    <div class="chart-card">
        <div class="chart-title">ğŸ“ˆ è¿‘7å¤©è®¢å•è¶‹åŠ¿</div>
        <div id="trendChart" class="chart-box"></div>
    </div>
    <div class="chart-card">
        <div class="chart-title">ğŸ’° è¿‘7å¤©é‡‘é¢è¶‹åŠ¿</div>
        <div id="amountChart" class="chart-box"></div>
    </div>
    <div class="chart-card">
        <div class="chart-title">ğŸª åº—é“ºè®¢å•åˆ†å¸ƒ</div>
        <div id="shopPieChart" class="chart-box"></div>
    </div>
    <div class="chart-card">
        <div class="chart-title">ğŸ“‹ è®¢å•çŠ¶æ€åˆ†å¸ƒ</div>
        <div id="statusPieChart" class="chart-box"></div>
    </div>
</div>

<div class="card">
    <div class="card-title">ğŸª åº—é“ºç»Ÿè®¡</div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>åº—é“ºåç§°</th>
                    <th>è®¢å•æ•°</th>
                    <th>æ€»é‡‘é¢</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in shop_stats %}
                <tr>
                    <td>{{ stat.shop_name }}</td>
                    <td>{{ stat.order_count }}</td>
                    <td>Â¥{{ '%.2f' % (stat.total_amount / 100) }}</td>
                </tr>
                {% endfor %}
                {% if not shop_stats %}
                <tr><td colspan="3" class="text-center">æš‚æ— æ•°æ®</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
var dailyStats = {{ daily_stats | tojson }};
var shopPie = {{ shop_pie | tojson }};
var statusDist = {{ status_distribution | tojson }};

// è¿‘7å¤©è®¢å•è¶‹åŠ¿æŠ˜çº¿å›¾
var trendChart = echarts.init(document.getElementById('trendChart'));
trendChart.setOption({
    tooltip: { trigger: 'axis' },
    legend: { data: ['è®¢å•æ•°'] },
    xAxis: { type: 'category', data: dailyStats.map(function(d) { return d.date; }) },
    yAxis: { type: 'value', name: 'è®¢å•æ•°' },
    series: [{
        name: 'è®¢å•æ•°',
        type: 'line',
        smooth: true,
        data: dailyStats.map(function(d) { return d.count; }),
        itemStyle: { color: '#1890ff' },
        areaStyle: { color: 'rgba(24,144,255,0.1)' }
    }]
});

// è¿‘7å¤©é‡‘é¢è¶‹åŠ¿æŸ±çŠ¶å›¾
var amountChart = echarts.init(document.getElementById('amountChart'));
amountChart.setOption({
    tooltip: { trigger: 'axis' },
    xAxis: { type: 'category', data: dailyStats.map(function(d) { return d.date; }) },
    yAxis: { type: 'value', name: 'é‡‘é¢(å…ƒ)' },
    series: [{
        type: 'bar',
        data: dailyStats.map(function(d) { return d.amount; }),
        itemStyle: { color: '#52c41a' }
    }]
});

// åº—é“ºè®¢å•åˆ†å¸ƒé¥¼å›¾
var shopPieChart = echarts.init(document.getElementById('shopPieChart'));
shopPieChart.setOption({
    tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
    legend: { orient: 'vertical', right: 10, top: 'center' },
    series: [{
        type: 'pie',
        radius: ['40%', '70%'],
        data: shopPie,
        label: { formatter: '{b}\n{d}%' }
    }]
});

// è®¢å•çŠ¶æ€åˆ†å¸ƒé¥¼å›¾
var statusPieChart = echarts.init(document.getElementById('statusPieChart'));
statusPieChart.setOption({
    tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
    legend: { orient: 'vertical', right: 10, top: 'center' },
    series: [{
        type: 'pie',
        radius: '70%',
        data: statusDist,
        label: { formatter: '{b}\n{d}%' }
    }]
});

// å“åº”å¼resize
window.addEventListener('resize', function() {
    trendChart.resize();
    amountChart.resize();
    shopPieChart.resize();
    statusPieChart.resize();
});
</script>
{% endblock %}

